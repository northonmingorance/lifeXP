<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life XP</title>
    <style>
        body {
            font-family: "Tahoma", "Geneva", sans-serif;
            font-size: 11px;
            background-color: #3A6EA5;
            background-image: url('https://archive.org/download/bliss-600dpi/bliss-600dpi.png');
            background-size: cover;
            background-position: 0% 0%;
            background-repeat: no-repeat;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        .xp-window {
            background-color: #ECE9D8;
            border: 1px solid #000;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.3);
            min-height: 30px;
            display: flex;
            flex-direction: column;
            position: absolute;
            overflow: hidden;
        }

        .xp-window.disable-selection,
        .xp-window.disable-selection * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .title-bar {
            background: linear-gradient(to bottom, #005CFE, #0039A9);
            color: white;
            padding: 5px 8px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #000;
            cursor: grab;
            height: 28px;
            box-sizing: border-box;
            flex-shrink: 0;
            user-select: none;
        }
        .title-bar:active {
            cursor: grabbing;
        }

        .title-bar-text {
            margin-left: 5px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .title-bar-controls button {
            background-color: #ECE9D8;
            border: 1px solid #000;
            width: 22px;
            height: 18px;
            font-family: "Marlett", "Webdings", sans-serif;
            font-size: 12px;
            line-height: 16px;
            margin-left: 2px;
            box-shadow: 1px 1px 0px #FFF inset, -1px -1px 0px #808080 inset;
            padding: 0;
            text-align: center;
            cursor: default;
        }
        .title-bar-controls button:active:not(:disabled) {
            box-shadow: -1px -1px 0px #FFF inset, 1px 1px 0px #808080 inset;
        }
        .title-bar-controls button:disabled {
            color: #7F7F7F;
            cursor: default;
            opacity: 0.7;
        }

        .window-body {
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
            opacity: 1;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out, opacity 0.2s ease-out;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
        }

        #xpMainWindow .window-body {
             padding: 15px;
             overflow-y: auto;
        }

        #playJockeyWindow .window-body {
            padding: 0;
            display: flex;
        }


        .xp-window.minimized .window-body {
            max-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            opacity: 0 !important;
            overflow: hidden !important;
            border-top: none !important;
        }
        .xp-window.minimized {
            min-height: 28px !important;
            height: 28px !important;
            overflow: hidden;
        }

        .controls-bar {
            display: flex;
            margin-bottom: 15px;
            padding: 8px;
            border: 1px solid #ACA899;
            background-color: #F0F0F0;
        }

        .controls-bar.layout-single-row {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
        }
        .controls-bar.layout-single-row > div {
             margin: 2px 5px;
             flex-shrink: 0;
        }

        .controls-bar.layout-multi-row {
            flex-direction: column;
            align-items: stretch;
        }
        .controls-bar.layout-multi-row > div {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding: 5px 0;
        }
        .controls-bar.layout-multi-row > div:last-child {
            margin-bottom: 0;
        }
        .controls-bar.layout-multi-row .controls-group {
             text-align: center;
        }

        .xp-button {
            background-color: #ECE9D8;
            border: 1px outset #7F7F7F;
            padding: 5px 12px;
            min-width: 75px;
            text-align: center;
            cursor: pointer;
            margin: 2px;
        }
        .xp-button:active {
            border-style: inset;
        }
        .xp-button:hover {
            border-color: #005CFE;
        }
        .xp-button-small {
            padding: 2px 5px;
            font-size: 10px;
            min-width: auto;
            margin: 0 2px;
        }


        .week-navigation {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        .week-navigation button {
            margin: 0 3px;
        }

        .controls-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            text-align: center;
        }
        #currentWeekDisplay {
            font-weight: bold;
        }
        #weekCountDisplay {
            font-size: 0.9em;
            color: #333;
        }

        .global-actions {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #ACA899;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word;
        }

        th {
            background-color: #D4D0C8;
            text-align: center;
        }

        td.area-name-cell {
            font-weight: bold;
            width: 180px;
        }
        .area-stats {
            font-size: 0.9em;
            margin-top: 5px;
            color: #333;
        }
        .area-stats span { display: flex; }
        .xp-bar-container {
            width: 100%;
            height: 12px;
            background-color: #BDBDBD;
            border: 1px solid #7F7F7F;
            margin-top: 3px;
            position: relative;
            border-radius: 2px;
            overflow: hidden;
        }
        .xp-bar {
            height: 100%;
            background-color: #008000;
            transition: width 0.3s ease;
            border-radius: 1px;
        }
        .xp-bar-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            line-height: 12px;
            color: white;
            text-shadow: 1px 1px 0px black;
            font-weight: bold;
            z-index: 1;
        }

        .achievement-item {
            background-color: #FFF;
            border: 1px solid #DDD;
            padding: 4px;
            margin-bottom: 4px;
            font-size: 0.9em;
            border-radius: 3px;
            word-wrap: break-word;
            box-sizing: border-box;
            position: relative;
            padding-bottom: 22px;
        }
        .achievement-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin-top: 0px;
            border-radius: 2px;
        }
        .achievement-item-actions {
            position: absolute;
            bottom: 3px;
            right: 3px;
            display: flex;
            gap: 3px;
        }
        .achievement-add-btn-cell {
            display: block;
            width: 99.5%;
            box-sizing: border-box;
            margin-top: 5px;
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #ECE9D8;
            margin: auto;
            padding: 0;
            border: 1px solid #000;
            width: 80%;
            max-width: 500px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
            display: flex;
            flex-direction: column;
        }

        .modal-title-bar {
            background: linear-gradient(to bottom, #005CFE, #0039A9);
            color: white;
            padding: 5px 8px;
            font-weight: bold;
            border-bottom: 1px solid #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 28px;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        .modal-title-bar .close-button {
            color: white;
            font-size: 16px;
            font-family: "Marlett", "Webdings", sans-serif;
            font-weight: normal;
            background: #E04343;
            border: 1px outset white;
            width: 22px;
            height: 18px;
            text-align: center;
            line-height: 16px;
            padding: 0;
            cursor: pointer;
        }
        .modal-title-bar .close-button:hover,
        .modal-title-bar .close-button:focus {
            background: #FF6363;
            text-decoration: none;
        }
         .modal-title-bar .close-button:active {
            border-style: inset;
        }
        .modal-body {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .modal-body p {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .modal-body label {
            display: block;
            margin-bottom: 5px;
            margin-top: 12px;
        }
        .modal-body input[type="text"],
        .modal-body input[type="number"],
        .modal-body textarea,
        .modal-body select {
            width: calc(100% - 12px);
            padding: 5px;
            margin-bottom: 10px;
            border: 1px solid #ACA899;
            box-sizing: border-box;
        }
        .modal-body input[type="file"] {
            margin-bottom: 5px;
        }
         .modal-body hr {
            border: 0;
            height: 1px;
            background: #ACA899;
            margin: 20px 0;
        }
        .modal-footer {
            padding: 10px 15px;
            text-align: right;
            background-color: #F0F0F0;
            border-top: 1px solid #ACA899;
            flex-shrink: 0;
        }

        @keyframes fadeIn {
            from {opacity: 0; transform: scale(0.9);}
            to {opacity: 1; transform: scale(1);}
        }

        .quest-item {
            padding: 8px;
            border: 1px solid #ACA899;
            margin-bottom: 8px;
            background-color: #FFF;
            border-radius: 3px;
            position: relative;
        }
        .quest-item label {
            margin-left: 8px;
        }
        .quest-item.completed {
            background-color: #DFF0D8;
            text-decoration: line-through;
            color: #508a50;
        }
        .quest-item.completed .quest-title {
             color: #006400;
        }
        .quest-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #0039A9;
        }
        .quest-details {
            font-size: 0.95em;
            margin-bottom: 3px;
        }
        .quest-progress {
            font-size: 0.85em;
            color: #555;
            margin-top: 3px;
            margin-bottom: 25px;
        }
        .quest-actions {
            position: absolute;
            bottom: 5px;
            right: 5px;
        }


        .area-name-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .delete-area-btn {
            padding: 1px 6px;
            min-width: auto;
            font-size: 10px;
            font-family: "Tahoma", "Geneva", sans-serif;
            font-weight: bold;
            margin-left: 10px;
            background-color: #E04343;
            color: white;
            border: 1px outset white;
            line-height: 1.2;
            cursor: pointer;
        }
        .delete-area-btn:hover {
            background-color: #FF6363;
        }
        .delete-area-btn:active {
            border-style: inset;
        }

        .resize-handle {
            width: 12px;
            height: 12px;
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
            z-index: 10;
            box-sizing: border-box;
            opacity: 0.6;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10L10 7' stroke='%23666' stroke-width='1.2' stroke-linecap='round'/%3E%3Cpath d='M3 10L10 3' stroke='%23666' stroke-width='1.2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center center;
        }

        .resize-handle:hover {
            opacity: 1;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10L10 7' stroke='%23333' stroke-width='1.2' stroke-linecap='round'/%3E%3Cpath d='M3 10L10 3' stroke='%23333' stroke-width='1.2' stroke-linecap='round'/%3E%3C/svg%3E");
        }

        .xp-window.true-maximized .resize-handle {
            display: none;
        }

        .color-swatch-item {
            box-sizing: border-box;
            transition: transform 0.1s ease-out;
        }
        .color-swatch-item:hover {
            outline: 2px solid #005CFE;
            outline-offset: 1px;
            transform: scale(1.1);
        }

        .desktop-icon {
            position: absolute;
            width: 90px;
            height: 100px;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 1px black;
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify: flex-start;
            padding-top: 10px;
            box-sizing: border-box;
            z-index: 5;
        }
        .desktop-icon:active {
            cursor: grabbing;
        }
        .desktop-icon .icon-image {
            font-size: 48px;
            line-height: 1;
            margin-bottom: 8px;
        }
        .desktop-icon .icon-label {
            font-size: 12px;
            font-weight: normal;
            word-wrap: break-word;
            max-width: 100%;
        }

        /* PlayJockey Specific Styles */
        .playjockey-body-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            background-color: #D4D0C8;
            padding: 5px;
            box-sizing: border-box;
        }

        .playjockey-input-bar {
            display: flex;
            margin-bottom: 5px;
            padding: 5px;
            background-color: #C0C0C0;
            border: 1px outset #FFFFFF;
            border-right-color: #808080;
            border-bottom-color: #808080;
            flex-shrink: 0;
        }

        #playJockeyLinkInput {
            flex-grow: 1;
            margin-right: 5px;
            border: 1px inset #7F7F7F;
            padding: 4px;
            font-family: "Tahoma", "Geneva", sans-serif;
            font-size: 11px;
            background-color: #FFFFFF;
        }

        #playJockeyAddBtn {
            min-width: 60px;
            padding: 3px 8px;
            font-size: 11px;
        }

        .playjockey-player-area {
            flex-grow: 1;
            margin-bottom: 5px;
            border: 2px inset #808080;
            background-color: black;
            min-height: 150px;
            overflow: hidden;
        }

        #playJockeyPlayer {
            width: 100%;
            height: 100%;
        }

        .playjockey-tabs-bar {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            background-color: #C0C0C0;
            padding: 3px 3px 0 3px;
            border-bottom: 1px solid #808080;
            flex-shrink: 0;
            gap: 2px;
        }
        .playjockey-tab {
            padding: 6px 10px;
            border: 1px inset #FFFFFF;
            border-bottom: none;
            background-color: #D4D0C8;
            cursor: default;
            font-size: 10px;
            white-space: nowrap;
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
        }
        .playjockey-tab:hover {
            background-color: #E0E0E0;
        }
        .playjockey-tab.active {
            background-color: #F0F0F0;
            border-style: inset;
            border-bottom: 1px solid #F0F0F0;
            position: relative;
            z-index: 1;
            font-weight: bold;
        }
        .playjockey-add-tab-btn {
            padding: 6px 8px;
            margin-left: 0px;
            font-weight: bold;
        }


        .playjockey-controls-bar {
            display: flex;
            justify-content: center;
            padding: 5px 0px 5px 0px;
            flex-shrink: 0;
            gap: 5px;
            border-top: 1px solid #ACA899;
            background-color: #F0F0F0;
        }
        #playJockeyRandomBtn,
        #playJockeyAutoPlayBtn,
        #playJockeyRepeatBtn {
            min-width: 90px;
            padding: 3px 8px;
            font-size: 11px;
        }
        #playJockeyRandomBtn.random-on,
        #playJockeyAutoPlayBtn.autoplay-on,
        #playJockeyRepeatBtn.repeat-on {
            border-style: inset;
            font-weight: bold;
        }


        .playjockey-playlist-area {
            height: 100px;
            overflow-y: auto;
            border: 1px inset #7F7F7F;
            background-color: #FFFFFF;
            padding: 3px;
            flex-shrink: 0;
            border-top: none;
            position: relative;
            z-index: 0;
        }

        .playjockey-playlist-item {
            padding: 4px 6px;
            cursor: grab;
            border-bottom: 1px solid #ECE9D8;
            font-size: 10px;
            color: #000080;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            user-select: none;
        }
        .playjockey-playlist-item:hover {
            background-color: #000080;
            color: white;
        }
        .playjockey-playlist-item.playing {
            background-color: #005CFE;
            color: white;
            font-weight: bold;
        }
        .playjockey-playlist-item:last-child {
            border-bottom: none;
        }

        .playjockey-playlist-item.dragging {
            opacity: 0.5;
            background-color: #AED6F1;
        }
        .playjockey-playlist-item.drag-over-target-before {
            border-top: 2px dashed #005CFE;
        }
        .playjockey-playlist-item.drag-over-target-after {
            border-bottom: 2px dashed #005CFE;
        }


        .context-modal {
            display: none;
            position: fixed;
            background-color: #ECE9D8;
            border: 1px solid #000;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 2000;
            padding: 3px 0;
            min-width: 120px;
            font-family: "Tahoma", "Geneva", sans-serif;
            font-size: 11px;
        }
        .context-modal-item {
            padding: 5px 12px;
            cursor: default;
            color: black;
        }
        .context-modal-item:hover {
            background-color: #005CFE;
            color: white;
        }

        /* Youtube Modal Specific Styles */
        #youtubeSearchResultsBody {
            max-height: 400px;
            overflow-y: auto;
        }

        .Youtube-result-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #ACA899;
            cursor: pointer;
            background-color: #FFFFFF;
        }
        .Youtube-result-item:hover {
            background-color: #E0E0E0;
        }
        .Youtube-result-item:last-child {
            border-bottom: none;
        }

        .Youtube-result-item img {
            width: 120px;
            height: 90px;
            margin-right: 10px;
            border: 1px solid #ACA899;
            object-fit: cover;
        }

        .Youtube-result-item-details {
            display: flex;
            flex-direction: column;
        }

        .Youtube-result-item-title {
            font-weight: bold;
            color: #0039A9;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .Youtube-result-item-channel {
            font-size: 10px;
            color: #555;
        }
        #youtubeSearchStatus {
            padding: 15px;
            font-size: 12px;
        }

        /* Gemini Chat Specific Styles */
        .gemini-chat-body-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            background-color: #ECE9D8;
            padding: 0; 
            box-sizing: border-box;
        }

        .gemini-chat-controls-bar {
            display: flex;
            justify-content: flex-end; 
            padding: 3px 5px 0px 5px;
            background-color: #ECE9D8;
            border-bottom: 1px solid #ACA899;
            flex-shrink: 0;
        }

        #geminiChatClearHistoryBtn {
            min-width: auto; 
            padding: 2px 8px; 
            margin-bottom: 3px; 
        }

        .gemini-chat-display-area {
            flex-grow: 1;
            border: 1px inset #7F7F7F;
            background-color: #FFFFFF; 
            padding: 8px;
            margin: 5px; 
            margin-top: 0; /* Adjusted */
            overflow-y: auto; 
            font-family: "Tahoma", "Geneva", sans-serif;
            font-size: 11px;
            line-height: 1.4;
        }

        .gemini-chat-message {
            margin-bottom: 8px;
            padding: 6px 8px;
            border-radius: 3px;
            word-wrap: break-word; 
            white-space: pre-wrap; 
            max-width: 80%; 
            box-sizing: border-box;
        }

        .gemini-chat-message .message-sender {
            font-weight: bold;
            display: block;
            margin-bottom: 3px;
            font-size: 10px;
        }
        .gemini-chat-message .message-content {
           /* Individual content styling if needed */
        }
         .gemini-chat-message .message-timestamp {
            font-size: 9px;
            color: #555;
            display: block;
            margin-top: 4px;
            text-align: inherit; 
        }


        .gemini-chat-message.user-message {
            background-color: #E1EBF7; 
            text-align: left; 
            margin-left: auto; 
            border: 1px solid #B4C9E2;
        }
        .gemini-chat-message.user-message .message-sender {
            color: #0039A9; 
        }

        .gemini-chat-message.gemini-message {
            background-color: #F0F0F0; 
            text-align: left;
            margin-right: auto; 
            border: 1px solid #DCDCDC;
        }
        .gemini-chat-message.gemini-message .message-sender {
            color: #006400; 
        }
        .gemini-chat-message.gemini-message.error-message {
            background-color: #FFDDDD; 
            color: #D8000C;
            border: 1px solid #FFB8B8;
        }
        .gemini-chat-message.gemini-message.error-message .message-sender {
            color: #990000;
        }


        .gemini-chat-input-area {
            display: flex;
            flex-shrink: 0; 
            padding: 8px 5px 5px 5px; 
            border-top: 1px solid #ACA899;
            background-color: #ECE9D8; 
        }

        #geminiChatPromptInput {
            flex-grow: 1;
            margin-right: 5px;
            border: 1px inset #7F7F7F;
            padding: 6px;
            font-family: "Tahoma", "Geneva", sans-serif;
            font-size: 11px;
            background-color: #FFFFFF;
            resize: none; 
            height: 44px; 
            box-sizing: border-box;
        }

        #geminiChatSendBtn {
            min-width: 60px;
            padding: 3px 8px;
            font-size: 11px;
            height: 44px; 
            box-sizing: border-box;
        }

    </style>
</head>
<body>

    <div class="desktop-icon" id="textEditorIcon" data-window-id="textEditorWindow">
        <div class="icon-image">üìÑ</div>
        <div class="icon-label">Jotter</div>
    </div>
    <div class="desktop-icon" id="trackerIcon" data-window-id="xpMainWindow">
        <div class="icon-image">üìÖ</div>
        <div class="icon-label">Habit Tracker</div>
    </div>
    <div class="desktop-icon" id="playJockeyIcon" data-window-id="playJockeyWindow">
        <div class="icon-image">‚ñ∂Ô∏è</div>
        <div class="icon-label">PlayJockey</div>
    </div>
    <div class="desktop-icon" id="geminiChatIcon" data-window-id="geminiChatWindow">
        <div class="icon-image">‚ú®</div>
        <div class="icon-label">Gemini Chat</div>
    </div>

    <div class="xp-window" id="xpMainWindow">
        <div class="title-bar" id="xpMainWindowTitleBar">
            <span class="title-bar-text">Habit Tracker</span>
            <div class="title-bar-controls">
                <button id="xpMainWindowMinimizeBtn" title="Minimize">0</button>
                <button id="xpMainWindowMaximizeBtn" title="Maximize">1</button>
                <button title="Close" id="xpMainWindowCloseBtn">r</button>
            </div>
        </div>
        <div class="window-body">
            <div class="controls-bar" id="controlsBar">
                <div class="week-navigation">
                    <button id="prevWeekBtn" class="xp-button">< Prev Week</button>
                    <button id="thisWeekBtn" class="xp-button">This Week</button>
                    <button id="nextWeekBtn" class="xp-button">Next Week ></button>
                </div>
                <div class="controls-group">
                    <span id="currentWeekDisplay">Week X</span>
                    <span id="weekCountDisplay">Year Week: XX</span>
                </div>
                <div class="global-actions">
                    <button id="toggleViewBtn" class="xp-button">Day View</button>
                    <button id="showQuestsBtn" class="xp-button">Weekly Quests</button>
                    <button id="addAreaBtn" class="xp-button">New Area</button>
                </div>
            </div>
            <table id="gridTable">
                <thead>
                    <tr id="weekdayHeaders">
                        <th>Area</th>
                    </tr>
                </thead>
                <tbody id="gridBody">
                </tbody>
            </table>
        </div>
        <div class="resize-handle" id="xpMainWindowResizeHandle"></div>
    </div>

    <div class="xp-window" id="textEditorWindow">
        <div class="title-bar" id="textEditorWindowTitleBar">
            <span class="title-bar-text">Jotter</span>
            <div class="title-bar-controls">
                <button id="textEditorMinimizeBtn" title="Minimize">0</button>
                <button id="textEditorMaximizeBtn" title="Maximize">1</button>
                <button title="Close" id="textEditorCloseBtn">r</button>
            </div>
        </div>
        <div class="window-body" id="textEditorWindowBody">
            <iframe id="textEditorFrame" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
        <div class="resize-handle" id="textEditorResizeHandle"></div>
    </div>

    <div class="xp-window" id="playJockeyWindow">
        <div class="title-bar" id="playJockeyTitleBar">
            <span class="title-bar-text">PlayJockey</span>
            <div class="title-bar-controls">
                <button id="playJockeyMinimizeBtn" title="Minimize">0</button>
                <button id="playJockeyMaximizeBtn" title="Maximize">1</button>
                <button title="Close" id="playJockeyCloseBtn">r</button>
            </div>
        </div>
        <div class="window-body" id="playJockeyWindowBody">
            <div class="playjockey-body-container">
                <div class="playjockey-input-bar">
                    <input type="text" id="playJockeyLinkInput" placeholder="Paste YouTube Link or Search Query">
                    <button id="playJockeyAddBtn" class="xp-button">Add</button>
                </div>
                <div class="playjockey-player-area">
                    <div id="playJockeyPlayer"></div>
                </div>
                 <div class="playjockey-tabs-bar" id="playJockeyTabsBar">
                    </div>
                <div class="playjockey-playlist-area" id="playJockeyPlaylist">
                    </div>
                <div class="playjockey-controls-bar">
                    <button id="playJockeyRandomBtn" class="xp-button">Random: Off</button>
                    <button id="playJockeyAutoPlayBtn" class="xp-button">Auto Play: On</button>
                    <button id="playJockeyRepeatBtn" class="xp-button">Repeat: Off</button>
                </div>
            </div>
        </div>
        <div class="resize-handle" id="playJockeyResizeHandle"></div>
    </div>

    <div class="xp-window" id="geminiChatWindow">
        <div class="title-bar" id="geminiChatWindowTitleBar">
            <span class="title-bar-text">Gemini Chat</span>
            <div class="title-bar-controls">
                <button id="geminiChatMinimizeBtn" title="Minimize">0</button>
                <button id="geminiChatMaximizeBtn" title="Maximize">1</button>
                <button title="Close" id="geminiChatCloseBtn">r</button>
            </div>
        </div>
        <div class="window-body" id="geminiChatWindowBody">
            <div class="gemini-chat-body-container">
                <div class="gemini-chat-controls-bar">
                    <button id="geminiChatClearHistoryBtn" class="xp-button xp-button-small">Clear History</button>
                </div>
                <div class="gemini-chat-display-area" id="geminiChatDisplayArea">
                    </div>
                <div class="gemini-chat-input-area">
                    <textarea id="geminiChatPromptInput" placeholder="Type your message to Gemini..." rows="2"></textarea>
                    <button id="geminiChatSendBtn" class="xp-button">Send</button>
                </div>
            </div>
        </div>
        <div class="resize-handle" id="geminiChatResizeHandle"></div>
    </div>

    <div id="newAreaModal" class="modal">
        <div class="modal-content">
            <div class="modal-title-bar">
                <span id="newAreaModalTitle">Create New Area</span>
                <span class="close-button" data-modal-id="newAreaModal">r</span>
            </div>
            <div class="modal-body">
                <label for="newAreaName">Area Name:</label>
                <input type="text" id="newAreaName" placeholder="e.g., Fitness, Learning, Work">
            </div>
            <div class="modal-footer">
                <button id="saveNewAreaBtn" class="xp-button">Save</button>
                <button class="xp-button" data-modal-id="newAreaModal">Cancel</button>
            </div>
        </div>
    </div>
    <div id="addEditAchievementModal" class="modal">
        <div class="modal-content">
            <div class="modal-title-bar">
                <span id="addEditAchievementModalTitle">Add Achievement</span>
                <span class="close-button" data-modal-id="addEditAchievementModal">r</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="achievementAreaName">
                <input type="hidden" id="achievementDayIndex">
                <input type="hidden" id="editingAchievementKey">
                <input type="hidden" id="editingAchievementId">
                <label>Type:</label>
                <input type="radio" name="achievementType" value="text" id="typeText" checked> Text
                <input type="radio" name="achievementType" value="image" id="typeImage"> Image
                <br><br>
                <div id="textInputDiv">
                    <label for="achievementText">Description:</label>
                    <textarea id="achievementText" rows="3"></textarea>
                </div>
                <div id="imageInputDiv" style="display:none;">
                    <label for="achievementImage">Upload Image:</label>
                    <input type="file" id="achievementImage" accept="image/*">
                    <p><small>Current image will be kept if no new image is selected during edit.</small></p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveAchievementBtn" class="xp-button">Save Achievement</button>
                <button class="xp-button" data-modal-id="addEditAchievementModal">Cancel</button>
            </div>
        </div>
    </div>
    <div id="questsModal" class="modal">
        <div class="modal-content">
            <div class="modal-title-bar">
                <span>Weekly Quests</span>
                <span class="close-button" data-modal-id="questsModal">r</span>
            </div>
            <div class="modal-body" id="questsList">
                </div>
            <div class="modal-footer">
                <button id="addQuestBtn" class="xp-button">Create New Quest</button>
                <button class="xp-button" data-modal-id="questsModal">Close</button>
            </div>
        </div>
    </div>
    <div id="confirmRemoveAreaModal" class="modal">
        <div class="modal-content">
            <div class="modal-title-bar">
                <span>Confirm Deletion</span>
                <span class="close-button" data-modal-id="confirmRemoveAreaModal">r</span>
            </div>
            <div class="modal-body">
                <p id="confirmRemoveAreaMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button id="confirmRemoveBtn" class="xp-button">Confirm</button>
                <button class="xp-button" data-modal-id="confirmRemoveAreaModal">Cancel</button>
            </div>
        </div>
    </div>
    <div id="confirmDeleteAchievementModal" class="modal">
        <div class="modal-content">
            <div class="modal-title-bar">
                <span>Confirm Achievement Deletion</span>
                <span class="close-button" data-modal-id="confirmDeleteAchievementModal">r</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this achievement? This will deduct its XP.</p>
            </div>
            <div class="modal-footer">
                <button id="confirmDeleteAchievementBtn" class="xp-button">Delete</button>
                <button class="xp-button" data-modal-id="confirmDeleteAchievementModal">Cancel</button>
            </div>
        </div>
    </div>
    <div id="createQuestModal" class="modal">
        <div class="modal-content">
            <div class="modal-title-bar">
                <span>Create New Quest</span>
                <span class="close-button" data-modal-id="createQuestModal">r</span>
            </div>
            <div class="modal-body">
                <label for="newQuestAreaName">Area:</label>
                <select id="newQuestAreaName"></select>
                <label for="newQuestDescription">Description:</label>
                <textarea id="newQuestDescription" rows="2" placeholder="e.g., Read 2 chapters"></textarea>
                <label for="newQuestTargetXP">Target XP to Earn in Area for Quest:</label>
                <input type="number" id="newQuestTargetXP" min="1" value="30">
                <label for="newQuestRewardXP">Quest Reward XP:</label>
                <input type="number" id="newQuestRewardXP" min="1" value="50">
            </div>
            <div class="modal-footer">
                <button id="saveNewQuestBtn" class="xp-button">Save Quest</button>
                <button class="xp-button" data-modal-id="createQuestModal">Cancel</button>
            </div>
        </div>
    </div>
    <div id="confirmRefreshQuestModal" class="modal">
        <div class="modal-content">
            <div class="modal-title-bar">
                <span>Confirm Quest Refresh</span>
                <span class="close-button" data-modal-id="confirmRefreshQuestModal">r</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to refresh this quest? Current progress on this quest will be lost and a new quest will be generated.</p>
            </div>
            <div class="modal-footer">
                <button id="confirmRefreshQuestBtn" class="xp-button">Refresh Quest</button>
                <button class="xp-button" data-modal-id="confirmRefreshQuestModal">Cancel</button>
            </div>
        </div>
    </div>
    <div id="changeBgImageModal" class="modal">
        <div class="modal-content" style="max-width: 550px;"> <div class="modal-title-bar">
                <span>Change Background</span>
                <span class="close-button" data-modal-id="changeBgImageModal">r</span>
            </div>
            <div class="modal-body">
                <p>Choose a background type for the application:</p>
                <div>
                    <label for="newBgImageInput">1. Upload image file:</label>
                    <input type="file" id="newBgImageInput" accept="image/*">
                     <p><small>Max 5MB recommended for file uploads due to browser storage limits.</small></p>
                    <button id="uploadBgImageBtn" class="xp-button" style="margin-top: 5px;">Upload File & Apply</button>
                </div>
                <hr>
                <div>
                    <label for="bgImageUrlInput">2. Enter image URL:</label>
                    <input type="text" id="bgImageUrlInput" placeholder="https://example.com/image.png">
                    <p><small>Using a URL is recommended for very large images from the web.</small></p>
                    <button id="applyBgImageUrlBtn" class="xp-button" style="margin-top: 5px;">Apply URL</button>
                </div>
                <hr>
                <div>
                    <label>3. Pick a solid color:</label>
                    <div id="bgColorSwatchesContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; justify-content: center;">
                          </div>
                     <p style="margin-top: 8px;"><small>Click a color swatch to apply it immediately.</small></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="xp-button" data-modal-id="changeBgImageModal">Cancel</button>
            </div>
        </div>
    </div>

    <div id="playJockeyContextMenu" class="context-modal">
        <div class="context-modal-item" id="pjContextRename">Rename Track</div>
        <div class="context-modal-item" id="pjContextRemove">Remove Track</div>
    </div>
    <div id="playJockeyTabContextMenu" class="context-modal">
        <div class="context-modal-item" id="pjTabContextRename">Rename Playlist</div>
        <div class="context-modal-item" id="pjTabContextRemove">Remove Playlist</div>
    </div>

    <div id="renamePlaylistModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-title-bar">
                <span>Rename Playlist</span>
                <span class="close-button" data-modal-id="renamePlaylistModal">r</span>
            </div>
            <div class="modal-body">
                <label for="playlistNewNameInput">New playlist name:</label>
                <input type="text" id="playlistNewNameInput" placeholder="Enter playlist name">
            </div>
            <div class="modal-footer">
                <button id="saveRenamedPlaylistBtn" class="xp-button">Save</button>
                <button class="xp-button" data-modal-id="renamePlaylistModal">Cancel</button>
            </div>
        </div>
    </div>

    <div id="confirmRemovePlaylistModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-title-bar">
                <span>Confirm Playlist Deletion</span>
                <span class="close-button" data-modal-id="confirmRemovePlaylistModal">r</span>
            </div>
            <div class="modal-body">
                <p id="confirmRemovePlaylistMessage">Are you sure you want to remove this playlist?</p>
            </div>
            <div class="modal-footer">
                <button id="confirmFinalPlaylistRemoveBtn" class="xp-button">Delete</button>
                <button class="xp-button" data-modal-id="confirmRemovePlaylistModal">Cancel</button>
            </div>
        </div>
    </div>

    <div id="youtubeSearchModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-title-bar">
                <span>Youtube Results</span>
                <span class="close-button" data-modal-id="youtubeSearchModal">r</span>
            </div>
            <div class="modal-body" id="youtubeSearchResultsBody">
                <p id="youtubeSearchStatus" style="text-align: center; display: none;"></p>
            </div>
            <div class="modal-footer">
                <button class="xp-button" data-modal-id="youtubeSearchModal">Cancel</button>
            </div>
        </div>
    </div>

    <div id="renameTrackModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-title-bar">
                <span>Rename Track</span>
                <span class="close-button" data-modal-id="renameTrackModal">r</span>
            </div>
            <div class="modal-body">
                <label for="trackNewNameInput">New track name:</label>
                <input type="text" id="trackNewNameInput" placeholder="Enter track name">
                <label for="trackNewArtistInput" style="margin-top:10px;">New artist name (optional):</label>
                <input type="text" id="trackNewArtistInput" placeholder="Enter artist name">
            </div>
            <div class="modal-footer">
                <button id="saveRenamedTrackBtn" class="xp-button">Save</button>
                <button class="xp-button" data-modal-id="renameTrackModal">Cancel</button>
            </div>
        </div>
    </div>

    <div id="confirmRemoveTrackModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-title-bar">
                <span>Confirm Track Deletion</span>
                <span class="close-button" data-modal-id="confirmRemoveTrackModal">r</span>
            </div>
            <div class="modal-body">
                <p id="confirmRemoveTrackMessage">Are you sure you want to remove this track from the playlist?</p>
            </div>
            <div class="modal-footer">
                <button id="confirmFinalTrackRemoveBtn" class="xp-button">Delete</button>
                <button class="xp-button" data-modal-id="confirmRemoveTrackModal">Cancel</button>
            </div>
        </div>
    </div>

    <div id="confirmClearChatModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-title-bar">
                <span>Confirm Clear History</span>
                <span class="close-button" data-modal-id="confirmClearChatModal">r</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to clear the entire chat history? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button id="confirmClearChatBtn" class="xp-button">Clear History</button>
                <button class="xp-button" data-modal-id="confirmClearChatModal">Cancel</button>
            </div>
        </div>
    </div>
    <script src="https://www.youtube.com/iframe_api"></script>

<script>
    "use strict";

    const WEEKDAYS = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    const XP_PER_REGULAR_ACHIEVEMENT = 10;
    const XP_PER_QUEST_COMPLETED_BASE = 50;
    const STORAGE_KEY = 'lifeXpData_v1.10.0'; 
    const YOUTUBE_API_KEY = "AIzaSyCmfQymtVEL3b_YEi7FlhpdNX5MkGsrNDM"; 
    const GEMINI_API_KEY = "AIzaSyDsrkiasqd692YW4Hyza8v9_1aksbjKVwM"; // <<< IMPORTANT: REPLACE WITH YOUR ACTUAL GEMINI API KEY
    const MAX_WEEKLY_QUESTS = 5;
    const ICON_GRID_SIZE = 25;

    let minTrackerAppWidth;
    const MIN_TRACKER_APP_HEIGHT = 250;
    const MIN_TEXTEDITOR_WIDTH = 450;
    const MIN_TEXTEDITOR_HEIGHT = 300;
    const MIN_PLAYJOCKEY_WIDTH = 480;
    const MIN_PLAYJOCKEY_HEIGHT = 425;
    const MIN_GEMINI_CHAT_WIDTH = 380;
    const MIN_GEMINI_CHAT_HEIGHT = 280;


    const STANDARD_COLORS = [
        { name: 'Black', value: '#000000' }, { name: 'Silver', value: '#C0C0C0' },
        { name: 'Gray', value: '#808080' }, { name: 'White', value: '#FFFFFF' },
        { name: 'Maroon', value: '#800000' }, { name: 'Red', value: '#FF0000' },
        { name: 'Purple', value: '#800080' }, { name: 'Fuchsia', value: '#FF00FF' },
        { name: 'Green', value: '#008000' }, { name: 'Lime', value: '#00FF00' },
        { name: 'Olive', value: '#808000' }, { name: 'Yellow', value: '#FFFF00' },
        { name: 'Navy', value: '#000080' }, { name: 'Blue', value: '#0000FF' },
        { name: 'Teal', value: '#008080' }, { name: 'Aqua', value: '#00FFFF' },
        { name: 'Orange', value: '#FFA500' }, { name: 'Brown', value: '#A52A2A' },
        { name: 'Pink', value: '#FFC0CB' }, { name: 'Gold', value: '#FFD700' },
        { name: 'Dark Green', value: '#006400' }, { name: 'Light Blue', value: '#ADD8E6' },
        { name: 'Indigo', value: '#4B0082' }, { name: 'Violet', value: '#EE82EE' },
        { name: 'Coral', value: '#FF7F50' }, { name: 'Sky Blue', value: '#87CEEB' }
    ];

    const MODAL_IDS = {
        NEW_AREA: 'newAreaModal',
        ADD_EDIT_ACHIEVEMENT: 'addEditAchievementModal',
        QUESTS: 'questsModal',
        CONFIRM_REMOVE_AREA: 'confirmRemoveAreaModal',
        CONFIRM_DELETE_ACHIEVEMENT: 'confirmDeleteAchievementModal',
        CREATE_QUEST: 'createQuestModal',
        CONFIRM_REFRESH_QUEST: 'confirmRefreshQuestModal',
        CHANGE_BG_IMAGE: 'changeBgImageModal',
        RENAME_PLAYLIST: 'renamePlaylistModal',
        CONFIRM_REMOVE_PLAYLIST: 'confirmRemovePlaylistModal',
        Youtube: 'youtubeSearchModal',
        RENAME_TRACK: 'renameTrackModal',
        CONFIRM_REMOVE_TRACK: 'confirmRemoveTrackModal',
        CONFIRM_CLEAR_CHAT: 'confirmClearChatModal' //
    };

    const getById = (id) => document.getElementById(id);

    function decodeHtmlEntities(text) {
        if (typeof text !== 'string') {
            return text;
        }
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        return textarea.value;
    }

    const DOM = {
        xpMainWindow: getById('xpMainWindow'),
        xpMainWindowTitleBar: getById('xpMainWindowTitleBar'),
        xpMainWindowResizeHandle: getById('xpMainWindowResizeHandle'),
        xpMainWindowMinimizeBtn: getById('xpMainWindowMinimizeBtn'),
        xpMainWindowMaximizeBtn: getById('xpMainWindowMaximizeBtn'),
        xpMainWindowCloseBtn: getById('xpMainWindowCloseBtn'),
        weekdayHeaders: getById('weekdayHeaders'),
        gridBody: getById('gridBody'),
        addAreaBtn: getById('addAreaBtn'),
        prevWeekBtn: getById('prevWeekBtn'),
        nextWeekBtn: getById('nextWeekBtn'),
        thisWeekBtn: getById('thisWeekBtn'),
        toggleViewBtn: getById('toggleViewBtn'),
        currentWeekDisplay: getById('currentWeekDisplay'),
        weekCountDisplay: getById('weekCountDisplay'),
        showQuestsBtn: getById('showQuestsBtn'),
        controlsBar: getById('controlsBar'),

        textEditorWindow: getById('textEditorWindow'),
        textEditorWindowTitleBar: getById('textEditorWindowTitleBar'),
        textEditorWindowBody: getById('textEditorWindowBody'),
        textEditorFrame: getById('textEditorFrame'),
        textEditorResizeHandle: getById('textEditorResizeHandle'),
        textEditorMinimizeBtn: getById('textEditorMinimizeBtn'),
        textEditorMaximizeBtn: getById('textEditorMaximizeBtn'),
        textEditorCloseBtn: getById('textEditorCloseBtn'),

        playJockeyWindow: getById('playJockeyWindow'),
        playJockeyTitleBar: getById('playJockeyTitleBar'),
        playJockeyWindowBody: getById('playJockeyWindowBody'),
        playJockeyResizeHandle: getById('playJockeyResizeHandle'),
        playJockeyMinimizeBtn: getById('playJockeyMinimizeBtn'),
        playJockeyMaximizeBtn: getById('playJockeyMaximizeBtn'),
        playJockeyCloseBtn: getById('playJockeyCloseBtn'),
        playJockeyLinkInput: getById('playJockeyLinkInput'),
        playJockeyAddBtn: getById('playJockeyAddBtn'),
        playJockeyPlayer: getById('playJockeyPlayer'),
        playJockeyTabsBar: getById('playJockeyTabsBar'),
        playJockeyPlaylist: getById('playJockeyPlaylist'),
        playJockeyContextMenu: getById('playJockeyContextMenu'),
        pjContextRenameBtn: getById('pjContextRename'),
        pjContextRemoveBtn: getById('pjContextRemove'),
        playJockeyTabContextMenu: getById('playJockeyTabContextMenu'),
        pjTabContextRenameBtn: getById('pjTabContextRename'),
        pjTabContextRemoveBtn: getById('pjTabContextRemove'),
        playJockeyRandomBtn: getById('playJockeyRandomBtn'),
        playJockeyAutoPlayBtn: getById('playJockeyAutoPlayBtn'),
        playJockeyRepeatBtn: getById('playJockeyRepeatBtn'),

        geminiChatWindow: getById('geminiChatWindow'),
        geminiChatWindowTitleBar: getById('geminiChatWindowTitleBar'),
        geminiChatWindowBody: getById('geminiChatWindowBody'),
        geminiChatResizeHandle: getById('geminiChatResizeHandle'),
        geminiChatMinimizeBtn: getById('geminiChatMinimizeBtn'),
        geminiChatMaximizeBtn: getById('geminiChatMaximizeBtn'),
        geminiChatCloseBtn: getById('geminiChatCloseBtn'),
        geminiChatDisplayArea: getById('geminiChatDisplayArea'),
        geminiChatPromptInput: getById('geminiChatPromptInput'),
        geminiChatSendBtn: getById('geminiChatSendBtn'),
        geminiChatClearHistoryBtn: getById('geminiChatClearHistoryBtn'),
        geminiChatIcon: getById('geminiChatIcon'),

        textEditorIcon: getById('textEditorIcon'),
        trackerIcon: getById('trackerIcon'),
        playJockeyIcon: getById('playJockeyIcon'),

        newAreaModal: getById(MODAL_IDS.NEW_AREA),
        newAreaNameInput: getById('newAreaName'),
        saveNewAreaBtn: getById('saveNewAreaBtn'),
        addEditAchievementModal: getById(MODAL_IDS.ADD_EDIT_ACHIEVEMENT),
        addEditAchievementModalTitle: getById('addEditAchievementModalTitle'),
        achievementAreaNameInput: getById('achievementAreaName'),
        achievementDayIndexInput: getById('achievementDayIndex'),
        editingAchievementKeyInput: getById('editingAchievementKey'),
        editingAchievementIdInput: getById('editingAchievementId'),
        achievementTypeRadios: document.getElementsByName('achievementType'),
        textInputDiv: getById('textInputDiv'),
        imageInputDiv: getById('imageInputDiv'),
        achievementTextInput: getById('achievementText'),
        achievementImageInput: getById('achievementImage'),
        saveAchievementBtn: getById('saveAchievementBtn'),
        questsModal: getById(MODAL_IDS.QUESTS),
        questsList: getById('questsList'),
        addQuestBtn: getById('addQuestBtn'),
        createQuestModal: getById(MODAL_IDS.CREATE_QUEST),
        newQuestAreaNameSelect: getById('newQuestAreaName'),
        newQuestDescriptionInput: getById('newQuestDescription'),
        newQuestTargetXPInput: getById('newQuestTargetXP'),
        newQuestRewardXPInput: getById('newQuestRewardXP'),
        saveNewQuestBtn: getById('saveNewQuestBtn'),
        confirmRefreshQuestModal: getById(MODAL_IDS.CONFIRM_REFRESH_QUEST),
        confirmRefreshQuestBtn: getById('confirmRefreshQuestBtn'),
        confirmRemoveAreaModal: getById(MODAL_IDS.CONFIRM_REMOVE_AREA),
        confirmRemoveAreaMessage: getById('confirmRemoveAreaMessage'),
        confirmRemoveBtn: getById('confirmRemoveBtn'),
        confirmDeleteAchievementModal: getById(MODAL_IDS.CONFIRM_DELETE_ACHIEVEMENT),
        confirmDeleteAchievementBtn: getById('confirmDeleteAchievementBtn'),
        changeBgImageModal: getById(MODAL_IDS.CHANGE_BG_IMAGE),
        newBgImageInput: getById('newBgImageInput'),
        uploadBgImageBtn: getById('uploadBgImageBtn'),
        bgImageUrlInput: getById('bgImageUrlInput'),
        applyBgImageUrlBtn: getById('applyBgImageUrlBtn'),
        bgColorSwatchesContainer: getById('bgColorSwatchesContainer'),

        renamePlaylistModal: getById(MODAL_IDS.RENAME_PLAYLIST),
        playlistNewNameInput: getById('playlistNewNameInput'),
        saveRenamedPlaylistBtn: getById('saveRenamedPlaylistBtn'),
        confirmRemovePlaylistModal: getById(MODAL_IDS.CONFIRM_REMOVE_PLAYLIST),
        confirmRemovePlaylistMessage: getById('confirmRemovePlaylistMessage'),
        confirmFinalPlaylistRemoveBtn: getById('confirmFinalPlaylistRemoveBtn'),

        youtubeSearchModal: getById(MODAL_IDS.Youtube),
        youtubeSearchResultsBody: getById('youtubeSearchResultsBody'),
        youtubeSearchStatus: getById('youtubeSearchStatus'),

        renameTrackModal: getById(MODAL_IDS.RENAME_TRACK),
        trackNewNameInput: getById('trackNewNameInput'),
        trackNewArtistInput: getById('trackNewArtistInput'),
        saveRenamedTrackBtn: getById('saveRenamedTrackBtn'),
        confirmRemoveTrackModal: getById(MODAL_IDS.CONFIRM_REMOVE_TRACK),
        confirmRemoveTrackMessage: getById('confirmRemoveTrackMessage'),
        confirmFinalTrackRemoveBtn: getById('confirmFinalTrackRemoveBtn'),
        
        // NEW DOM ELEMENTS FOR GEMINI CHAT CLEAR HISTORY MODAL
        confirmClearChatModal: getById(MODAL_IDS.CONFIRM_CLEAR_CHAT),
        confirmClearChatBtn: getById('confirmClearChatBtn'),

        modalCloseButtons: null
    };
    DOM.modalCloseButtons = document.querySelectorAll('.modal .close-button, .modal .xp-button[data-modal-id]');

    let defaultAppData; 

    let appData = { 
        areas: [],
        achievements: {},
        quests: {},
        currentWeekStartDate: null,
        viewMode: 'week',
        selectedDayIndex: 0,
        windowStates: {},
        iconPositions: {},
        customBgImage: null,
        customBgColor: null,
        playJockeyPlaylists: [],
        playJockeyCurrentPlaylistId: null,
        playJockeyCurrentVideo: null,
        playJockeyAutoPlayEnabled: true,
        playJockeyRandomEnabled: false,
        playJockeyRepeatState: "off",
        playJockeyRandomHistory: [],
        geminiChatHistory: []
    };

    let lastNormalStates = {};
    let highestZIndex = 9;

    let activeDragWindow = null;
    let activeResizeWindow = null;
    let dragOffsetX, dragOffsetY;
    let resizeInitialX, resizeInitialY, resizeInitialWidth, resizeInitialHeight;

    let activeDragIcon = null;
    let iconDragOffsetX, iconDragOffsetY;

    let pjDraggedItem = null;

    let ytPlayerInstance = null;
    let isYouTubeApiReady = false;
    let pendingVideoToLoad = null;


    function parseYYYYMMDDToLocalDate(dateString) {
        const [year, month, day] = dateString.split('-').map(Number);
        return new Date(year, month - 1, day);
    }

    function getDayOfYear(date) {
        const startOfYear = new Date(date.getFullYear(), 0, 0);
        const diff = date - startOfYear;
        const oneDay = 1000 * 60 * 60 * 24;
        return Math.floor(diff / oneDay);
    }

    function applyCurrentBackgroundStyle() {
        if (appData.customBgColor) {
            document.body.style.backgroundImage = 'none';
            document.body.style.backgroundColor = appData.customBgColor;
        } else if (appData.customBgImage) {
            document.body.style.backgroundColor = ''; 
            document.body.style.backgroundImage = `url('${appData.customBgImage}')`;
        } else {
            document.body.style.backgroundColor = '#3A6EA5';
            document.body.style.backgroundImage = "url('https://archive.org/download/bliss-600dpi/bliss-600dpi.png')";
        }
    }

    function init() {
        loadData(); 
        applyCurrentBackgroundStyle();
        populateColorSwatches();
        initDesktopIcons();

        if (appData.viewMode === 'week') {
            minTrackerAppWidth = 905;
        } else {
            minTrackerAppWidth = 375;
        }
        if (appData.viewMode !== 'week' && appData.viewMode !== 'day') {
             console.warn("Invalid viewMode loaded, defaulting to week.");
             appData.viewMode = 'week';
             minTrackerAppWidth = 905;
        }

        if (!appData.currentWeekStartDate) {
            appData.currentWeekStartDate = getMonday(new Date()).toISOString().split('T')[0];
        }
        if (appData.viewMode === 'day' && (appData.selectedDayIndex === undefined || appData.selectedDayIndex < 0 || appData.selectedDayIndex > 6) ) {
             appData.selectedDayIndex = 0;
        }

        initWindowInteractions('xpMainWindow');
        restoreWindowState('xpMainWindow'); 

        DOM.textEditorFrame.srcdoc = getTextEditorHTMLContent();
        initWindowInteractions('textEditorWindow');
        restoreWindowState('textEditorWindow'); 

        initWindowInteractions('playJockeyWindow');
        restoreWindowState('playJockeyWindow'); 

        initWindowInteractions('geminiChatWindow');
        restoreWindowState('geminiChatWindow'); 


        updateMinMaxButtonStates('xpMainWindow');
        updateMinMaxButtonStates('textEditorWindow');
        updateMinMaxButtonStates('playJockeyWindow');
        updateMinMaxButtonStates('geminiChatWindow');


        renderPlayJockeyTabs();
        renderPlayJockeyPlaylist();
        updatePlayJockeyAutoPlayButtonState();
        updatePlayJockeyRandomButtonState();
        updatePlayJockeyRepeatButtonState();


        if (appData.playJockeyCurrentVideo && (isYouTubeApiReady || typeof YT !== 'undefined')) {
            const currentPlaylist = getCurrentPlayJockeyPlaylist();
            if (currentPlaylist && currentPlaylist.videos.some(v => v.id === appData.playJockeyCurrentVideo.id)) {
                 playYouTubeVideoById(appData.playJockeyCurrentVideo.videoId, appData.playJockeyAutoPlayEnabled);
            } else {
                appData.playJockeyCurrentVideo = null; 
            }
        } else if (appData.playJockeyCurrentVideo) { 
            const currentPlaylist = getCurrentPlayJockeyPlaylist();
             if (currentPlaylist && currentPlaylist.videos.some(v => v.id === appData.playJockeyCurrentVideo.id)) {
                pendingVideoToLoad = { videoId: appData.playJockeyCurrentVideo.videoId, autoplayIntent: appData.playJockeyAutoPlayEnabled };
            } else {
                appData.playJockeyCurrentVideo = null;
            }
        }

        let maxLoadedWindowZ = highestZIndex; 
        ['xpMainWindow', 'textEditorWindow', 'playJockeyWindow', 'geminiChatWindow'].forEach(windowId => {
            if (appData.windowStates[windowId] && appData.windowStates[windowId].zIndex) {
                maxLoadedWindowZ = Math.max(maxLoadedWindowZ, parseInt(appData.windowStates[windowId].zIndex));
            }
        });
        highestZIndex = maxLoadedWindowZ;


        addEventListeners();
        initPlayJockeyContextMenu();
        initPlayJockeyTabContextMenu();


        updateViewControls();
        updateDateDisplay();
        renderWeekdayHeaders();
        renderGrid();
        generateQuestsForCurrentWeekIfNeeded();
        handleAppWindowResize(); 

        const trackerWindowObserver = new ResizeObserver(handleAppWindowResize);
        trackerWindowObserver.observe(DOM.xpMainWindow);

        saveData(); 
    }

    function initDesktopIcons() {
        const icons = [DOM.textEditorIcon, DOM.trackerIcon, DOM.playJockeyIcon, DOM.geminiChatIcon];
        const iconData = [
            { id: 'trackerIcon', defaultX: 0, defaultY: 0, element: DOM.trackerIcon },
            { id: 'textEditorIcon', defaultX: 0, defaultY: 100, element: DOM.textEditorIcon },
            { id: 'playJockeyIcon', defaultX: 0, defaultY: 200, element: DOM.playJockeyIcon },
            { id: 'geminiChatIcon', defaultX: 0, defaultY: 300, element: DOM.geminiChatIcon }
        ];

        iconData.forEach(data => {
            const iconElement = data.element;
            if (!iconElement) return;

            const iconId = iconElement.id;
            if (appData.iconPositions && appData.iconPositions[iconId]) {
                iconElement.style.left = appData.iconPositions[iconId].x + 'px';
                iconElement.style.top = appData.iconPositions[iconId].y + 'px';
            } else {
                const { x: finalX, y: finalY } = findNonCollidingPosition(iconElement, data.defaultX, data.defaultY);

                iconElement.style.left = finalX + 'px';
                iconElement.style.top = finalY + 'px';

                if (!appData.iconPositions) appData.iconPositions = {};
                appData.iconPositions[iconId] = { x: finalX, y: finalY };
            }

            iconElement.addEventListener('mousedown', handleIconMouseDown);
            iconElement.addEventListener('dblclick', handleIconDoubleClick);
        });
    }


    function handleIconMouseDown(e) {
        if (e.button !== 0 || activeDragWindow || activeResizeWindow) return;

        activeDragIcon = e.currentTarget;
        const windowId = activeDragIcon.dataset.windowId;
        const windowEl = getById(windowId);
        if(windowEl && windowEl.style.display !== 'none' && !windowEl.classList.contains('minimized')) {
             bringToFront(windowEl);
        }

        iconDragOffsetX = e.clientX - activeDragIcon.offsetLeft;
        iconDragOffsetY = e.clientY - activeDragIcon.offsetTop;

        activeDragIcon.style.cursor = 'grabbing';
        activeDragIcon.style.zIndex = '6'; 

        document.addEventListener('mousemove', handleIconMouseMove);
        document.addEventListener('mouseup', handleIconMouseUp);
        e.preventDefault();
    }

    function handleIconMouseMove(e) {
        if (!activeDragIcon) return;
        let newX = e.clientX - iconDragOffsetX;
        let newY = e.clientY - iconDragOffsetY;

        const bodyRect = document.body.getBoundingClientRect();
        const iconWidth = activeDragIcon.offsetWidth || 90;
        const iconHeight = activeDragIcon.offsetHeight || 100;

        newX = Math.max(0, Math.min(newX, bodyRect.width - iconWidth));
        newY = Math.max(0, Math.min(newY, bodyRect.height - iconHeight));

        activeDragIcon.style.left = newX + 'px';
        activeDragIcon.style.top = newY + 'px';
    }

    function findNonCollidingPosition(draggedIcon, initialX, initialY) {
        let currentX = initialX;
        let currentY = initialY;
        let attempt = 0;
        const maxAttempts = 100; 
        const iconWidth = draggedIcon.offsetWidth || 90;
        const iconHeight = draggedIcon.offsetHeight || 100;

        const checkCollisionAt = (x, y, currentDraggedIcon) => {
            const iconsToCompare = [DOM.textEditorIcon, DOM.trackerIcon, DOM.playJockeyIcon, DOM.geminiChatIcon].filter(
                icon => icon && icon !== currentDraggedIcon && icon.style.left && icon.style.top 
            );

            for (const otherIcon of iconsToCompare) {
                const otherLeft = parseInt(otherIcon.style.left, 10);
                const otherTop = parseInt(otherIcon.style.top, 10);
                const otherWidth = otherIcon.offsetWidth || 90;
                const otherHeight = otherIcon.offsetHeight || 100;

                if (x < otherLeft + otherWidth &&
                    x + iconWidth > otherLeft &&
                    y < otherTop + otherHeight &&
                    y + iconHeight > otherTop) {
                    return true; 
                }
            }
            return false; 
        };
        
        let snappedX = Math.round(initialX / ICON_GRID_SIZE) * ICON_GRID_SIZE;
        let snappedY = Math.round(initialY / ICON_GRID_SIZE) * ICON_GRID_SIZE;
        snappedX = Math.max(0, Math.min(snappedX, document.body.clientWidth - iconWidth));
        snappedY = Math.max(0, Math.min(snappedY, document.body.clientHeight - iconHeight));


        if (!checkCollisionAt(snappedX, snappedY, draggedIcon)) {
            return { x: snappedX, y: snappedY };
        }

        let layer = 1;
        while (attempt < maxAttempts) {
            const positionsToTry = [];
            for (let i = -layer; i <= layer; i++) {
                positionsToTry.push({ x: snappedX + i * ICON_GRID_SIZE, y: snappedY - layer * ICON_GRID_SIZE }); 
                if (layer !== 0) positionsToTry.push({ x: snappedX + i * ICON_GRID_SIZE, y: snappedY + layer * ICON_GRID_SIZE }); 
            }
            for (let i = -layer + 1; i < layer; i++) {
                positionsToTry.push({ x: snappedX - layer * ICON_GRID_SIZE, y: snappedY + i * ICON_GRID_SIZE }); 
                if (layer !== 0) positionsToTry.push({ x: snappedX + layer * ICON_GRID_SIZE, y: snappedY + i * ICON_GRID_SIZE }); 
            }

            for (const pos of positionsToTry) {
                attempt++;
                if (attempt >= maxAttempts) break;

                let testX = pos.x;
                let testY = pos.y;

                testX = Math.max(0, Math.min(testX, document.body.clientWidth - iconWidth));
                testY = Math.max(0, Math.min(testY, document.body.clientHeight - iconHeight));
                testX = Math.round(testX / ICON_GRID_SIZE) * ICON_GRID_SIZE;
                testY = Math.round(testY / ICON_GRID_SIZE) * ICON_GRID_SIZE;


                if (!checkCollisionAt(testX, testY, draggedIcon)) {
                    return { x: testX, y: testY };
                }
            }
            if (attempt >= maxAttempts) break;
            layer++;
            if (layer * ICON_GRID_SIZE > Math.max(document.body.clientWidth, document.body.clientHeight) && attempt > 20) {
                 console.warn("Collision search boundary too large for icon placement. Layer:", layer); break;
            }
        }

        console.warn("Could not find a non-colliding position for icon " + draggedIcon.id + " after " + attempt + " attempts. Using original snapped position which might collide.");
        return { x: snappedX, y: snappedY }; 
    }


    function handleIconMouseUp() {
        if (!activeDragIcon) return;

        activeDragIcon.style.zIndex = '5'; 

        let finalX = activeDragIcon.offsetLeft;
        let finalY = activeDragIcon.offsetTop;

        let snappedX = Math.round(finalX / ICON_GRID_SIZE) * ICON_GRID_SIZE;
        let snappedY = Math.round(finalY / ICON_GRID_SIZE) * ICON_GRID_SIZE;

        const iconWidth = activeDragIcon.offsetWidth || 90;
        const iconHeight = activeDragIcon.offsetHeight || 100;
        snappedX = Math.max(0, Math.min(snappedX, document.body.clientWidth - iconWidth));
        snappedY = Math.max(0, Math.min(snappedY, document.body.clientHeight - iconHeight));
        snappedX = Math.round(snappedX / ICON_GRID_SIZE) * ICON_GRID_SIZE;
        snappedY = Math.round(snappedY / ICON_GRID_SIZE) * ICON_GRID_SIZE;


        const { x: finalSnappedX, y: finalSnappedY } = findNonCollidingPosition(activeDragIcon, snappedX, snappedY);

        activeDragIcon.style.left = finalSnappedX + 'px';
        activeDragIcon.style.top = finalSnappedY + 'px';

        const iconId = activeDragIcon.id;
        if (!appData.iconPositions) appData.iconPositions = {};
        appData.iconPositions[iconId] = { x: finalSnappedX, y: finalSnappedY };
        saveData();

        activeDragIcon.style.cursor = 'grab';
        activeDragIcon = null;
        document.removeEventListener('mousemove', handleIconMouseMove);
        document.removeEventListener('mouseup', handleIconMouseUp);
    }

    function handleIconDoubleClick(e) {
        const iconElement = e.currentTarget;
        const windowId = iconElement.dataset.windowId;
        const windowElement = getById(windowId);

        if (!windowElement) return;

        let state = appData.windowStates[windowId];
        if (!state) {
            console.warn(`State for window ${windowId} was missing on double click. Attempting to restore/initialize.`);
            restoreWindowState(windowId); 
            state = appData.windowStates[windowId]; 
            if(!state) {
                console.error(`Failed to initialize state for ${windowId} on double click.`);
                return;
            }
        }


        if (state.hiddenByUser || windowElement.style.display === 'none') {
            state.hiddenByUser = false;
            state.minimized = false; 
            
            windowElement.style.display = 'flex'; 
            windowElement.classList.remove('minimized');
            restoreWindowState(windowId); 

            if (windowId === 'playJockeyWindow') {
                if (appData.playJockeyCurrentVideo && !ytPlayerInstance && isYouTubeApiReady) {
                    playYouTubeVideoById(appData.playJockeyCurrentVideo.videoId, false);
                } else if (pendingVideoToLoad && isYouTubeApiReady) {
                    playYouTubeVideoById(pendingVideoToLoad.videoId, pendingVideoToLoad.autoplayIntent);
                    pendingVideoToLoad = null;
                }
            }
        } else if (state.minimized || windowElement.classList.contains('minimized')) {
            maximizeWindow(windowId); 
        }
        
        bringToFront(windowElement);
        saveWindowState(windowId); 
    }


    function getTextEditorHTMLContent() {
        return `
<html lang="en">
<head>
    <title>Jotter</title>
    <style>
        html, body { 
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }
        body {
            font-family: "Tahoma", "Geneva", sans-serif;
            font-size: 11px;
            background-color: #ECE9D8;
            color: #000000;
            display: flex;
            flex-direction: column;
        }
        [contenteditable]:focus { outline: none; }

        .jotter-menu-bar {
            background-color: #ECE9D8;
            padding: 2px 3px;
            border-bottom: 1px solid #ACA899;
            display: flex;
            flex-shrink: 0; 
            user-select: none;
            color: #000000;
        }
        .jotter-menu-item {
            padding: 3px 8px;
            cursor: default;
            position: relative;
            color: inherit;
        }
        .jotter-menu-item:hover {
            background-color: #005CFE;
            color: white;
        }
        .jotter-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #ECE9D8;
            border: 1px solid #000;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            z-index: 100;
            min-width: 150px; 
            padding: 2px 0;
            color: #000000;
        }
        .jotter-dropdown-item {
            padding: 4px 12px 4px 25px;
            cursor: default;
            white-space: nowrap;
            position: relative;
            color: inherit;
            display: flex; 
            align-items: center; 
        }
        .jotter-dropdown-item:hover:not(.disabled) {
            background-color: #005CFE;
            color: white;
        }
        .jotter-dropdown-item.disabled {
            color: #7F7F7F !important;
            background-color: #ECE9D8 !important;
            cursor: default;
        }
        .jotter-menu-item:focus-within .jotter-dropdown-content,
        .jotter-menu-item.open .jotter-dropdown-content {
            display: block;
        }
        .jotter-menu-item .underline {
            text-decoration: underline;
        }

        #editorArea {
            border: 1px solid #7F7F7F;
            padding: 5px;
            background-color: white;
            overflow-y: auto;
            font-family: 'Lucida Console', Monaco, monospace;
            font-size: 14px; 
            line-height: 1.4;
            color: #000000;
            white-space: pre-wrap; 
            word-wrap: break-word;
            box-sizing: border-box;
            margin: 5px; 
            flex-grow: 1; 
        }

        .font-size-control-container {
            display: flex;
            align-items: center;
            padding: 0px 5px 0px 15px !important;
        }
        .font-size-control-container span {
            margin-right: 8px;
        }
        .font-size-btn {
            font-family: "Tahoma", "Geneva", sans-serif;
            font-size: 10px;
            border: 1px outset #7F7F7F;
            background-color: #ECE9D8;
            width: 20px;
            height: 20px;
            line-height: 18px; 
            text-align: center;
            padding: 0;
            cursor: default;
            color: black;
        }
        .font-size-btn:active {
            border-style: inset;
        }
        .font-size-input {
            width: 30px;
            height: 18px;
            border: 1px solid #7F7F7F;
            text-align: center;
            margin: 0 3px;
            font-family: "Tahoma", "Geneva", sans-serif;
            font-size: 11px;
            padding: 1px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="jotter-menu-bar" id="jotterMenuBarInFrame">
        <div class="jotter-menu-item" tabindex="0">
            <span class="underline">F</span>ile
            <div class="jotter-dropdown-content">
                <div class="jotter-dropdown-item" id="fileSaveInFrame">Save</div>
            </div>
        </div>
        <div class="jotter-menu-item" tabindex="0">
            <span class="underline">V</span>iew
            <div class="jotter-dropdown-content">
                <div class="jotter-dropdown-item font-size-control-container" id="fontSizeControlItemInFrame">
                    <span>Font Size:</span>
                    <button class="font-size-btn" id="fontDecrementBtnInFrame">-</button>
                    <input type="number" class="font-size-input" id="fontSizeInputInFrame" value="14" min="8" max="72">
                    <button class="font-size-btn" id="fontIncrementBtnInFrame">+</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editorArea" contenteditable="true"></div>

    <script>
        const editorArea = document.getElementById('editorArea');
        const jotterMenuBar = document.getElementById('jotterMenuBarInFrame'); 
        const bodyElement = document.body; 
        let activeMenu = null;

        const fontDecrementBtn = document.getElementById('fontDecrementBtnInFrame');
        const fontIncrementBtn = document.getElementById('fontIncrementBtnInFrame');
        const fontSizeInput = document.getElementById('fontSizeInputInFrame');
        
        jotterMenuBar.querySelectorAll('.jotter-menu-bar > .jotter-menu-item').forEach(menuItem => {
            menuItem.addEventListener('click', (event) => {
                event.stopPropagation();
                if (event.target.closest('.font-size-control-container')) {
                    if(!menuItem.classList.contains('open')) {
                         if (activeMenu && activeMenu !== menuItem) activeMenu.classList.remove('open');
                         menuItem.classList.add('open');
                         activeMenu = menuItem;
                    }
                    return;
                }

                if (activeMenu && activeMenu !== menuItem) {
                    activeMenu.classList.remove('open');
                }
                menuItem.classList.toggle('open');
                activeMenu = menuItem.classList.contains('open') ? menuItem : null;
            });

            menuItem.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    if (event.target === menuItem || menuItem.contains(event.target) && !event.target.closest('.jotter-dropdown-content .jotter-menu-item')) {
                        menuItem.click();
                    }
                }
            });
        });
        
        window.addEventListener('click', (event) => {
            if (activeMenu && !activeMenu.contains(event.target) && !event.target.closest('.font-size-control-container')) {
                activeMenu.classList.remove('open');
                activeMenu = null;
            }
        });

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && activeMenu) {
                activeMenu.classList.remove('open');
                activeMenu.focus(); 
                activeMenu = null;
            }
        });

        const fileSaveButton = document.getElementById('fileSaveInFrame');
        fileSaveButton.addEventListener('click', (event) => {
             event.stopPropagation();
            performSave();
        });

        function performSave() {
            let filename = prompt("Filename:", "jotter_content.html");
            if (filename) {
                let htmlContent = `<!DOCTYPE html>
<html>
<head>
    <title>Saved Content</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Lucida Console', Monaco, monospace; font-size: ${editorArea.style.fontSize || '14px'}; margin: 20px; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    ${editorArea.innerHTML}
</body>
</html>`;
                let blob = new Blob([htmlContent], { type: "text/html" });
                let url = URL.createObjectURL(blob);
                let downloadLink = document.createElement("a");
                downloadLink.setAttribute("href", url);
                downloadLink.setAttribute("download", filename);
                downloadLink.click();
                URL.revokeObjectURL(url);
            }
            if (activeMenu) {
                 activeMenu.classList.remove('open');
                 activeMenu = null;
            }
        }

        editorArea.addEventListener('keydown', function(e) {
            if (e.ctrlKey && (e.key === 's' || e.key === 'S')) {
                e.preventDefault();
                performSave();
            }
        });
        window.addEventListener('keydown', function(e) { 
            if (e.ctrlKey && (e.key === 's' || e.key === 'S') && !e.target.closest('#editorArea')) {
                e.preventDefault();
                performSave();
            }
        });

        function applyFontSize(size) {
            const newSize = Math.max(8, Math.min(72, parseInt(size))); 
            if (!isNaN(newSize)) {
                editorArea.style.fontSize = newSize + 'px';
                fontSizeInput.value = newSize;
            }
        }

        fontDecrementBtn.addEventListener('click', (event) => {
            event.stopPropagation(); 
            let currentSize = parseInt(fontSizeInput.value) || 14;
            applyFontSize(currentSize - 1);
        });

        fontIncrementBtn.addEventListener('click', (event) => {
            event.stopPropagation(); 
            let currentSize = parseInt(fontSizeInput.value) || 14;
            applyFontSize(currentSize + 1);
        });

        fontSizeInput.addEventListener('change', () => {
            applyFontSize(fontSizeInput.value);
        });
        fontSizeInput.addEventListener('click', (event) => {
            event.stopPropagation(); 
        });
         fontSizeInput.addEventListener('input', () => { 
            let val = parseInt(fontSizeInput.value);
            if(!isNaN(val) && val >=8 && val <=72){
                 editorArea.style.fontSize = val + 'px';
            }
        });

        applyFontSize(fontSizeInput.value);
        editorArea.focus();
    </script>
</body>
</html>