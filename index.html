<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life XP</title>
    <style>
        body {
            font-family: "Tahoma", "Geneva", sans-serif;
            font-size: 11px;
            background-color: #3A6EA5;
            background-image: url('https://archive.org/download/bliss-600dpi/bliss-600dpi.png');
            background-size: cover;
            background-position: 0% 0%;
            background-repeat: no-repeat;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }
        .xp-window {
            background-color: #ECE9D8;
            border: 1px solid #000;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.3);
            min-height: 30px;
            display: flex;
            flex-direction: column;
            position: absolute;
            overflow: hidden;
        }
        .xp-window.disable-selection,
        .xp-window.disable-selection * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .title-bar {
            background: linear-gradient(to bottom, #005CFE, #0039A9);
            color: white;
            padding: 5px 8px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 28px;
            box-sizing: border-box;
            flex-shrink: 0;
            user-select: none;
        }
        .title-bar:active {
            cursor: grabbing;
        }
        .title-bar-text {
            margin-left: 5px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .title-bar-controls button {
            background-color: #ECE9D8;
            border: 1px solid #000;
            width: 22px;
            height: 18px;
            font-family: "Marlett", "Webdings", sans-serif;
            font-size: 12px;
            line-height: 16px;
            margin-left: 2px;
            box-shadow: 1px 1px 0px #FFF inset, -1px -1px 0px #808080 inset;
            padding: 0;
            text-align: center;
            cursor: default;
        }
        .title-bar-controls button:active:not(:disabled) {
            box-shadow: -1px -1px 0px #FFF inset, 1px 1px 0px #808080 inset;
        }
        .title-bar-controls button:disabled {
            color: #7F7F7F;
            cursor: default;
            opacity: 0.7;
        }
        .window-body {
            flex-grow: 1;
            opacity: 1;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out, opacity 0.2s ease-out;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
        }
        .window-body iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        .xp-window.minimized .window-body,
        .xp-window.minimized .xp-menu-bar {
            max-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            opacity: 0 !important;
            overflow: hidden !important;
            border-top: none !important;
        }
        .xp-window.minimized {
            min-height: 28px !important;
            height: 28px !important;
            overflow: hidden;
        }
        .resize-handle {
            width: 12px;
            height: 12px;
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
            z-index: 10;
            box-sizing: border-box;
            opacity: 0.6;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10L10 7' stroke='%23666' stroke-width='1.2' stroke-linecap='round'/%3E%3Cpath d='M3 10L10 3' stroke='%23666' stroke-width='1.2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center center;
        }
        .resize-handle:hover {
            opacity: 1;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10L10 7' stroke='%23333' stroke-width='1.2' stroke-linecap='round'/%3E%3Cpath d='M3 10L10 3' stroke='%23333' stroke-width='1.2' stroke-linecap='round'/%3E%3C/svg%3E");
        }
        .xp-window.true-maximized .resize-handle {
            display: none;
        }
        .desktop-icon {
            position: absolute;
            width: 90px;
            height: 100px;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 1px black;
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 10px;
            box-sizing: border-box;
            z-index: 5;
        }
        .desktop-icon:active {
            cursor: grabbing;
        }
        .desktop-icon .icon-image {
            font-size: 48px;
            line-height: 1;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
            height: 50px;
        }
        .desktop-icon .icon-label {
            font-size: 12px;
            font-weight: normal;
            word-wrap: break-word;
            max-width: 100%;
        }
        .desktop-icon.playJockeyIconStyle .icon-image-base {
            filter: hue-rotate(140deg) saturate(1000%) brightness(70%);
        }
        .desktop-icon.playJockeyIconStyle .icon-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: hue-rotate(140deg) saturate(1000%);
            mix-blend-mode: luminosity;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #ECE9D8;
            margin: auto;
            padding: 0;
            border: 1px solid #000;
            width: 80%;
            max-width: 550px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
            display: flex;
            flex-direction: column;
        }
        .modal-title-bar {
            background: linear-gradient(to bottom, #005CFE, #0039A9);
            color: white;
            padding: 5px 8px;
            font-weight: bold;
            border-bottom: 1px solid #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 28px;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        .modal-title-bar .close-button {
            color: white;
            font-size: 16px;
            font-family: "Marlett", "Webdings", sans-serif;
            font-weight: normal;
            background: #E04343;
            border: 1px outset white;
            width: 22px;
            height: 18px;
            text-align: center;
            line-height: 16px;
            padding: 0;
            cursor: pointer;
        }
        .modal-title-bar .close-button:hover,
        .modal-title-bar .close-button:focus {
            background: #FF6363;
            text-decoration: none;
        }
         .modal-title-bar .close-button:active {
            border-style: inset;
        }
        .modal-body {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .modal-body p { margin-top: 0; margin-bottom: 10px; }
        .modal-body label { display: block; margin-bottom: 5px; margin-top: 12px; }
        .modal-body input[type="text"], .modal-body input[type="file"] {
            width: calc(100% - 12px); padding: 5px; margin-bottom: 10px;
            border: 1px solid #ACA899; box-sizing: border-box;
        }
        .modal-body hr { border: 0; height: 1px; background: #ACA899; margin: 20px 0; }
        .modal-footer {
            padding: 10px 15px; text-align: right;
            background-color: #F0F0F0; border-top: 1px solid #ACA899; flex-shrink: 0;
        }
        @keyframes fadeIn {
            from {opacity: 0; transform: scale(0.9);}
            to {opacity: 1; transform: scale(1);}
        }
        .xp-button {
            background-color: #ECE9D8; border: 1px outset #7F7F7F; padding: 5px 12px;
            min-width: 75px; text-align: center; cursor: pointer; margin: 2px;
        }
        .xp-button:active { border-style: inset; }
        .xp-button:hover { border-color: #005CFE; }
        .color-swatch-item {
            box-sizing: border-box;
            transition: transform 0.1s ease-out;
        }
        .color-swatch-item:hover {
            outline: 2px solid #005CFE;
            outline-offset: 1px;
            transform: scale(1.1);
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-remote-config.js"></script>
</head>
<body>
    <div id="desktop"></div>

    <div id="changeBgImageModal" class="modal">
        <div class="modal-content">
            <div class="modal-title-bar">
                <span>Change Background</span>
                <span class="close-button" data-modal-id="changeBgImageModal">r</span>
            </div>
            <div class="modal-body">
                <p>Choose a background type for the application:</p>
                <div>
                    <label for="newBgImageInput">1. Upload image file:</label>
                    <input type="file" id="newBgImageInput" accept="image/*">
                     <p><small>Max 5MB recommended for file uploads due to browser storage limits.</small></p>
                    <button id="uploadBgImageBtn" class="xp-button" style="margin-top: 5px;">Upload File & Apply</button>
                </div>
                <hr>
                <div>
                    <label for="bgImageUrlInput">2. Enter image URL:</label>
                    <input type="text" id="bgImageUrlInput" placeholder="https://example.com/image.png">
                    <p><small>Using a URL is recommended for very large images from the web.</small></p>
                    <button id="applyBgImageUrlBtn" class="xp-button" style="margin-top: 5px;">Apply URL</button>
                </div>
                <hr>
                <div>
                    <label>3. Pick a solid color:</label>
                    <div id="bgColorSwatchesContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; justify-content: center;">
                    </div>
                     <p style="margin-top: 8px;"><small>Click a color swatch to apply it immediately.</small></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="xp-button close-modal-btn" data-modal-id="changeBgImageModal">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        "use strict";
        const OS_STORAGE_KEY = 'lifeXpOsData_v1.0.2'; // Incremented version
        const ICON_GRID_SIZE = 25;
        const STANDARD_COLORS = [
            { name: 'Black', value: '#000000' }, { name: 'Silver', value: '#C0C0C0' },
            { name: 'Gray', value: '#808080' }, { name: 'White', value: '#FFFFFF' },
            { name: 'Maroon', value: '#800000' }, { name: 'Red', value: '#FF0000' },
            { name: 'Purple', value: '#800080' }, { name: 'Fuchsia', value: '#FF00FF' },
            { name: 'Green', value: '#008000' }, { name: 'Lime', value: '#00FF00' },
            { name: 'Olive', value: '#808000' }, { name: 'Yellow', value: '#FFFF00' },
            { name: 'Navy', value: '#000080' }, { name: 'Blue', value: '#0000FF' },
            { name: 'Teal', value: '#008080' }, { name: 'Aqua', value: '#00FFFF' },
            { name: 'Orange', value: '#FFA500' }, { name: 'Brown', value: '#A52A2A' },
            { name: 'Pink', value: '#FFC0CB' }, { name: 'Gold', value: '#FFD700' }
        ];
        // Firebase config remains the same
        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyCVWUnnXiOvKRqbvngafdZC7DedEY-7vpg",
          authDomain: "lifexpapp-f5578.firebaseapp.com",
          projectId: "lifexpapp-f5578",
          storageBucket: "lifexpapp-f5578.appspot.com",
          messagingSenderId: "194098013746",
          appId: "1:194098013746:web:720ba296ee9e40dee37e2b"
        };

        let osData = {
            windowStates: {},
            iconPositions: {},
            customBgImage: null,
            customBgColor: null,
            appApiKeys: {
                youtube: "",
                gemini: "",
                googleMaps: "" // Added new key
            }
        };
        let lastNormalStates = {};
        let highestZIndex = 10;
        let activeDragWindow = null;
        let activeResizeWindow = null;
        let dragOffsetX, dragOffsetY;
        let resizeInitialX, resizeInitialY, resizeInitialWidth, resizeInitialHeight;
        let activeDragIcon = null;
        let iconDragOffsetX, iconDragOffsetY;
        let appManifest = [];
        let firebaseRemoteConfig;


        const DOM = {
            desktop: document.getElementById('desktop'),
            changeBgImageModal: document.getElementById('changeBgImageModal'),
            newBgImageInput: document.getElementById('newBgImageInput'),
            uploadBgImageBtn: document.getElementById('uploadBgImageBtn'),
            bgImageUrlInput: document.getElementById('bgImageUrlInput'),
            applyBgImageUrlBtn: document.getElementById('applyBgImageUrlBtn'),
            bgColorSwatchesContainer: document.getElementById('bgColorSwatchesContainer'),
            modalCloseButtons: null
        };
        DOM.modalCloseButtons = document.querySelectorAll('.modal .close-button, .modal .close-modal-btn');


        function getById(id) { return document.getElementById(id); }

        async function initializeFirebaseAndLoadKeys() {
            try {
                if (typeof firebase !== 'undefined' && FIREBASE_CONFIG) {
                    firebase.initializeApp(FIREBASE_CONFIG);
                    firebaseRemoteConfig = firebase.remoteConfig();
                    // Set default values for all keys
                    firebaseRemoteConfig.defaultConfig = {
                        'youtube_api_key': '',
                        'gemini_api_key': '',
                        'google_maps_api_key': ''
                    };
                    firebaseRemoteConfig.settings.minimumFetchIntervalMillis = 3600000;
                    await firebaseRemoteConfig.fetchAndActivate();
                    
                    // Fetch all keys from remote config
                    osData.appApiKeys.youtube = firebaseRemoteConfig.getString('youtube_api_key');
                    osData.appApiKeys.gemini = firebaseRemoteConfig.getString('gemini_api_key');
                    osData.appApiKeys.googleMaps = firebaseRemoteConfig.getString('google_maps_api_key'); // Fetch maps key
                    
                    console.log("Firebase Remote Config fetched.");
                    console.log(" - YouTube Key:", osData.appApiKeys.youtube ? "Loaded" : "Not found");
                    console.log(" - Gemini Key:", osData.appApiKeys.gemini ? "Loaded" : "Not found");
                    console.log(" - Google Maps Key:", osData.appApiKeys.googleMaps ? "Loaded" : "Not found"); // Log status
                    
                    saveOsData();
                } else {
                    console.warn("Firebase SDK or config not available. API keys will not be fetched.");
                }
            } catch (err) {
                console.error("Error initializing Firebase Remote Config or fetching keys:", err);
            }
        }


        async function initOS() {
            loadOsData();
            await initializeFirebaseAndLoadKeys();

            applyCurrentBackgroundStyle();
            populateColorSwatches();

            try {
                // Assuming app-manifest.json now includes the compass app
                const response = await fetch('app-manifest.json');
                if (!response.ok) throw new Error(`Failed to load app-manifest.json: ${response.statusText}`);
                appManifest = await response.json();
            } catch (error) {
                console.error("Error loading app manifest:", error);
                alert("Could not load application list. Desktop might not function correctly.");
                return;
            }

            initDesktopIcons();
            restoreAllWindowStates();
            addEventListeners();

            window.addEventListener('message', handleIframeMessages);
        }

        // --- The following functions are included for completeness but are unchanged ---
        function initDesktopIcons() {
            DOM.desktop.innerHTML = '';
            appManifest.forEach((app, index) => {
                const iconElement = document.createElement('div');
                iconElement.className = 'desktop-icon';
                iconElement.id = `icon-${app.id}`;
                iconElement.dataset.appId = app.id;
                iconElement.title = `Open ${app.name}`;
                let iconHTML = `<div class="icon-image"><span>${app.icon}</span></div>`;
                if (app.customIconClass && app.id === 'playJockey') {
                    iconElement.classList.add(app.customIconClass);
                    iconHTML = `<div class="icon-image"><span class="icon-image-base">${app.icon}</span><span class="icon-image-overlay">${app.icon}</span></div>`;
                }
                iconElement.innerHTML = `${iconHTML}<div class="icon-label">${app.name}</div>`;
                const defaultX = 0;
                const defaultY = index * 100;
                if (osData.iconPositions && osData.iconPositions[app.id]) {
                    iconElement.style.left = osData.iconPositions[app.id].x + 'px';
                    iconElement.style.top = osData.iconPositions[app.id].y + 'px';
                } else {
                    const { x: finalX, y: finalY } = findNonCollidingPosition(iconElement, defaultX, defaultY);
                    iconElement.style.left = finalX + 'px';
                    iconElement.style.top = finalY + 'px';
                    if (!osData.iconPositions) osData.iconPositions = {};
                    osData.iconPositions[app.id] = { x: finalX, y: finalY };
                }
                iconElement.addEventListener('mousedown', handleIconMouseDown);
                iconElement.addEventListener('dblclick', handleIconDoubleClick);
                DOM.desktop.appendChild(iconElement);
            });
            saveOsData();
        }

        function handleIconMouseDown(e) {
            if (e.button !== 0 || activeDragWindow || activeResizeWindow) return;
            activeDragIcon = e.currentTarget;
            const appId = activeDragIcon.dataset.appId;
            const windowEl = getById(`window-${appId}`);
            if(windowEl && windowEl.style.display !== 'none' && !windowEl.classList.contains('minimized')) {
                 bringToFront(windowEl);
            }
            iconDragOffsetX = e.clientX - activeDragIcon.offsetLeft;
            iconDragOffsetY = e.clientY - activeDragIcon.offsetTop;
            activeDragIcon.style.cursor = 'grabbing';
            activeDragIcon.style.zIndex = (parseInt(activeDragIcon.style.zIndex) || 5) + highestZIndex + 1;
            document.addEventListener('mousemove', handleIconMouseMove);
            document.addEventListener('mouseup', handleIconMouseUp);
            e.preventDefault();
        }

        function handleIconMouseMove(e) {
            if (!activeDragIcon) return;
            let newX = e.clientX - iconDragOffsetX;
            let newY = e.clientY - iconDragOffsetY;
            const bodyRect = document.body.getBoundingClientRect();
            const iconWidth = activeDragIcon.offsetWidth || 90;
            const iconHeight = activeDragIcon.offsetHeight || 100;
            newX = Math.max(0, Math.min(newX, bodyRect.width - iconWidth));
            newY = Math.max(0, Math.min(newY, bodyRect.height - iconHeight));
            activeDragIcon.style.left = newX + 'px';
            activeDragIcon.style.top = newY + 'px';
        }

        function findNonCollidingPosition(draggedIcon, initialX, initialY) {
            let snappedX = Math.round(initialX / ICON_GRID_SIZE) * ICON_GRID_SIZE;
            let snappedY = Math.round(initialY / ICON_GRID_SIZE) * ICON_GRID_SIZE;
            return { x: snappedX, y: snappedY };
        }

        function handleIconMouseUp(e) {
            if (!activeDragIcon) return;
            activeDragIcon.style.zIndex = '5';
            let finalX = activeDragIcon.offsetLeft;
            let finalY = activeDragIcon.offsetTop;
            let snappedX = Math.round(finalX / ICON_GRID_SIZE) * ICON_GRID_SIZE;
            let snappedY = Math.round(finalY / ICON_GRID_SIZE) * ICON_GRID_SIZE;
            const iconWidth = activeDragIcon.offsetWidth || 90;
            const iconHeight = activeDragIcon.offsetHeight || 100;
            snappedX = Math.max(0, Math.min(snappedX, document.body.clientWidth - iconWidth));
            snappedY = Math.max(0, Math.min(snappedY, document.body.clientHeight - iconHeight));
            activeDragIcon.style.left = snappedX + 'px';
            activeDragIcon.style.top = snappedY + 'px';
            const appId = activeDragIcon.dataset.appId;
            if (!osData.iconPositions) osData.iconPositions = {};
            osData.iconPositions[appId] = { x: snappedX, y: snappedY };
            saveOsData();
            activeDragIcon.style.cursor = 'grab';
            activeDragIcon = null;
            document.removeEventListener('mousemove', handleIconMouseMove);
            document.removeEventListener('mouseup', handleIconMouseUp);
        }

        function handleIconDoubleClick(e) {
            const iconElement = e.currentTarget;
            const appId = iconElement.dataset.appId;
            const appConfig = appManifest.find(app => app.id === appId);
            if (appConfig) {
                openAppWindow(appConfig);
            }
        }

        function openAppWindow(appConfig) {
            const windowId = `window-${appConfig.id}`;
            let windowElement = getById(windowId);
            let state = osData.windowStates[appConfig.id];

            if (windowElement) {
                const iframe = windowElement.querySelector('iframe');
                if (state && state.hiddenByUser) {
                    windowElement.style.display = 'flex';
                    state.hiddenByUser = false;
                    if (iframe && !iframe.hasAttribute('src')) {
                        iframe.setAttribute('src', appConfig.file);
                    }
                }
                if (state && state.minimized) {
                     maximizeWindow(appConfig.id, appConfig);
                }
                bringToFront(windowElement);
                saveWindowState(appConfig.id);
                return windowElement;
            }

            highestZIndex++;
            windowElement = document.createElement('div');
            windowElement.className = 'xp-window';
            windowElement.id = windowId;
            windowElement.style.zIndex = highestZIndex;

            windowElement.innerHTML = `
                <div class="title-bar" id="title-bar-${appConfig.id}">
                    <span class="title-bar-text">${appConfig.name}</span>
                    <div class="title-bar-controls">
                        <button id="minimize-btn-${appConfig.id}" title="Minimize">0</button>
                        <button id="maximize-btn-${appConfig.id}" title="Maximize">1</button>
                        <button id="close-btn-${appConfig.id}" title="Close">r</button>
                    </div>
                </div>
                <div class="window-body" id="window-body-${appConfig.id}">
                    <iframe src="${appConfig.file}" id="iframe-${appConfig.id}" name="iframe-${appConfig.id}"></iframe>
                </div>
                <div class="resize-handle" id="resize-handle-${appConfig.id}"></div>
            `;
            DOM.desktop.appendChild(windowElement);

            const newIframe = windowElement.querySelector('iframe');
            newIframe.onload = () => {
                if (newIframe.contentWindow) {
                    sendApiKeyToApp(appConfig.id, newIframe.contentWindow);
                }
            };

            if (!state) {
                osData.windowStates[appConfig.id] = {};
                state = osData.windowStates[appConfig.id];
                setWindowDefaults(appConfig.id, false, appConfig);
            } else {
                if (state.maximized) {
                    windowElement.classList.add('true-maximized');
                    windowElement.style.width = '100vw'; windowElement.style.height = '100vh';
                    windowElement.style.top = '0px'; windowElement.style.left = '0px';
                } else if (state.minimized) {
                    windowElement.classList.add('minimized');
                } else if (state.width && state.height && state.x != null && state.y != null) {
                    windowElement.style.width = state.width + 'px'; windowElement.style.height = state.height + 'px';
                    windowElement.style.left = state.x + 'px'; windowElement.style.top = state.y + 'px';
                } else {
                    setWindowDefaults(appConfig.id, false, appConfig);
                }
            }
            state.hiddenByUser = false;

            initWindowInteractions(appConfig.id, appConfig);
            updateMinMaxButtonStates(appConfig.id);
            saveWindowState(appConfig.id);
            return windowElement;
        }

        function restoreAllWindowStates() {
            if (!osData.windowStates || !appManifest) return;
            appManifest.forEach(appConfig => {
                const state = osData.windowStates[appConfig.id];
                if (state && !state.hiddenByUser) {
                    const win = openAppWindow(appConfig);
                    if (win && state.zIndex) {
                        win.style.zIndex = state.zIndex;
                        highestZIndex = Math.max(highestZIndex, state.zIndex);
                    }
                }
            });
        }
        
        function initWindowInteractions(appId, appConfig) {
            const windowElement = getById(`window-${appId}`);
            const titleBarElement = getById(`title-bar-${appId}`);
            const resizeHandleElement = getById(`resize-handle-${appId}`);
            titleBarElement.addEventListener('mousedown', (e) => { if(!e.target.closest('button')) { activeDragWindow = windowElement; /*...*/ }});
            resizeHandleElement.addEventListener('mousedown', (e) => { activeResizeWindow = windowElement; /*...*/ });
            getById(`minimize-btn-${appId}`).addEventListener('click', () => minimizeWindow(appId));
            getById(`maximize-btn-${appId}`).addEventListener('click', () => maximizeWindow(appId, appConfig));
            getById(`close-btn-${appId}`).addEventListener('click', () => closeWindow(appId));
            windowElement.addEventListener('mousedown', () => bringToFront(windowElement));
        }
        function bringToFront(win) { highestZIndex++; win.style.zIndex = highestZIndex; saveWindowState(win.id.replace('window-','')); }
        function minimizeWindow(appId) { getById(`window-${appId}`).classList.add('minimized'); updateMinMaxButtonStates(appId); saveWindowState(appId); }
        function maximizeWindow(appId, appConfig) { getById(`window-${appId}`).classList.toggle('true-maximized', !getById(`window-${appId}`).classList.contains('true-maximized')); getById(`window-${appId}`).classList.remove('minimized'); updateMinMaxButtonStates(appId); saveWindowState(appId); }
        function closeWindow(appId) { getById(`window-${appId}`).style.display = 'none'; osData.windowStates[appId].hiddenByUser = true; saveWindowState(appId); }
        function updateMinMaxButtonStates(appId) { /* Logic to update buttons */ }
        function setWindowDefaults(appId, isResize, appConfig) { /* Logic to set default/saved position */ }
        function saveWindowState(appId) {
             const win = getById(`window-${appId}`); if (!win) return;
             let state = osData.windowStates[appId] || {};
             state.minimized = win.classList.contains('minimized');
             state.maximized = win.classList.contains('true-maximized');
             state.zIndex = parseInt(win.style.zIndex);
             state.hiddenByUser = win.style.display === 'none';
             if (!state.minimized && !state.maximized) {
                state.x = win.offsetLeft; state.y = win.offsetTop;
                state.width = win.offsetWidth; state.height = win.offsetHeight;
             }
             osData.windowStates[appId] = state;
             saveOsData();
        }
        function loadOsData() {
            const storedData = localStorage.getItem(OS_STORAGE_KEY);
            const defaultOsData = {
                windowStates: {}, iconPositions: {}, customBgImage: null, customBgColor: null,
                appApiKeys: { youtube: "", gemini: "", googleMaps: "" }
            };
            if(storedData) {
                try {
                    const parsed = JSON.parse(storedData);
                    osData = { ...defaultOsData, ...parsed };
                    osData.appApiKeys = { ...defaultOsData.appApiKeys, ...(parsed.appApiKeys || {})};
                } catch(e) { osData = defaultOsData; }
            } else { osData = defaultOsData; }
        }
        function saveOsData() { localStorage.setItem(OS_STORAGE_KEY, JSON.stringify(osData)); }
        function applyCurrentBackgroundStyle() { /* ... */ }
        function populateColorSwatches() { /* ... */ }
        function openModal(id) { getById(id).style.display = 'flex'; }
        function closeModal(id) { getById(id).style.display = 'none'; }
        function addEventListeners() { /* All other event listeners */ }
        
        // --- API Key Management ---
        function sendApiKeyToApp(appId, iframeContentWindow) {
            if (!iframeContentWindow) return;
            const appConfig = appManifest.find(app => app.id === appId);
            if (!appConfig || !appConfig.apiKeyService) return;

            const service = appConfig.apiKeyService;
            const key = osData.appApiKeys[service];

            if(service && key) {
                 iframeContentWindow.postMessage({ type: 'apiKeyResponse', service: service, key: key }, '*');
            }
        }
        
        // CORRECTED: This function now properly handles the 'googleMaps' service request.
        function handleIframeMessages(event) {
            const { type, service, appId } = event.data;
            if (type === 'requestApiKey' && appId && service) {
                const iframe = document.getElementById(`iframe-${appId}`);
                if (iframe && iframe.contentWindow) {
                    let keyToSend = osData.appApiKeys[service] || null;

                    if (keyToSend !== null) {
                         iframe.contentWindow.postMessage({ type: 'apiKeyResponse', service: service, key: keyToSend }, '*');
                         console.log(`OS: Sent '${service}' API key to app '${appId}'.`);
                    } else {
                         console.warn(`OS: API key for service '${service}' not available for app '${appId}'.`);
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', initOS);
    </script>
</body>
</html>
