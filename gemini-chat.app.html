<body data-app-id="geminiChat">

    <template id="geminiChat-icon-template">
        <div class="icon-image">âœ¨</div>
        <div class="icon-label">Gemini Chat</div>
    </template>

    <template id="geminiChat-window-template">
        <div class="xp-window" id="geminiChatWindow" style="display:none;">
            <div class="title-bar">
                <span class="title-bar-text">Gemini Chat</span>
                <div class="title-bar-controls">
                    <button data-app-action="minimize" title="Minimize">0</button>
                    <button data-app-action="maximize" title="Maximize">1</button>
                    <button data-app-action="close" title="Close">r</button>
                </div>
            </div>
            <div class="window-body" id="geminiChatWindowBody" style="padding:0;">
                <div style="display:flex; flex-direction:column; width:100%; height:100%; background-color:#ECE9D8; padding:0; box-sizing:border-box;">
                    <div style="display:flex; justify-content:flex-end; padding:3px 5px 0px 5px; background-color:#ECE9D8; flex-shrink:0;">
                        <button id="geminiChatClearHistoryBtn" class="xp-button" style="min-width:auto; padding:2px 8px; margin-bottom:3px; font-size:10px;">Clear History</button>
                    </div>
                    <div id="geminiChatDisplayArea" style="flex-grow:1; border:1px inset #7F7F7F; background-color:#FFFFFF; padding:8px; margin:5px; margin-top:0; overflow-y:auto; font-family:'Tahoma', Geneva, sans-serif; font-size:11px; line-height:1.4;">
                    </div>
                    <div style="display:flex; flex-shrink:0; padding:8px 5px 5px 5px; border-top:1px solid #ACA899; background-color:#ECE9D8;">
                        <textarea id="geminiChatPromptInput" placeholder="Type your message to Gemini..." rows="2" style="flex-grow:1; margin-right:5px; border:1px inset #7F7F7F; padding:6px; font-family:'Tahoma', Geneva, sans-serif; font-size:11px; background-color:#FFFFFF; resize:none; height:44px; box-sizing:border-box;"></textarea>
                        <button id="geminiChatSendBtn" class="xp-button" style="min-width:60px; padding:3px 8px; font-size:11px; height:44px; box-sizing:border-box;">Send</button>
                    </div>
                </div>
            </div>
            <div class="resize-handle"></div>
            <div id="geminiConfirmClearChatModal" class="modal"><div class="modal-content" style="max-width:400px"><div class="modal-title-bar"><span>Confirm Clear History</span><span class="close-button" data-modal-id="geminiConfirmClearChatModal">r</span></div><div class="modal-body"><p>Are you sure you want to clear the entire chat history? This action cannot be undone.</p></div><div class="modal-footer"><button id="geminiConfirmClearChatBtn" class="xp-button">Clear History</button><button class="xp-button" data-modal-id="geminiConfirmClearChatModal">Cancel</button></div></div></div>
        </div>
    </template>

    <script type="application/json" id="geminiChat-config">
    {
        "minWidth": 375,
        "minHeight": 250,
        "defaultWidth": 450,
        "defaultHeight": 705,
        "defaultOffsetX": 170,
        "defaultOffsetY": 170
    }
    </script>

    <script id="geminiChat-script">
    const appWindow = this.appWindow;
    const appData = this.appData;
    const os = this.os;

    let GEMINI_API_KEY = os.getGlobalConfig('GEMINI_API_KEY');
    const MAX_GEMINI_HISTORY_MESSAGES = 20;

    const DOM = {
        displayArea: appWindow.querySelector('#geminiChatDisplayArea'),
        promptInput: appWindow.querySelector('#geminiChatPromptInput'),
        sendBtn: appWindow.querySelector('#geminiChatSendBtn'),
        clearHistoryBtn: appWindow.querySelector('#geminiChatClearHistoryBtn'),
        confirmClearModal: appWindow.querySelector('#geminiConfirmClearChatModal'),
        confirmClearBtn: appWindow.querySelector('#geminiConfirmClearChatBtn'),
    };

    function initializeDefaultAppData() {
        if (!appData.history) appData.history = [];
    }
    initializeDefaultAppData();

    function renderHistory() {
        if (!DOM.displayArea) return;
        DOM.displayArea.innerHTML = '';
        const history = appData.history || [];
        history.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('gemini-chat-message'); // Generic class, specific styles below
            messageDiv.style.marginBottom = "8px";
            messageDiv.style.padding = "6px 8px";
            messageDiv.style.borderRadius = "3px";
            messageDiv.style.wordWrap = "break-word";
            messageDiv.style.whiteSpace = "pre-wrap";
            messageDiv.style.maxWidth = "80%";
            messageDiv.style.boxSizing = "border-box";

            const senderSpan = document.createElement('span');
            senderSpan.style.fontWeight = "bold";
            senderSpan.style.display = "block";
            senderSpan.style.marginBottom = "3px";
            senderSpan.style.fontSize = "10px";

            const contentSpan = document.createElement('span');
            // contentSpan.classList.add('message-content'); // Not strictly needed if styled directly

            const timestampSpan = document.createElement('span');
            timestampSpan.style.fontSize = "9px";
            timestampSpan.style.color = "#555";
            timestampSpan.style.display = "block";
            timestampSpan.style.marginTop = "4px";
            timestampSpan.textContent = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';


            if (msg.id && msg.id.startsWith('gemini-thinking-')) { 
                contentSpan.classList.add('gemini-thinking-animation'); // Add animation class
                contentSpan.style.animation = "geminiThinkingAnimation 1.5s infinite"; // CSS for animation
                contentSpan.setAttribute('data-thinking-text', 'Thinking'); // Base text
            } else {
                contentSpan.textContent = msg.content;
            }
            
            if (msg.type === 'user') {
                messageDiv.style.backgroundColor = "#E1EBF7";
                messageDiv.style.textAlign = "left";
                messageDiv.style.marginLeft = "auto";
                messageDiv.style.border = "1px solid #B4C9E2";
                senderSpan.textContent = 'You';
                senderSpan.style.color = "#0039A9";
                timestampSpan.style.textAlign = "right";
            } else if (msg.type === 'gemini') {
                messageDiv.style.backgroundColor = "#F0F0F0";
                messageDiv.style.textAlign = "left";
                messageDiv.style.marginRight = "auto";
                messageDiv.style.border = "1px solid #DCDCDC";
                senderSpan.textContent = 'Gemini';
                senderSpan.style.color = "#006400";
                timestampSpan.style.textAlign = "left";
                if (msg.isError) {
                    messageDiv.style.backgroundColor = "#FFDDDD";
                    messageDiv.style.color = "#D8000C";
                    messageDiv.style.border = "1px solid #FFB8B8";
                    senderSpan.style.color = "#990000";
                }
            }
            if (msg.id) messageDiv.id = msg.id;
            messageDiv.appendChild(senderSpan);
            messageDiv.appendChild(contentSpan);
            messageDiv.appendChild(timestampSpan);
            DOM.displayArea.appendChild(messageDiv);
        });
        DOM.displayArea.scrollTop = DOM.displayArea.scrollHeight;
    }
    
    // Add keyframes for thinking animation if not already present in a global scope
    if (!document.getElementById('geminiThinkingKeyframes')) {
        const styleSheet = document.createElement("style");
        styleSheet.id = "geminiThinkingKeyframes";
        styleSheet.innerText = `
            @keyframes geminiThinkingAnimation {
                0% { content: 'Thinking.'; }
                25% { content: 'Thinking..'; }
                50% { content: 'Thinking...'; }
                75% { content: 'Thinking..'; }
                100% { content: 'Thinking.'; }
            }
            .gemini-thinking-animation::after {
                content: attr(data-thinking-text); /* Use a base text if needed */
                animation: geminiThinkingAnimation 1.5s infinite;
                display: inline-block;
            }`;
        document.head.appendChild(styleSheet);
    }


    function addMessage(type, content, isError = false, messageId = null) {
        const newMessage = { type, content, isError, timestamp: new Date().toISOString() };
        if (messageId) newMessage.id = messageId;
        appData.history.push(newMessage);
        renderHistory();
        os.saveAppData();
    }
    function updateMessage(messageId, newContent, isError = false) {
        const msgIndex = appData.history.findIndex(m => m.id === messageId);
        if (msgIndex !== -1) {
            appData.history[msgIndex].content = newContent;
            appData.history[msgIndex].isError = isError;
            if (messageId.startsWith('gemini-thinking-')) delete appData.history[msgIndex].id; // Remove thinking ID
            renderHistory();
            os.saveAppData();
        }
    }

    async function handleSendPrompt() {
        const promptText = DOM.promptInput.value.trim();
        if (!promptText) return;
        addMessage('user', promptText);
        DOM.promptInput.value = '';
        DOM.promptInput.disabled = true; DOM.sendBtn.disabled = true;

        if (!GEMINI_API_KEY) {
            addMessage('gemini', "Error: Gemini API Key not configured.", true);
            DOM.promptInput.disabled = false; DOM.sendBtn.disabled = false; DOM.promptInput.focus();
            return;
        }
        const thinkingId = `gemini-thinking-${Date.now()}`;
        addMessage('gemini', '', false, thinkingId);
        
        const messagesToSend = appData.history.slice(-MAX_GEMINI_HISTORY_MESSAGES)
            .filter(msg => !msg.isError && msg.id !== thinkingId)
            .map(msg => ({ role: msg.type === 'user' ? 'user' : 'model', parts: [{ text: msg.content }] }));
        
        // Ensure the last message is the current user prompt if not already included
        if (messagesToSend.length === 0 || messagesToSend[messagesToSend.length-1].parts[0].text !== promptText) {
             messagesToSend.push({ role: 'user', parts: [{ text: promptText }] });
        }


        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: messagesToSend }),
            });
            if (!response.ok) {
                const errorData = await response.json();
                updateMessage(thinkingId, `Error: ${errorData?.error?.message || response.statusText}`, true);
            } else {
                const data = await response.json();
                if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                    updateMessage(thinkingId, data.candidates[0].content.parts[0].text, false);
                } else if (data.promptFeedback?.blockReason) {
                     updateMessage(thinkingId, `Blocked: ${data.promptFeedback.blockReason}. ${data.promptFeedback.blockReasonMessage || ''}`, true);
                } else {
                    updateMessage(thinkingId, "Empty or unexpected response from Gemini.", true);
                }
            }
        } catch (error) {
            updateMessage(thinkingId, `Error: Could not connect. ${error.message}`, true);
        } finally {
            DOM.promptInput.disabled = false; DOM.sendBtn.disabled = false; DOM.promptInput.focus();
        }
    }
    
    DOM.sendBtn.addEventListener('click', handleSendPrompt);
    DOM.promptInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendPrompt(); } });
    DOM.clearHistoryBtn.addEventListener('click', () => os.openModal(DOM.confirmClearModal));
    DOM.confirmClearBtn.addEventListener('click', () => {
        appData.history = []; renderHistory(); os.saveAppData(); os.closeModal(DOM.confirmClearModal);
    });
    
    appWindow.querySelectorAll('.modal .close-button, .modal .xp-button[data-modal-id]').forEach(button => {
        button.addEventListener('click', (event) => {
            const modalId = event.target.dataset.modalId || event.target.closest('.modal').id;
            if (modalId) os.closeModal(appWindow.querySelector('#'+modalId));
        });
    });

    this.onOpen = (win) => {
        GEMINI_API_KEY = os.getGlobalConfig('GEMINI_API_KEY');
        renderHistory();
        DOM.promptInput.focus();
    };
    
    renderHistory(); // Initial render
    </script>
</body>
