<div class="desktop-icon" id="geminiChatIcon" data-window-id="geminiChatWindow">
    <div class="icon-image">âœ¨</div>
    <div class="icon-label">Gemini Chat</div>
</div>

<div class="xp-window" id="geminiChatWindow">
    <div class="title-bar" id="geminiChatWindowTitleBar">
        <span class="title-bar-text">Gemini Chat</span>
        <div class="title-bar-controls">
            <button id="geminiChatMinimizeBtn" title="Minimize">0</button>
            <button id="geminiChatMaximizeBtn" title="Maximize">1</button>
            <button title="Close" id="geminiChatCloseBtn">r</button>
        </div>
    </div>
    <div class="window-body" id="geminiChatWindowBody">
        <div class="gemini-chat-body-container">
            <div class="gemini-chat-controls-bar">
                <button id="geminiChatClearHistoryBtn" class="xp-button xp-button-small">Clear History</button>
            </div>
            <div class="gemini-chat-display-area" id="geminiChatDisplayArea">
                </div>
            <div class="gemini-chat-input-area">
                <textarea id="geminiChatPromptInput" placeholder="Type your message to Gemini..." rows="2"></textarea>
                <button id="geminiChatSendBtn" class="xp-button">Send</button>
            </div>
        </div>
    </div>
    <div class="resize-handle" id="geminiChatResizeHandle"></div>
</div>

<div id="confirmClearChatModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-title-bar">
            <span>Confirm Clear History</span>
            <span class="close-button" data-modal-id="confirmClearChatModal">r</span>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to clear the entire chat history? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button id="confirmClearChatBtn" class="xp-button">Clear History</button>
            <button class="xp-button" data-modal-id="confirmClearChatModal">Cancel</button>
        </div>
    </div>
</div>

<style>
    /* Gemini Chat Specific Styles */
    #geminiChatWindow .window-body { padding: 0; }
    .gemini-chat-body-container { display: flex; flex-direction: column; width: 100%; height: 100%; background-color: #ECE9D8; padding: 0; box-sizing: border-box; }
    .gemini-chat-controls-bar { display: flex; justify-content: flex-end; padding: 3px 5px 0px 5px; background-color: #ECE9D8; flex-shrink: 0; }
    #geminiChatClearHistoryBtn { min-width: auto; padding: 2px 8px; margin-bottom: 3px; }
    .gemini-chat-display-area { flex-grow: 1; border: 1px inset #7F7F7F; background-color: #FFFFFF; padding: 8px; margin: 5px; margin-top: 0; overflow-y: auto; font-family: "Tahoma", "Geneva", sans-serif; font-size: 11px; line-height: 1.4; }
    .gemini-chat-message { margin-bottom: 8px; padding: 6px 8px; border-radius: 3px; word-wrap: break-word; white-space: pre-wrap; max-width: 80%; box-sizing: border-box; }
    .gemini-chat-message .message-sender { font-weight: bold; display: block; margin-bottom: 3px; font-size: 10px; }
    .gemini-chat-message .message-timestamp { font-size: 9px; color: #555; display: block; margin-top: 4px; text-align: inherit; }
    .gemini-chat-message.user-message { background-color: #E1EBF7; text-align: left; margin-left: auto; border: 1px solid #B4C9E2; }
    .gemini-chat-message.user-message .message-sender { color: #0039A9; }
    .gemini-chat-message.gemini-message { background-color: #F0F0F0; text-align: left; margin-right: auto; border: 1px solid #DCDCDC; }
    .gemini-chat-message.gemini-message .message-sender { color: #006400; }
    .gemini-chat-message.gemini-message.error-message { background-color: #FFDDDD; color: #D8000C; border: 1px solid #FFB8B8; }
    .gemini-chat-message.gemini-message.error-message .message-sender { color: #990000; }
    @keyframes thinking { 0% { content: 'Thinking.'; } 25% { content: 'Thinking..'; } 50% { content: 'Thinking...'; } 75% { content: 'Thinking..'; } 100% { content: 'Thinking.'; } }
    .gemini-thinking-animation::after { content: '...';  animation: thinking 1.5s infinite; display: inline-block;  }
    .gemini-chat-input-area { display: flex; flex-shrink: 0; padding: 8px 5px 5px 5px; border-top: 1px solid #ACA899; background-color: #ECE9D8; }
    #geminiChatPromptInput { flex-grow: 1; margin-right: 5px; border: 1px inset #7F7F7F; padding: 6px; font-family: "Tahoma", "Geneva", sans-serif; font-size: 11px; background-color: #FFFFFF; resize: none; height: 44px; box-sizing: border-box; }
    #geminiChatSendBtn { min-width: 60px; padding: 3px 8px; font-size: 11px; height: 44px; box-sizing: border-box; }
    .xp-button.xp-button-small { padding: 2px 5px; font-size: 10px; min-width: auto; margin: 0 2px;}
</style>

<script>
(function() {
    const APP_ID = 'geminiChatWindow';
    const STORAGE_KEY_APP = `app_${APP_ID}_data_v1.0`;
    const MIN_APP_WIDTH = 375;
    const MIN_APP_HEIGHT = 250;
    const DEFAULT_APP_WIDTH = 450;
    const DEFAULT_APP_HEIGHT = 705;
    const MAX_GEMINI_HISTORY_MESSAGES_APP = 20;

    const MODAL_IDS_APP = {
        CONFIRM_CLEAR_CHAT: 'confirmClearChatModal'
    };

    const DOM_APP = {};
    let appData = {};

    function getAppById(id) { return document.getElementById(id); }

    function saveAppData_GeminiChat() {
        const win = DOM_APP.geminiChatWindow;
        if (!win) return;
        let currentOsData = window.osData.windowStates[APP_ID] || {};
        const stateToSave = {
            appSpecific: {
                geminiChatHistory: appData.geminiChatHistory,
            },
            windowGeneric: {
                x: win.offsetLeft, y: win.offsetTop, width: win.offsetWidth, height: win.offsetHeight,
                minimized: win.classList.contains('minimized'), maximized: win.classList.contains('true-maximized'),
                zIndex: parseInt(win.style.zIndex) || currentOsData.zIndex || window.highestZIndex,
                hiddenByUser: win.style.display === 'none', userManuallySet: currentOsData.userManuallySet || false,
                wasMaximizedBeforeMinimize: currentOsData.wasMaximizedBeforeMinimize || false
            }
        };
         if(stateToSave.windowGeneric.minimized || stateToSave.windowGeneric.maximized){
            if(window.osData.lastNormalStates[APP_ID]){
                stateToSave.windowGeneric.x = parseInt(window.osData.lastNormalStates[APP_ID].left);
                stateToSave.windowGeneric.y = parseInt(window.osData.lastNormalStates[APP_ID].top);
                stateToSave.windowGeneric.width = parseInt(window.osData.lastNormalStates[APP_ID].width);
                stateToSave.windowGeneric.height = parseInt(window.osData.lastNormalStates[APP_ID].height);
            } else if (currentOsData.x != null) {
                 stateToSave.windowGeneric.x = currentOsData.x;
                 stateToSave.windowGeneric.y = currentOsData.y;
                 stateToSave.windowGeneric.width = currentOsData.width;
                 stateToSave.windowGeneric.height = currentOsData.height;
            }
        }
        localStorage.setItem(STORAGE_KEY_APP, JSON.stringify(stateToSave));
        window.osData.windowStates[APP_ID] = stateToSave.windowGeneric;
    }
    window.saveAppData[APP_ID] = saveAppData_GeminiChat;
    
    function loadAppData_GeminiChat() {
        const storedData = localStorage.getItem(STORAGE_KEY_APP);
        const defaultAppData = { geminiChatHistory: [] };
        const defaultWindowState = {
             x: null, y: null, width: DEFAULT_APP_WIDTH, height: DEFAULT_APP_HEIGHT, 
             maximized: false, minimized: false, zIndex: window.highestZIndex + 1, 
             userManuallySet: false, hiddenByUser: true, wasMaximizedBeforeMinimize: false
        };

        if (storedData) {
            try {
                const loaded = JSON.parse(storedData);
                appData = { ...defaultAppData, ...(loaded.appSpecific || {}) };
                window.osData.windowStates[APP_ID] = { ...defaultWindowState, ...(loaded.windowGeneric || {}) };
            } catch (e) {
                appData = { ...defaultAppData };
                 window.osData.windowStates[APP_ID] = { ...defaultWindowState };
            }
        } else {
            appData = { ...defaultAppData };
            window.osData.windowStates[APP_ID] = { ...defaultWindowState };
        }
    }

    function restoreAppWindowState_GeminiChat(forceVisible = false) {
        const win = DOM_APP.geminiChatWindow;
        if (!win) return;
        let state = window.osData.windowStates[APP_ID] || {};
        const defaultState = {
             x: (window.innerWidth - DEFAULT_APP_WIDTH)/2, y: (window.innerHeight - DEFAULT_APP_HEIGHT)/2, 
             width: DEFAULT_APP_WIDTH, height: DEFAULT_APP_HEIGHT, 
             maximized: false, minimized: false, zIndex: window.highestZIndex +1, 
             userManuallySet: false, hiddenByUser: true, wasMaximizedBeforeMinimize: false
        };
        state = {...defaultState, ...state};
        
        if (forceVisible) {
            state.hiddenByUser = false;
            state.minimized = false;
        }

        if (state.hiddenByUser && !forceVisible) {
            win.style.display = 'none';
        } else {
            win.style.display = 'flex';
            renderGeminiChatHistory_App();
        }
        win.style.zIndex = state.zIndex || (window.highestZIndex + 1);
        window.highestZIndex = Math.max(window.highestZIndex, parseInt(win.style.zIndex));

        if (state.minimized && !forceVisible) {
            win.classList.add('minimized'); win.classList.remove('true-maximized');
        } else if (state.maximized) {
            win.classList.add('true-maximized'); win.classList.remove('minimized');
            win.style.width = '100vw'; win.style.height = '100vh';
            win.style.top = '0px'; win.style.left = '0px';
            window.osData.lastNormalStates[APP_ID] = {
                width: (state.width ? Math.max(MIN_APP_WIDTH, state.width) : DEFAULT_APP_WIDTH) + 'px',
                height: (state.height ? Math.max(MIN_APP_HEIGHT, state.height) : DEFAULT_APP_HEIGHT) + 'px',
                top: (state.y != null ? state.y : defaultState.y) + 'px',
                left: (state.x != null ? state.x : defaultState.x) + 'px'
            };
        } else {
            win.classList.remove('minimized'); win.classList.remove('true-maximized');
            if (state.userManuallySet && state.width != null && state.height != null && state.x != null && state.y != null) {
                win.style.left = state.x + 'px'; win.style.top = state.y + 'px';
                win.style.width = Math.max(MIN_APP_WIDTH, state.width) + 'px';
                win.style.height = Math.max(MIN_APP_HEIGHT, state.height) + 'px';
            } else {
                 window.setWindowDefaults(APP_ID, DEFAULT_APP_WIDTH, DEFAULT_APP_HEIGHT, MIN_APP_WIDTH, MIN_APP_HEIGHT, false);
            }
        }
         window.updateMinMaxButtonStates_OS(APP_ID);
    }
    window.restoreAppWindowState[APP_ID] = restoreAppWindowState_GeminiChat;
    window.onAppOpen[APP_ID] = () => { renderGeminiChatHistory_App(); };


    function renderGeminiChatHistory_App() {
        if (!DOM_APP.geminiChatDisplayArea) return;
        DOM_APP.geminiChatDisplayArea.innerHTML = '';
        const history = appData.geminiChatHistory || [];
        history.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('gemini-chat-message');
            const senderSpan = document.createElement('span');
            senderSpan.classList.add('message-sender');
            const contentSpan = document.createElement('span');
            contentSpan.classList.add('message-content');
            if (msg.id && msg.id.startsWith('gemini-thinking-')) { 
                contentSpan.classList.add('gemini-thinking-animation'); 
                contentSpan.textContent = ''; 
            } else {
                contentSpan.textContent = msg.content;
            }
            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('message-timestamp');
            timestampSpan.textContent = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            if (msg.type === 'user') {
                messageDiv.classList.add('user-message');
                senderSpan.textContent = 'You';
            } else if (msg.type === 'gemini') {
                messageDiv.classList.add('gemini-message');
                senderSpan.textContent = 'Gemini';
                if (msg.isError) messageDiv.classList.add('error-message');
            }
            if (msg.id) messageDiv.id = msg.id;
            messageDiv.appendChild(senderSpan);
            messageDiv.appendChild(contentSpan);
            messageDiv.appendChild(timestampSpan);
            DOM_APP.geminiChatDisplayArea.appendChild(messageDiv);
        });
        DOM_APP.geminiChatDisplayArea.scrollTop = DOM_APP.geminiChatDisplayArea.scrollHeight;
    }
    function addMessageToGeminiChat_App(type, content, isError = false, messageId = null) {
        if (!appData.geminiChatHistory) appData.geminiChatHistory = [];
        const newMessage = { type: type, content: content, isError: isError, timestamp: new Date().toISOString() };
        if (messageId) newMessage.id = messageId;
        appData.geminiChatHistory.push(newMessage);
        renderGeminiChatHistory_App();
        saveAppData_GeminiChat();
    }
    function updateGeminiChatMessage_App(messageId, newContent, isError = false) {
        if (!appData.geminiChatHistory) return;
        const messageIndex = appData.geminiChatHistory.findIndex(msg => msg.id === messageId);
        if (messageIndex !== -1) {
            appData.geminiChatHistory[messageIndex].content = newContent;
            appData.geminiChatHistory[messageIndex].isError = isError;
            if (messageId.startsWith('gemini-thinking-')) delete appData.geminiChatHistory[messageIndex].id;
            renderGeminiChatHistory_App();
            saveAppData_GeminiChat();
        }
    }
    function handleClearGeminiChatHistory_App() {
        window.openModal_OS(MODAL_IDS_APP.CONFIRM_CLEAR_CHAT);
    }
    function confirmClearChat_App() {
        appData.geminiChatHistory = [];
        renderGeminiChatHistory_App();
        saveAppData_GeminiChat();
        window.closeModal_OS(MODAL_IDS_APP.CONFIRM_CLEAR_CHAT);
    }
    async function handleSendGeminiPrompt_App() {
        const promptText = DOM_APP.geminiChatPromptInput.value.trim();
        if (!promptText) return;
        addMessageToGeminiChat_App('user', promptText);
        DOM_APP.geminiChatPromptInput.value = '';
        DOM_APP.geminiChatPromptInput.disabled = true;
        DOM_APP.geminiChatSendBtn.disabled = true;
        if (!window.GEMINI_API_KEY) {
            addMessageToGeminiChat_App('gemini', "Error: Gemini API Key is not configured.", true);
            DOM_APP.geminiChatPromptInput.disabled = false; DOM_APP.geminiChatSendBtn.disabled = false; DOM_APP.geminiChatPromptInput.focus();
            return;
        }
        const thinkingMsgId = `gemini-thinking-${Date.now()}`;
        addMessageToGeminiChat_App('gemini', '', false, thinkingMsgId); 
        const messagesToSend = [];
        const recentHistory = appData.geminiChatHistory.slice(-MAX_GEMINI_HISTORY_MESSAGES_APP);
        recentHistory.forEach(msg => {
            if (!msg.isError && msg.id !== thinkingMsgId) { 
                messagesToSend.push({ role: msg.type === 'user' ? 'user' : 'model', parts: [{ text: msg.content }] });
            }
        });
        if (messagesToSend.length === 0 || messagesToSend[messagesToSend.length -1].role !== 'user' || messagesToSend[messagesToSend.length -1].parts[0].text !== promptText) {
             messagesToSend.push({ role: 'user', parts: [{ text: promptText }] });
        }
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${window.GEMINI_API_KEY}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: messagesToSend }),
            });
            if (!response.ok) {
                const errorData = await response.json();
                const errorMessage = errorData?.error?.message || `API request failed with status ${response.status}`;
                updateGeminiChatMessage_App(thinkingMsgId, `Error: ${errorMessage}`, true);
            } else {
                const data = await response.json();
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]) {
                    updateGeminiChatMessage_App(thinkingMsgId, data.candidates[0].content.parts[0].text, false);
                } else if (data.promptFeedback?.blockReason) {
                     updateGeminiChatMessage_App(thinkingMsgId, `Blocked: ${data.promptFeedback.blockReason}. ${data.promptFeedback.blockReasonMessage || ''}`, true);
                } else {
                    updateGeminiChatMessage_App(thinkingMsgId, "Received an empty or unexpected response from Gemini.", true);
                }
            }
        } catch (error) {
            updateGeminiChatMessage_App(thinkingMsgId, `Error: Could not connect to Gemini. ${error.message}`, true);
        } finally {
            DOM_APP.geminiChatPromptInput.disabled = false; DOM_APP.geminiChatSendBtn.disabled = false; DOM_APP.geminiChatPromptInput.focus();
        }
    }

    function initAppEventListeners_GeminiChat() {
        DOM_APP.geminiChatSendBtn.addEventListener('click', handleSendGeminiPrompt_App);
        DOM_APP.geminiChatPromptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendGeminiPrompt_App(); }
        });
        DOM_APP.geminiChatClearHistoryBtn.addEventListener('click', handleClearGeminiChatHistory_App);
        DOM_APP.confirmClearChatBtn.addEventListener('click', confirmClearChat_App);

        DOM_APP.geminiChatMinimizeBtn.addEventListener('click', () => window.minimizeAppWindow(APP_ID));
        DOM_APP.geminiChatMaximizeBtn.addEventListener('click', () => window.maximizeAppWindowGlobal[APP_ID]());
        DOM_APP.geminiChatCloseBtn.addEventListener('click', () => window.closeAppWindow(APP_ID));
        
        DOM_APP.appModalCloseButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const modalId = event.target.dataset.modalId || event.target.closest('.modal').id;
                if (modalId) window.closeModal_OS(modalId);
            });
        });
    }

    function init_GeminiChat() {
        const fields = [
            'geminiChatWindow', 'geminiChatWindowTitleBar', 'geminiChatResizeHandle',
            'geminiChatMinimizeBtn', 'geminiChatMaximizeBtn', 'geminiChatCloseBtn',
            'geminiChatDisplayArea', 'geminiChatPromptInput', 'geminiChatSendBtn', 'geminiChatClearHistoryBtn',
            'confirmClearChatModal', 'confirmClearChatBtn'
        ];
        fields.forEach(field => DOM_APP[field] = getAppById(field));
        DOM_APP.appModalCloseButtons = document.querySelectorAll(`#${MODAL_IDS_APP.CONFIRM_CLEAR_CHAT} .close-button, #${MODAL_IDS_APP.CONFIRM_CLEAR_CHAT} .xp-button[data-modal-id]`);

        window.appData[APP_ID] = appData;
        window.appInitialConfig[APP_ID] = {
            id: APP_ID,
            defaultWidth: DEFAULT_APP_WIDTH, defaultHeight: DEFAULT_APP_HEIGHT,
            minWidth: MIN_APP_WIDTH, minHeight: MIN_APP_HEIGHT,
            titleBarId: 'geminiChatWindowTitleBar', resizeHandleId: 'geminiChatResizeHandle'
        };
        window.maximizeAppWindowGlobal[APP_ID] = () => window.maximizeAppWindow(APP_ID, MIN_APP_WIDTH, MIN_APP_HEIGHT, DEFAULT_APP_WIDTH, DEFAULT_APP_HEIGHT);

        loadAppData_GeminiChat();
        window.initWindowInteractions(APP_ID, 'geminiChatWindowTitleBar', 'geminiChatResizeHandle', MIN_APP_WIDTH, MIN_APP_HEIGHT);
        restoreAppWindowState_GeminiChat(); 
        initAppEventListeners_GeminiChat();
    }
    init_GeminiChat();
})();
</script>