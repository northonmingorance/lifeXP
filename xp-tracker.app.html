<style>
    body { 
        margin: 0; 
        padding: 0; 
        font-family: "Tahoma", "Geneva", sans-serif; 
        font-size: 11px; 
        background-color: #ECE9D8; 
        display: flex; 
        flex-direction: column; 
        height: 100vh; 
        overflow-x: auto; /* Allow horizontal scrolling for the iframe body */
        overflow-y: hidden; /* Prevent vertical scroll on body, table-container will handle it */
    }
    .xp-button { background-color: #ECE9D8; border: 1px outset #7F7F7F; padding: 5px 12px; min-width: 75px; text-align: center; cursor: pointer; margin: 2px; }
    .xp-button:active { border-style: inset; }
    .xp-button:hover { border-color: #005CFE; }
    .xp-button-small { padding: 2px 5px; font-size: 10px; min-width: auto; margin: 0 2px;}
    .xp-button:disabled { color: #7F7F7F; border-color: #ACA899; cursor: default; }

    .controls-bar { display: flex; margin-bottom: 15px; padding: 8px; border: 1px solid #ACA899; background-color: #F0F0F0; flex-shrink: 0; }
    .controls-bar.layout-single-row { flex-direction: row; justify-content: space-between; align-items: center; flex-wrap: nowrap; }
    .controls-bar.layout-single-row > div { margin: 2px 5px; flex-shrink: 0; }
    .controls-bar.layout-multi-row { flex-direction: column; align-items: stretch; }
    .controls-bar.layout-multi-row > div { width: 100%; box-sizing: border-box; margin-bottom: 8px; display: flex; justify-content: center; flex-wrap: wrap; padding: 5px 0; }
    .controls-bar.layout-multi-row > div:last-child { margin-bottom: 0; }
    .controls-bar.layout-multi-row .controls-group { text-align: center; }
    .week-navigation { display: flex; align-items: center; flex-wrap: wrap; justify-content: center; }
    .week-navigation button { margin: 0 3px; }
    .controls-group { display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 10px; text-align: center; }
    #currentWeekDisplay { font-weight: bold; }
    #weekCountDisplay { font-size: 0.9em; color: #333; }
    .global-actions { display: flex; align-items: center; flex-wrap: wrap; justify-content: center; }
    
    .table-container { 
        flex-grow: 1; 
        overflow-y: auto; 
        overflow-x: auto; /* Changed to auto for internal scroll if table is wider than container */
        padding: 0 15px 15px 15px;
    }
    table { 
        width: 100%; 
        border-collapse: collapse; /* Keep collapse for overall look */
        table-layout: fixed; 
    }
    th, td { 
        border: 1px solid #ACA899; 
        padding: 8px; 
        text-align: left; 
        vertical-align: top; 
        word-wrap: break-word; 
        background-clip: padding-box; /* Helps with sticky borders */
    }
    th { 
        background-color: #D4D0C8; 
        text-align: center; 
        position: sticky; 
        top: 0; 
        z-index: 10; 
        /* Ensure borders are part of the sticky element's paint layer */
        border-bottom: 1px solid #7F7F7F; /* Darker bottom border for emphasis */
    }
    #weekdayHeaders th:first-child { /* Specifically target the "Area" header */
        position: sticky;
        left: 0;
        z-index: 11; /* Higher than other th and td.area-name-cell */
        background-color: #D4D0C8; /* Match other headers */
        border-right: 1px solid #7F7F7F; /* Ensure right border is distinct */
    }
    td.area-name-cell { 
        font-weight: bold; 
        width: 180px; 
        position: sticky; 
        left: 0;
        background-color: #ECE9D8; 
        z-index: 5; 
        border-right: 1px solid #7F7F7F; /* Darker right border for emphasis */
    }
    .area-stats { font-size: 0.9em; margin-top: 5px; color: #333; }
    .area-stats span { display: flex; align-items: center; } 
    .area-level { margin-left: 4px; } 
    .xp-bar-container { width: 100%; height: 12px; background-color: #BDBDBD; border: 1px solid #7F7F7F; margin-top: 3px; position: relative; border-radius: 2px; overflow: hidden; }
    .xp-bar { height: 100%; background-color: #008000; transition: width 0.3s ease; border-radius: 1px; }
    .xp-bar-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 9px; line-height: 12px; color: white; text-shadow: 1px 1px 0px black; font-weight: bold; z-index: 1; }
    .achievement-item { background-color: #FFF; border: 1px solid #DDD; padding: 8px; margin-bottom: 4px; font-size: 0.9em; border-radius: 3px; word-wrap: break-word; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
    .achievement-content { width: 100%; text-align: center; margin-bottom: 8px; }
    .achievement-content img { max-width: 100%; height: auto; display: block; margin-left: auto; margin-right: auto; margin-top: 0px; border-radius: 2px; }
    .achievement-item-actions { display: flex; gap: 3px; }
    .achievement-add-btn-cell {
        display: block; 
        width: 30px;  
        height: 22px; 
        padding: 0;   
        margin: 5px auto 0 auto; 
        line-height: 20px; 
        text-align: center; 
        font-size: 14px; 
    }
    .area-name-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .delete-area-btn { padding: 1px 6px; min-width: auto; font-size: 10px; font-family: "Tahoma", "Geneva", sans-serif; font-weight: bold; margin-left: 10px; background-color: #E04343; color: white; border: 1px outset white; line-height: 1.2; cursor: pointer; }
    .delete-area-btn:hover { background-color: #FF6363; }
    .delete-area-btn:active { border-style: inset; }

    /* Modal Styles */
    .xp-tracker-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
    .xp-tracker-modal-content { background-color: #ECE9D8; margin: auto; padding: 0; border: 1px solid #000; width: 80%; box-shadow: 5px 5px 15px rgba(0,0,0,0.5); animation: xpTrackerFadeIn 0.3s; display: flex; flex-direction: column; }
    .xp-tracker-modal-title-bar { background: linear-gradient(to bottom, #005CFE, #0039A9); color: white; padding: 5px 8px; font-weight: bold; border-bottom: 1px solid #000; display: flex; justify-content: space-between; align-items: center; height: 28px; box-sizing: border-box; flex-shrink: 0; }
    .xp-tracker-modal-close-button { color: white; font-size: 16px; font-family: "Marlett", "Webdings", sans-serif; font-weight: normal; background: #E04343; border: 1px outset white; width: 22px; height: 18px; text-align: center; line-height: 16px; padding: 0; cursor: pointer; }
    .xp-tracker-modal-close-button:hover, .xp-tracker-modal-close-button:focus { background: #FF6363; }
    .xp-tracker-modal-close-button:active { border-style: inset; }
    .xp-tracker-modal-body { padding: 15px; overflow-y: auto; flex-grow: 1; }
    .xp-tracker-modal-body p { margin-top: 0; margin-bottom: 10px; }
    .xp-tracker-modal-body label { display: block; margin-bottom: 5px; margin-top: 12px; }
    .xp-tracker-modal-body input[type="text"], .xp-tracker-modal-body input[type="number"], .xp-tracker-modal-body textarea, .xp-tracker-modal-body select, .xp-tracker-modal-body input[type="file"] { width: calc(100% - 12px); padding: 5px; margin-bottom: 10px; border: 1px solid #ACA899; box-sizing: border-box; }
    .xp-tracker-modal-footer { padding: 10px 15px; text-align: right; background-color: #F0F0F0; border-top: 1px solid #ACA899; flex-shrink: 0; }
    @keyframes xpTrackerFadeIn { from {opacity: 0; transform: scale(0.9);} to {opacity: 1; transform: scale(1);} }
    .quest-item { padding: 8px; border: 1px solid #ACA899; margin-bottom: 8px; background-color: #FFF; border-radius: 3px; position: relative; }
    .quest-item label { margin-left: 8px; }
    .quest-item.completed { background-color: #DFF0D8; text-decoration: line-through; color: #508a50; }
    .quest-item.completed .quest-title { color: #006400; }
    .quest-title { font-weight: bold; margin-bottom: 5px; color: #0039A9; }
    .quest-details { font-size: 0.95em; margin-bottom: 3px; }
    .quest-progress { font-size: 0.85em; color: #555; margin-top: 3px; margin-bottom: 25px; }
    .quest-actions { position: absolute; bottom: 5px; right: 5px; }
</style>
</head>
<body>
<div class="controls-bar" id="controlsBar">
    <div class="week-navigation">
        <button id="prevWeekBtn" class="xp-button">&lt; Prev Week</button>
        <button id="thisWeekBtn" class="xp-button">This Week</button>
        <button id="nextWeekBtn" class="xp-button">Next Week &gt;</button>
    </div>
    <div class="controls-group">
        <span id="currentWeekDisplay">Week X</span>
        <span id="weekCountDisplay">Year Week: XX</span>
    </div>
    <div class="global-actions">
        <button id="toggleViewBtn" class="xp-button">Day View</button>
        <button id="showQuestsBtn" class="xp-button">Weekly Quests</button>
        <button id="addAreaBtn" class="xp-button">New Area</button>
    </div>
</div>
<div class="table-container">
    <table id="gridTable">
        <thead>
            <tr id="weekdayHeaders">
                <th>Area</th>
            </tr>
        </thead>
        <tbody id="gridBody">
        </tbody>
    </table>
</div>

<!-- Modals -->
<div id="xpNewAreaModal" class="xp-tracker-modal">
    <div class="xp-tracker-modal-content" style="max-width: 400px;">
        <div class="xp-tracker-modal-title-bar">
            <span>Create New Area</span>
            <span class="xp-tracker-modal-close-button" data-modal-id="xpNewAreaModal">r</span>
        </div>
        <div class="xp-tracker-modal-body">
            <label for="xpNewAreaNameInput">Area Name:</label>
            <input type="text" id="xpNewAreaNameInput" placeholder="e.g., Fitness, Learning">
        </div>
        <div class="xp-tracker-modal-footer">
            <button id="xpSaveNewAreaBtn" class="xp-button">Save</button>
            <button class="xp-button xp-tracker-modal-cancel-btn" data-modal-id="xpNewAreaModal">Cancel</button>
        </div>
    </div>
</div>

<div id="xpAddEditAchievementModal" class="xp-tracker-modal">
    <div class="xp-tracker-modal-content" style="max-width: 450px;">
        <div class="xp-tracker-modal-title-bar">
            <span id="xpAddEditAchievementModalTitle">Add Achievement</span>
            <span class="xp-tracker-modal-close-button" data-modal-id="xpAddEditAchievementModal">r</span>
        </div>
        <div class="xp-tracker-modal-body">
            <input type="hidden" id="xpAchievementAreaNameInput">
            <input type="hidden" id="xpAchievementDayIndexInput">
            <input type="hidden" id="xpEditingAchievementKeyInput">
            <input type="hidden" id="xpEditingAchievementIdInput">
            <label>Type:</label>
            <input type="radio" name="xpAchievementType" value="text" id="xpTypeText" checked> Text
            <input type="radio" name="xpAchievementType" value="image" id="xpTypeImage"> Image
            <br><br>
            <div id="xpTextInputDiv">
                <label for="xpAchievementTextInput">Description:</label>
                <textarea id="xpAchievementTextInput" rows="3"></textarea>
            </div>
            <div id="xpImageInputDiv" style="display:none;">
                <label for="xpAchievementImageInput">Upload Image:</label>
                <input type="file" id="xpAchievementImageInput" accept="image/*">
                <p><small>Current image will be kept if no new image is selected during edit.</small></p>
            </div>
        </div>
        <div class="xp-tracker-modal-footer">
            <button id="xpSaveAchievementBtn" class="xp-button">Save Achievement</button>
            <button class="xp-button xp-tracker-modal-cancel-btn" data-modal-id="xpAddEditAchievementModal">Cancel</button>
        </div>
    </div>
</div>

<div id="xpQuestsModal" class="xp-tracker-modal">
    <div class="xp-tracker-modal-content" style="max-width: 550px;">
        <div class="xp-tracker-modal-title-bar">
            <span>Weekly Quests</span>
            <span class="xp-tracker-modal-close-button" data-modal-id="xpQuestsModal">r</span>
        </div>
        <div class="xp-tracker-modal-body" id="xpQuestsListBody">
            </div>
        <div class="xp-tracker-modal-footer">
            <button id="xpAddQuestBtn" class="xp-button">Create New Quest</button>
            <button class="xp-button xp-tracker-modal-cancel-btn" data-modal-id="xpQuestsModal">Close</button>
        </div>
    </div>
</div>

<div id="xpCreateQuestModal" class="xp-tracker-modal">
    <div class="xp-tracker-modal-content" style="max-width: 450px;">
        <div class="xp-tracker-modal-title-bar">
            <span>Create New Quest</span>
            <span class="xp-tracker-modal-close-button" data-modal-id="xpCreateQuestModal">r</span>
        </div>
        <div class="xp-tracker-modal-body">
            <label for="xpNewQuestAreaNameSelect">Area:</label>
            <select id="xpNewQuestAreaNameSelect"></select>
            <label for="xpNewQuestDescriptionInput">Description:</label>
            <textarea id="xpNewQuestDescriptionInput" rows="2" placeholder="e.g., Read 2 chapters"></textarea>
            <label for="xpNewQuestTargetXPInput">Target XP to Earn in Area for Quest:</label>
            <input type="number" id="xpNewQuestTargetXPInput" min="1" value="30">
            <label for="xpNewQuestRewardXPInput">Quest Reward XP:</label>
            <input type="number" id="xpNewQuestRewardXPInput" min="1" value="50">
        </div>
        <div class="xp-tracker-modal-footer">
            <button id="xpSaveNewQuestBtn" class="xp-button">Save Quest</button>
            <button class="xp-button xp-tracker-modal-cancel-btn" data-modal-id="xpCreateQuestModal">Cancel</button>
        </div>
    </div>
</div>

<div id="xpConfirmRemoveAreaModal" class="xp-tracker-modal">
    <div class="xp-tracker-modal-content" style="max-width: 400px;">
        <div class="xp-tracker-modal-title-bar">
            <span>Confirm Deletion</span>
            <span class="xp-tracker-modal-close-button" data-modal-id="xpConfirmRemoveAreaModal">r</span>
        </div>
        <div class="xp-tracker-modal-body">
            <p id="xpConfirmRemoveAreaMessage">Are you sure?</p>
        </div>
        <div class="xp-tracker-modal-footer">
            <button id="xpConfirmRemoveAreaExecuteBtn" class="xp-button">Confirm</button>
            <button class="xp-button xp-tracker-modal-cancel-btn" data-modal-id="xpConfirmRemoveAreaModal">Cancel</button>
        </div>
    </div>
</div>

<div id="xpConfirmDeleteAchievementModal" class="xp-tracker-modal">
    <div class="xp-tracker-modal-content" style="max-width: 400px;">
        <div class="xp-tracker-modal-title-bar">
            <span>Confirm Achievement Deletion</span>
            <span class="xp-tracker-modal-close-button" data-modal-id="xpConfirmDeleteAchievementModal">r</span>
        </div>
        <div class="xp-tracker-modal-body">
            <p>Are you sure you want to delete this achievement? This will deduct its XP if it was awarded.</p>
        </div>
        <div class="xp-tracker-modal-footer">
            <button id="xpConfirmDeleteAchievementExecuteBtn" class="xp-button">Delete</button>
            <button class="xp-button xp-tracker-modal-cancel-btn" data-modal-id="xpConfirmDeleteAchievementModal">Cancel</button>
        </div>
    </div>
</div>

<div id="xpConfirmRefreshQuestModal" class="xp-tracker-modal">
    <div class="xp-tracker-modal-content" style="max-width: 400px;">
        <div class="xp-tracker-modal-title-bar">
            <span>Confirm Quest Refresh</span>
            <span class="xp-tracker-modal-close-button" data-modal-id="xpConfirmRefreshQuestModal">r</span>
        </div>
        <div class="xp-tracker-modal-body">
            <p>Are you sure you want to refresh this quest? Current progress on this quest will be lost and a new quest will be generated.</p>
        </div>
        <div class="xp-tracker-modal-footer">
            <button id="xpConfirmRefreshQuestExecuteBtn" class="xp-button">Refresh Quest</button>
            <button class="xp-button xp-tracker-modal-cancel-btn" data-modal-id="xpConfirmRefreshQuestModal">Cancel</button>
        </div>
    </div>
</div>


<script>
    const XP_TRACKER_STORAGE_KEY = 'xpTrackerAppData_v1.0.2'; 
    const WEEKDAYS = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    const XP_PER_REGULAR_ACHIEVEMENT = 10;
    const XP_PER_QUEST_COMPLETED_BASE = 50;
    const MAX_WEEKLY_QUESTS = 5;
    
    let trackerData = {
        areas: [],
        achievements: {}, 
        quests: {},
        currentWeekStartDate: null, 
        viewMode: 'week', 
        selectedDayIndex: 0, 
    };

    const DOM_XP = {
        controlsBar: document.getElementById('controlsBar'),
        prevWeekBtn: document.getElementById('prevWeekBtn'),
        thisWeekBtn: document.getElementById('thisWeekBtn'),
        nextWeekBtn: document.getElementById('nextWeekBtn'),
        currentWeekDisplay: document.getElementById('currentWeekDisplay'),
        weekCountDisplay: document.getElementById('weekCountDisplay'),
        toggleViewBtn: document.getElementById('toggleViewBtn'),
        showQuestsBtn: document.getElementById('showQuestsBtn'),
        addAreaBtn: document.getElementById('addAreaBtn'),
        weekdayHeaders: document.getElementById('weekdayHeaders'),
        gridBody: document.getElementById('gridBody'),
        gridTable: document.getElementById('gridTable'),
        // Modals
        newAreaModal: document.getElementById('xpNewAreaModal'),
        newAreaNameInput: document.getElementById('xpNewAreaNameInput'),
        saveNewAreaBtn: document.getElementById('xpSaveNewAreaBtn'),
        addEditAchievementModal: document.getElementById('xpAddEditAchievementModal'),
        addEditAchievementModalTitle: document.getElementById('xpAddEditAchievementModalTitle'),
        achievementAreaNameInput: document.getElementById('xpAchievementAreaNameInput'),
        achievementDayIndexInput: document.getElementById('xpAchievementDayIndexInput'),
        editingAchievementKeyInput: document.getElementById('xpEditingAchievementKeyInput'),
        editingAchievementIdInput: document.getElementById('xpEditingAchievementIdInput'),
        achievementTypeRadios: document.getElementsByName('xpAchievementType'),
        textInputDiv: document.getElementById('xpTextInputDiv'),
        imageInputDiv: document.getElementById('xpImageInputDiv'),
        achievementTextInput: document.getElementById('xpAchievementTextInput'),
        achievementImageInput: document.getElementById('xpAchievementImageInput'),
        saveAchievementBtn: document.getElementById('xpSaveAchievementBtn'),
        questsModal: document.getElementById('xpQuestsModal'),
        questsListBody: document.getElementById('xpQuestsListBody'),
        addQuestBtnModal: document.getElementById('xpAddQuestBtn'), 
        createQuestModal: document.getElementById('xpCreateQuestModal'),
        newQuestAreaNameSelect: document.getElementById('xpNewQuestAreaNameSelect'),
        newQuestDescriptionInput: document.getElementById('xpNewQuestDescriptionInput'),
        newQuestTargetXPInput: document.getElementById('xpNewQuestTargetXPInput'),
        newQuestRewardXPInput: document.getElementById('xpNewQuestRewardXPInput'),
        saveNewQuestBtn: document.getElementById('xpSaveNewQuestBtn'),
        confirmRemoveAreaModal: document.getElementById('xpConfirmRemoveAreaModal'),
        confirmRemoveAreaMessage: document.getElementById('xpConfirmRemoveAreaMessage'),
        confirmRemoveAreaExecuteBtn: document.getElementById('xpConfirmRemoveAreaExecuteBtn'),
        confirmDeleteAchievementModal: document.getElementById('xpConfirmDeleteAchievementModal'),
        confirmDeleteAchievementExecuteBtn: document.getElementById('xpConfirmDeleteAchievementExecuteBtn'),
        confirmRefreshQuestModal: document.getElementById('xpConfirmRefreshQuestModal'),
        confirmRefreshQuestExecuteBtn: document.getElementById('xpConfirmRefreshQuestExecuteBtn'),
    };
    
    function openXpModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'flex';
    }
    function closeXpModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'none';
    }

    function decodeHtmlEntities(text) { if (typeof text !== 'string') return text; const textarea = document.createElement('textarea'); textarea.innerHTML = text; return textarea.value; }
    function getMonday(d) { d = new Date(d); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); const monday = new Date(d.getFullYear(), d.getMonth(), diff); monday.setHours(0,0,0,0); return monday; }
    function getWeekNumber(d) { const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7)); const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1)); const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7); return weekNo; }
    function parseYYYYMMDDToLocalDate(dateString) { if (!dateString || typeof dateString !== 'string') return null; const parts = dateString.split('-'); if (parts.length !== 3) return null; const [year, month, day] = parts.map(Number); if (isNaN(year) || isNaN(month) || isNaN(day)) return null; const localDate = new Date(year, month - 1, day); localDate.setHours(0,0,0,0); return localDate; }
    function getDayOfYear(date) { const startOfYear = new Date(date.getFullYear(), 0, 0); const diff = date - startOfYear; const oneDay = 1000 * 60 * 60 * 24; return Math.floor(diff / oneDay); }
    
    function loadTrackerData() {
        const stored = localStorage.getItem(XP_TRACKER_STORAGE_KEY);
        if (stored) {
            try {
                const parsedData = JSON.parse(stored);
                trackerData = { ...trackerData, ...parsedData }; 
                if (!trackerData.currentWeekStartDate) {
                     trackerData.currentWeekStartDate = getMonday(new Date()).toISOString().split('T')[0];
                }
                trackerData.areas = trackerData.areas || [];
                trackerData.achievements = trackerData.achievements || {};
                trackerData.quests = trackerData.quests || {}; 
                trackerData.viewMode = ['week', 'day'].includes(trackerData.viewMode) ? trackerData.viewMode : 'week';
                trackerData.selectedDayIndex = (typeof trackerData.selectedDayIndex === 'number' && trackerData.selectedDayIndex >= 0 && trackerData.selectedDayIndex <=6) ? trackerData.selectedDayIndex : 0;
            } catch (e) {
                console.error("Error loading XP Tracker data, resetting.", e);
                resetTrackerDataToDefaults();
            }
        } else {
            resetTrackerDataToDefaults();
        }
    }
    
    function resetTrackerDataToDefaults() {
        trackerData = {
            areas: [], achievements: {}, quests: {},
            currentWeekStartDate: getMonday(new Date()).toISOString().split('T')[0],
            viewMode: 'week', selectedDayIndex: 0,
        };
    }

    function saveTrackerData() { localStorage.setItem(XP_TRACKER_STORAGE_KEY, JSON.stringify(trackerData)); }
    function updateDateDisplay() { const currentMonday = parseYYYYMMDDToLocalDate(trackerData.currentWeekStartDate); if (!currentMonday) { DOM_XP.currentWeekDisplay.textContent = "Error: Invalid Date"; DOM_XP.weekCountDisplay.textContent = ""; return; } if (trackerData.viewMode === 'week') { const weekEndDate = new Date(currentMonday); weekEndDate.setDate(currentMonday.getDate() + 6); const options = { month: 'short', day: 'numeric' }; DOM_XP.currentWeekDisplay.textContent = `${currentMonday.toLocaleDateString(undefined, options)} - ${weekEndDate.toLocaleDateString(undefined, options)}`; DOM_XP.weekCountDisplay.textContent = `Year Week: ${getWeekNumber(currentMonday)}`; } else { const selectedDate = new Date(currentMonday); const currentDayIndex = (typeof trackerData.selectedDayIndex === 'number' && trackerData.selectedDayIndex >= 0 && trackerData.selectedDayIndex <=6) ? trackerData.selectedDayIndex : 0; selectedDate.setDate(selectedDate.getDate() + currentDayIndex); const dayDisplayOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; DOM_XP.currentWeekDisplay.textContent = selectedDate.toLocaleDateString(undefined, dayDisplayOptions); DOM_XP.weekCountDisplay.textContent = `Year Day: ${getDayOfYear(selectedDate)}`; } }
    function renderWeekdayHeaders() { DOM_XP.weekdayHeaders.innerHTML = '<th>Area</th>'; if (trackerData.viewMode === 'week') { DOM_XP.gridTable.style.minWidth = "730px"; WEEKDAYS.forEach(day => { const th = document.createElement('th'); th.textContent = day; DOM_XP.weekdayHeaders.appendChild(th); }); } else { DOM_XP.gridTable.style.minWidth = "auto"; const th = document.createElement('th'); const dayDate = parseYYYYMMDDToLocalDate(trackerData.currentWeekStartDate); if (!dayDate) { th.textContent = "Error"; DOM_XP.weekdayHeaders.appendChild(th); return; } const currentDayIndex = (typeof trackerData.selectedDayIndex === 'number' && trackerData.selectedDayIndex >= 0 && trackerData.selectedDayIndex <=6) ? trackerData.selectedDayIndex : 0; dayDate.setDate(dayDate.getDate() + currentDayIndex); th.textContent = `${WEEKDAYS[currentDayIndex]}, ${dayDate.toLocaleDateString(undefined, {month: 'short', day: 'numeric'})}`; DOM_XP.weekdayHeaders.appendChild(th); } }
    function xpForNextLevel(currentLevel) { if (currentLevel <= 0) return 50; return Math.floor(50 * Math.pow(currentLevel, 1.5)); }
    function renderGrid() { DOM_XP.gridBody.innerHTML = ''; if (!trackerData.currentWeekStartDate) { console.error("Cannot render grid: currentWeekStartDate is not set."); return; } trackerData.areas.forEach(area => { const tr = document.createElement('tr'); tr.dataset.areaName = area.name; const nameTd = document.createElement('td'); nameTd.className = 'area-name-cell'; const currentXP = area.xp || 0; const currentLevel = area.level || 1; const xpToNext = xpForNextLevel(currentLevel); const percentage = xpToNext > 0 ? Math.min((currentXP / xpToNext) * 100, 100) : (currentXP > 0 ? 100 : 0); nameTd.innerHTML = ` <div class="area-name-wrapper"> <span>${decodeHtmlEntities(area.name)}</span> <button class="xp-button delete-area-btn" data-area-name="${area.name}" title="Delete ${decodeHtmlEntities(area.name)}">X</button> </div> <div class="area-stats"> <span>Level: <span class="area-level">${currentLevel}</span></span> <div class="xp-bar-container"> <div class="xp-bar" style="width: ${percentage}%;"></div> <div class="xp-bar-text"><span class="area-xp">${currentXP}</span> / ${xpToNext} XP</div> </div> </div>`; tr.appendChild(nameTd); const renderCellContent = (td, areaName, dayIdx) => { const achievementsKey = `${trackerData.currentWeekStartDate}_${areaName}_${dayIdx}`; const cellAchievements = trackerData.achievements[achievementsKey] || []; cellAchievements.forEach(ach => { const achDiv = document.createElement('div'); achDiv.className = 'achievement-item'; achDiv.dataset.achId = ach.id; achDiv.dataset.achKey = achievementsKey; const contentDiv = document.createElement('div'); contentDiv.className = 'achievement-content'; if (ach.type === 'text') { contentDiv.textContent = decodeHtmlEntities(ach.content); } else if (ach.type === 'image' && ach.content) { const img = document.createElement('img'); img.src = ach.content; img.alt = "Achievement Image"; contentDiv.appendChild(img); } achDiv.appendChild(contentDiv); const actionsDiv = document.createElement('div'); actionsDiv.className = 'achievement-item-actions'; actionsDiv.innerHTML = ` <button class="xp-button xp-button-small edit-ach-btn" data-ach-key="${achievementsKey}" data-ach-id="${ach.id}" title="Edit">Edit</button> <button class="xp-button xp-button-small remove-ach-btn" data-ach-key="${achievementsKey}" data-ach-id="${ach.id}" title="Delete">Delete</button> `; achDiv.appendChild(actionsDiv); td.appendChild(achDiv); }); const addAchBtn = document.createElement('button'); addAchBtn.className = 'xp-button achievement-add-btn-cell'; addAchBtn.textContent = '+'; addAchBtn.dataset.areaName = areaName; addAchBtn.dataset.dayIndex = dayIdx; const currentMondayForTitle = parseYYYYMMDDToLocalDate(trackerData.currentWeekStartDate); if(currentMondayForTitle){ const dayDate = new Date(currentMondayForTitle); dayDate.setDate(dayDate.getDate() + dayIdx); addAchBtn.title = `Add achievement to ${decodeHtmlEntities(areaName)} on ${WEEKDAYS[dayIdx]}, ${dayDate.toLocaleDateString(undefined, {month: 'short', day: 'numeric'})}`; } else { addAchBtn.title = `Add achievement to ${decodeHtmlEntities(areaName)} on ${WEEKDAYS[dayIdx]}`; } td.appendChild(addAchBtn); }; if (trackerData.viewMode === 'week') { WEEKDAYS.forEach((day, dayIndex) => { const td = document.createElement('td'); td.dataset.areaName = area.name; td.dataset.dayIndex = dayIndex; renderCellContent(td, area.name, dayIndex); tr.appendChild(td); }); } else { const dayIndex = (typeof trackerData.selectedDayIndex === 'number' && trackerData.selectedDayIndex >= 0 && trackerData.selectedDayIndex <=6) ? trackerData.selectedDayIndex : 0; const td = document.createElement('td'); td.dataset.areaName = area.name; td.dataset.dayIndex = dayIndex; renderCellContent(td, area.name, dayIndex); tr.appendChild(td); } DOM_XP.gridBody.appendChild(tr); }); checkControlsBarLayout(); }
    function checkControlsBarLayout() { const controlsBar = DOM_XP.controlsBar; if (!controlsBar || !controlsBar.clientWidth) return; const children = [ controlsBar.querySelector('.week-navigation'), controlsBar.querySelector('.controls-group'), controlsBar.querySelector('.global-actions') ].filter(el => el); if (children.length === 0) return; const originalClasses = controlsBar.className; controlsBar.className = 'controls-bar layout-single-row'; let totalChildrenWidth = 0; children.forEach(child => { const childStyle = getComputedStyle(child); totalChildrenWidth += child.scrollWidth + parseFloat(childStyle.marginLeft) + parseFloat(childStyle.marginRight); }); controlsBar.className = originalClasses; const controlsBarClientWidth = controlsBar.clientWidth - (parseFloat(getComputedStyle(controlsBar).paddingLeft) + parseFloat(getComputedStyle(controlsBar).paddingRight)); if (totalChildrenWidth > controlsBarClientWidth && controlsBarClientWidth > 0) { controlsBar.classList.add('layout-multi-row'); controlsBar.classList.remove('layout-single-row'); } else { controlsBar.classList.add('layout-single-row'); controlsBar.classList.remove('layout-multi-row'); } }

    function addXpToArea(areaName, xpAmount) { const area = trackerData.areas.find(a => a.name === areaName); if (area) { area.xp = (area.xp || 0) + xpAmount; let leveledUp = false; let requiredForNext = xpForNextLevel(area.level || 1); while (area.xp >= requiredForNext && requiredForNext > 0) { area.xp -= requiredForNext; area.level = (area.level || 1) + 1; leveledUp = true; requiredForNext = xpForNextLevel(area.level); } if (leveledUp) { console.log(`${decodeHtmlEntities(area.name)} leveled up to Level ${area.level}!`); generateQuestsForCurrentWeekIfNeeded(true); } } }
    function subtractXpFromArea(areaName, xpAmount) { const area = trackerData.areas.find(a => a.name === areaName); if (area) { area.xp = (area.xp || 0) - xpAmount; let deLeveled = false; while (area.xp < 0) { if (area.level > 1) { area.level--; deLeveled = true; area.xp += xpForNextLevel(area.level); } else { area.xp = 0; break; } } if (deLeveled) { generateQuestsForCurrentWeekIfNeeded(true); } } }

    // Modal Handlers
    function openNewAreaModal() {
        DOM_XP.newAreaNameInput.value = '';
        openXpModal('xpNewAreaModal');
        DOM_XP.newAreaNameInput.focus();
    }
    function saveNewAreaFromModal() {
        const name = DOM_XP.newAreaNameInput.value.trim();
        if (!name) { alert("Area name cannot be empty."); return; }
        if (trackerData.areas.find(a => a.name.toLowerCase() === name.toLowerCase())) { alert("Area with this name already exists."); return; }
        trackerData.areas.push({ name: name, level: 1, xp: 0 });
        closeXpModal('xpNewAreaModal');
        renderGrid();
        generateQuestsForCurrentWeekIfNeeded(true); 
        saveTrackerData();
    }
    function promptRemoveAreaFromModal(areaName) {
        DOM_XP.confirmRemoveAreaMessage.textContent = `Are you sure you want to remove the area "${decodeHtmlEntities(areaName)}"? This action cannot be undone and will delete all associated achievements and quests.`;
        DOM_XP.confirmRemoveAreaExecuteBtn.dataset.areaNameToRemove = areaName;
        openXpModal('xpConfirmRemoveAreaModal');
    }
    function executeRemoveAreaFromModal() {
        const areaName = DOM_XP.confirmRemoveAreaExecuteBtn.dataset.areaNameToRemove;
        if (areaName) {
            trackerData.areas = trackerData.areas.filter(area => area.name !== areaName);
            Object.keys(trackerData.achievements).forEach(key => { if (key.includes(`_${areaName}_`)) delete trackerData.achievements[key]; });
            Object.keys(trackerData.quests).forEach(weekId => { trackerData.quests[weekId] = trackerData.quests[weekId].filter(quest => quest.areaName !== areaName); });
            generateQuestsForCurrentWeekIfNeeded(true);
            renderGrid();
            saveTrackerData();
        }
        closeXpModal('xpConfirmRemoveAreaModal');
    }

    function openAddEditAchievementModalFromGrid(areaName, dayIndex, achievementKeyToEdit = null, achievementIdToEdit = null) {
        DOM_XP.achievementImageInput.value = null; 
        DOM_XP.achievementTextInput.value = '';
        DOM_XP.editingAchievementKeyInput.value = '';
        DOM_XP.editingAchievementIdInput.value = '';

        if (achievementKeyToEdit && achievementIdToEdit) { 
            const achievementsInCell = trackerData.achievements[achievementKeyToEdit];
            const achievementToEdit = achievementsInCell ? achievementsInCell.find(ach => ach.id === achievementIdToEdit) : null;
            if (!achievementToEdit) { alert("Error: Could not find achievement to edit."); return; }
            
            const keyParts = achievementKeyToEdit.split('_');
            DOM_XP.achievementAreaNameInput.value = keyParts.slice(1, keyParts.length -1).join('_'); 
            DOM_XP.achievementDayIndexInput.value = parseInt(keyParts[keyParts.length -1]);
            DOM_XP.editingAchievementKeyInput.value = achievementKeyToEdit;
            DOM_XP.editingAchievementIdInput.value = achievementIdToEdit;
            DOM_XP.addEditAchievementModalTitle.textContent = "Edit Achievement";
            DOM_XP.saveAchievementBtn.textContent = "Update Achievement";
            if (achievementToEdit.type === 'text') {
                DOM_XP.achievementTypeRadios[0].checked = true;
                DOM_XP.achievementTextInput.value = decodeHtmlEntities(achievementToEdit.content);
            } else if (achievementToEdit.type === 'image') {
                DOM_XP.achievementTypeRadios[1].checked = true;
            }
        } else { 
            DOM_XP.achievementAreaNameInput.value = areaName;
            DOM_XP.achievementDayIndexInput.value = dayIndex;
            DOM_XP.addEditAchievementModalTitle.textContent = "Add Achievement";
            DOM_XP.saveAchievementBtn.textContent = "Save Achievement";
            DOM_XP.achievementTypeRadios[0].checked = true; 
        }
        toggleAchievementInputTypeUI();
        openXpModal('xpAddEditAchievementModal');
        if(DOM_XP.achievementTypeRadios[0].checked) DOM_XP.achievementTextInput.focus();
    }

    function toggleAchievementInputTypeUI() {
        if (DOM_XP.achievementTypeRadios[0].checked) { 
            DOM_XP.textInputDiv.style.display = 'block';
            DOM_XP.imageInputDiv.style.display = 'none';
        } else { 
            DOM_XP.textInputDiv.style.display = 'none';
            DOM_XP.imageInputDiv.style.display = 'block';
        }
    }

    function getAchievementDate(weekStartDateStr, dayIdx) { const achievementDate = parseYYYYMMDDToLocalDate(weekStartDateStr); if(achievementDate) achievementDate.setDate(achievementDate.getDate() + dayIdx); return achievementDate; }
    
    function saveOrUpdateAchievementFromModal() {
        const areaName = DOM_XP.achievementAreaNameInput.value;
        const dayIndex = parseInt(DOM_XP.achievementDayIndexInput.value);
        const type = document.querySelector('input[name="xpAchievementType"]:checked').value;
        const editingKey = DOM_XP.editingAchievementKeyInput.value;
        const editingId = DOM_XP.editingAchievementIdInput.value;
        const isEditing = editingKey && editingId;
        let achievement;
        const achievementsKey = isEditing ? editingKey : `${trackerData.currentWeekStartDate}_${areaName}_${dayIndex}`;
        if (!trackerData.achievements[achievementsKey] && !isEditing) { trackerData.achievements[achievementsKey] = []; }
        let achievementList = trackerData.achievements[achievementsKey] || [];

        if (isEditing) {
            achievement = achievementList.find(ach => ach.id === editingId);
            if (!achievement) { alert("Error: Could not find achievement to update."); return; }
        } else {
            const achievementDate = getAchievementDate(trackerData.currentWeekStartDate, dayIndex);
            achievement = {
                id: Date.now() + '-' + Math.random().toString(36).substring(2, 9),
                timestamp: new Date().toISOString(),
                xp: XP_PER_REGULAR_ACHIEVEMENT,
                scheduledDate: achievementDate ? achievementDate.toISOString().split('T')[0] : trackerData.currentWeekStartDate, 
                xpAwarded: false 
            };
        }
        achievement.type = type;

        const processSave = (contentToSave) => {
            achievement.content = contentToSave;
            if (!isEditing) {
                achievementList.push(achievement);
                const today = new Date(); today.setHours(0,0,0,0);
                const achievementScheduledDateObj = parseYYYYMMDDToLocalDate(achievement.scheduledDate);
                if (achievementScheduledDateObj && achievementScheduledDateObj <= today) {
                    addXpToArea(areaName, achievement.xp);
                    updateQuestProgress(areaName, achievement.xp); 
                    achievement.xpAwarded = true;
                } else {
                    achievement.xpAwarded = false;
                }
            }
            closeXpModal('xpAddEditAchievementModal');
            renderGrid();
            saveTrackerData();
        };

        if (type === 'text') {
            const textContent = DOM_XP.achievementTextInput.value.trim();
            if (!textContent) { alert("Achievement description cannot be empty."); return; }
            processSave(textContent);
        } else if (type === 'image') {
            const file = DOM_XP.achievementImageInput.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) { alert("Image file is too large (max 2MB)."); return; }
                const reader = new FileReader();
                reader.onloadend = () => processSave(reader.result);
                reader.onerror = () => alert("Error reading image file.");
                reader.readAsDataURL(file);
            } else if (isEditing && achievement.type === 'image' && achievement.content) {
                processSave(achievement.content); 
            } else if (!isEditing || (isEditing && achievement.type !== 'image')) {
                alert("Please select an image file for an image type achievement."); return;
            }
        }
    }

    function promptRemoveAchievementFromModal(achievementKey, achievementId) {
        DOM_XP.confirmDeleteAchievementExecuteBtn.dataset.achievementKey = achievementKey;
        DOM_XP.confirmDeleteAchievementExecuteBtn.dataset.achievementId = achievementId;
        openXpModal('xpConfirmDeleteAchievementModal');
    }

    function executeRemoveAchievementFromModal() {
        const achievementKey = DOM_XP.confirmDeleteAchievementExecuteBtn.dataset.achievementKey;
        const achievementId = DOM_XP.confirmDeleteAchievementExecuteBtn.dataset.achievementId;
        if (!achievementKey || !achievementId || !trackerData.achievements[achievementKey]) return closeXpModal('xpConfirmDeleteAchievementModal');
        
        const achIndex = trackerData.achievements[achievementKey].findIndex(ach => ach.id === achievementId);
        if (achIndex === -1) return closeXpModal('xpConfirmDeleteAchievementModal');

        const achievementToRemove = trackerData.achievements[achievementKey][achIndex];
        const xpToRemove = achievementToRemove.xp;
        const keyParts = achievementKey.split('_');
        const areaName = keyParts.slice(1, keyParts.length -1).join('_'); 

        trackerData.achievements[achievementKey].splice(achIndex, 1);
        if (trackerData.achievements[achievementKey].length === 0) {
            delete trackerData.achievements[achievementKey];
        }

        if (achievementToRemove.xpAwarded) {
            subtractXpFromArea(areaName, xpToRemove);
            updateQuestProgress(areaName, -xpToRemove); 
        }
        closeXpModal('xpConfirmDeleteAchievementModal');
        renderGrid();
        saveTrackerData();
    }

    function getCurrentWeekId() { if (!trackerData.currentWeekStartDate) { trackerData.currentWeekStartDate = getMonday(new Date()).toISOString().split('T')[0]; } const startDate = parseYYYYMMDDToLocalDate(trackerData.currentWeekStartDate); return startDate ? `${startDate.getFullYear()}-W${String(getWeekNumber(startDate)).padStart(2, '0')}` : null; }
    function generateQuestsForCurrentWeekIfNeeded(forceRegenerate = false) { const weekId = getCurrentWeekId(); if(!weekId) return; if (!trackerData.quests) trackerData.quests = {}; if (!trackerData.quests[weekId] || forceRegenerate) { trackerData.quests[weekId] = []; } if (trackerData.areas.length < 1 && !forceRegenerate) { if(trackerData.quests[weekId].length === 0) return; } if (forceRegenerate || (trackerData.quests[weekId].length === 0 && trackerData.areas.length > 0)) { if (forceRegenerate) trackerData.quests[weekId] = []; const questsToGenerate = Math.min(MAX_WEEKLY_QUESTS, trackerData.areas.length, 3); const availableAreas = [...trackerData.areas].filter(area => !trackerData.quests[weekId].some(q => q.areaName === area.name)); let shuffledAreas = [...(availableAreas.length > 0 ? availableAreas : trackerData.areas)]; for (let i = shuffledAreas.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [shuffledAreas[i], shuffledAreas[j]] = [shuffledAreas[j], shuffledAreas[i]]; } for (let i = 0; i < questsToGenerate && trackerData.quests[weekId].length < MAX_WEEKLY_QUESTS; i++) { if (shuffledAreas.length === 0) break; const selectedArea = shuffledAreas.pop(); if (!selectedArea) continue; if(!forceRegenerate && trackerData.quests[weekId].some(q => q.areaName === selectedArea.name)) continue; const targetXPEarned = 20 + (selectedArea.level * 10); const rewardXP = XP_PER_QUEST_COMPLETED_BASE + (selectedArea.level * 5); trackerData.quests[weekId].push({ id: `quest_${weekId}_${selectedArea.name.replace(/\s+/g, '-')}_${Date.now()}_${i}`, areaName: selectedArea.name, description: `Earn ${targetXPEarned} XP in "${decodeHtmlEntities(selectedArea.name)}" this week.`, targetXPEarned: targetXPEarned, currentXPEarned: 0, rewardXP: rewardXP, completed: false }); } } }
    function updateQuestProgress(areaName, xpGained) { const weekId = getCurrentWeekId(); if (!weekId || !trackerData.quests || !trackerData.quests[weekId]) return; let questCompletedThisUpdate = false; trackerData.quests[weekId].forEach(quest => { if (quest.areaName === areaName && !quest.completed) { quest.currentXPEarned += xpGained; if (quest.currentXPEarned < 0) quest.currentXPEarned = 0; if (quest.currentXPEarned >= quest.targetXPEarned) { quest.completed = true; quest.currentXPEarned = quest.targetXPEarned; addXpToArea(quest.areaName, quest.rewardXP); alert(`Quest Completed: ${decodeHtmlEntities(quest.description)}\n+${quest.rewardXP} XP to ${decodeHtmlEntities(quest.areaName)}!`); questCompletedThisUpdate = true; } } }); if (questCompletedThisUpdate) { renderGrid(); saveTrackerData(); } }
    function showQuestsModal() { const weekId = getCurrentWeekId(); if(!weekId) return; DOM_XP.questsListBody.innerHTML = ''; generateQuestsForCurrentWeekIfNeeded(); const currentQuests = trackerData.quests[weekId] || []; if (currentQuests.length === 0) { DOM_XP.questsListBody.innerHTML = `<p>No quests available for this week.${trackerData.areas.length === 0 ? ' Add some areas first to generate quests!' : ' You can create new quests manually.'}</p>`; } else { currentQuests.forEach(quest => { const questDiv = document.createElement('div'); questDiv.className = 'quest-item'; if (quest.completed) questDiv.classList.add('completed'); const title = document.createElement('div'); title.className = 'quest-title'; title.textContent = `Quest for: ${decodeHtmlEntities(quest.areaName)}`; const details = document.createElement('div'); details.className = 'quest-details'; details.textContent = decodeHtmlEntities(quest.description); const progress = document.createElement('div'); progress.className = 'quest-progress'; progress.textContent = `Progress: ${Math.min(quest.currentXPEarned, quest.targetXPEarned)} / ${quest.targetXPEarned} XP. Reward: ${quest.rewardXP} XP.`; const actionsDiv = document.createElement('div'); actionsDiv.className = 'quest-actions'; if (!quest.completed) { const refreshBtn = document.createElement('button'); refreshBtn.className = 'xp-button xp-button-small refresh-quest-btn'; refreshBtn.dataset.questId = quest.id; refreshBtn.textContent = 'Refresh'; actionsDiv.appendChild(refreshBtn); } questDiv.appendChild(title); questDiv.appendChild(details); questDiv.appendChild(progress); questDiv.appendChild(actionsDiv); DOM_XP.questsListBody.appendChild(questDiv); }); } DOM_XP.addQuestBtnModal.disabled = currentQuests.length >= MAX_WEEKLY_QUESTS; openXpModal('xpQuestsModal'); }
    function openCreateQuestModalFromQuests() { const weekId = getCurrentWeekId(); if(!weekId) return; if (trackerData.quests[weekId] && trackerData.quests[weekId].length >= MAX_WEEKLY_QUESTS) { alert(`Maximum of ${MAX_WEEKLY_QUESTS} quests per week reached.`); return; } if (trackerData.areas.length === 0) { alert("Please create at least one Area before adding quests."); return; } DOM_XP.newQuestAreaNameSelect.innerHTML = ''; trackerData.areas.forEach(area => { const option = document.createElement('option'); option.value = area.name; option.textContent = decodeHtmlEntities(area.name); DOM_XP.newQuestAreaNameSelect.appendChild(option); }); DOM_XP.newQuestDescriptionInput.value = ''; DOM_XP.newQuestTargetXPInput.value = 30; DOM_XP.newQuestRewardXPInput.value = 50; openXpModal('xpCreateQuestModal'); }
    function saveNewQuestFromModal() { const weekId = getCurrentWeekId(); if(!weekId) return; if (!trackerData.quests[weekId]) trackerData.quests[weekId] = []; if (trackerData.quests[weekId].length >= MAX_WEEKLY_QUESTS) { alert(`Cannot add new quest: Maximum of ${MAX_WEEKLY_QUESTS} quests reached for this week.`); return; } const areaName = DOM_XP.newQuestAreaNameSelect.value; const description = DOM_XP.newQuestDescriptionInput.value.trim(); const targetXP = parseInt(DOM_XP.newQuestTargetXPInput.value); const rewardXP = parseInt(DOM_XP.newQuestRewardXPInput.value); if (!areaName) { alert("Please select an area."); return; } if (!description) { alert("Please enter a description."); return; } if (isNaN(targetXP) || targetXP <= 0) { alert("Target XP must be a positive number."); return; } if (isNaN(rewardXP) || rewardXP <= 0) { alert("Reward XP must be a positive number."); return; } const newQuest = { id: `quest_${weekId}_${areaName.replace(/\s+/g, '-')}_${Date.now()}`, areaName: areaName, description: description, targetXPEarned: targetXP, currentXPEarned: 0, rewardXP: rewardXP, completed: false }; trackerData.quests[weekId].push(newQuest); closeXpModal('xpCreateQuestModal'); showQuestsModal(); saveTrackerData(); }
    function promptRefreshQuestFromModal(questId) { DOM_XP.confirmRefreshQuestExecuteBtn.dataset.questIdToRefresh = questId; openXpModal('xpConfirmRefreshQuestModal'); }
    function generateSingleRandomQuest(weekId, questToReplace = null) { if (trackerData.areas.length === 0) return null; let potentialAreas = [...trackerData.areas]; if (questToReplace && potentialAreas.length > 1) { const filteredAreas = potentialAreas.filter(a => a.name !== questToReplace.areaName); if (filteredAreas.length > 0) potentialAreas = filteredAreas; } if(potentialAreas.length === 0) potentialAreas = [...trackerData.areas]; const randomAreaIndex = Math.floor(Math.random() * potentialAreas.length); const selectedArea = potentialAreas[randomAreaIndex]; const baseTarget = 20 + (selectedArea.level * 10); const targetXPEarned = Math.max(10, Math.round(baseTarget + (Math.random() * baseTarget * 0.3) - (baseTarget * 0.15)) ); const baseReward = XP_PER_QUEST_COMPLETED_BASE + (selectedArea.level * 5); const rewardXP = Math.max(10, Math.round(baseReward + (Math.random() * baseReward * 0.2) - (baseReward * 0.1))); return { id: `quest_${weekId}_${selectedArea.name.replace(/\s+/g, '-')}_${Date.now()}`, areaName: selectedArea.name, description: `Earn ${targetXPEarned} XP in "${decodeHtmlEntities(selectedArea.name)}" this week. (Refreshed)`, targetXPEarned: targetXPEarned, currentXPEarned: 0, rewardXP: rewardXP, completed: false }; }
    function executeRefreshQuestFromModal() { const questIdToRefresh = DOM_XP.confirmRefreshQuestExecuteBtn.dataset.questIdToRefresh; const weekId = getCurrentWeekId(); if (!questIdToRefresh || !weekId || !trackerData.quests[weekId]) { closeXpModal('xpConfirmRefreshQuestModal'); return; } const questIndex = trackerData.quests[weekId].findIndex(q => q.id === questIdToRefresh); if (questIndex === -1) { closeXpModal('xpConfirmRefreshQuestModal'); return; } const oldQuest = trackerData.quests[weekId][questIndex]; trackerData.quests[weekId].splice(questIndex, 1); const newQuest = generateSingleRandomQuest(weekId, oldQuest); if (newQuest) { trackerData.quests[weekId].push(newQuest); } else if (trackerData.areas.length > 0) { alert("Could not generate a new quest. Try again or create one manually."); } closeXpModal('xpConfirmRefreshQuestModal'); showQuestsModal(); saveTrackerData(); }

    function addTrackerEventListeners() {
        DOM_XP.addAreaBtn.addEventListener('click', openNewAreaModal);
        DOM_XP.saveNewAreaBtn.addEventListener('click', saveNewAreaFromModal);
        DOM_XP.newAreaNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveNewAreaFromModal(); });
        
        DOM_XP.gridBody.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('delete-area-btn')) {
                promptRemoveAreaFromModal(target.dataset.areaName);
            } else if (target.classList.contains('edit-ach-btn')) {
                openAddEditAchievementModalFromGrid(null, null, target.dataset.achKey, target.dataset.achId);
            } else if (target.classList.contains('remove-ach-btn')) {
                promptRemoveAchievementFromModal(target.dataset.achKey, target.dataset.achId);
            } else if (target.classList.contains('achievement-add-btn-cell')) {
                openAddEditAchievementModalFromGrid(target.dataset.areaName, parseInt(target.dataset.dayIndex));
            }
        });

        DOM_XP.saveAchievementBtn.addEventListener('click', saveOrUpdateAchievementFromModal);
        DOM_XP.achievementTypeRadios.forEach(radio => { radio.addEventListener('change', toggleAchievementInputTypeUI); });
        DOM_XP.confirmRemoveAreaExecuteBtn.addEventListener('click', executeRemoveAreaFromModal);
        DOM_XP.confirmDeleteAchievementExecuteBtn.addEventListener('click', executeRemoveAchievementFromModal);

        DOM_XP.prevWeekBtn.addEventListener('click', () => navigateDate(-1));
        DOM_XP.nextWeekBtn.addEventListener('click', () => navigateDate(1));
        DOM_XP.thisWeekBtn.addEventListener('click', goToThisWeek);
        DOM_XP.toggleViewBtn.addEventListener('click', toggleViewMode);
        
        DOM_XP.showQuestsBtn.addEventListener('click', showQuestsModal);
        DOM_XP.addQuestBtnModal.addEventListener('click', openCreateQuestModalFromQuests);
        DOM_XP.saveNewQuestBtn.addEventListener('click', saveNewQuestFromModal);
        DOM_XP.questsListBody.addEventListener('click', function(event) { 
            if (event.target.classList.contains('refresh-quest-btn')) {
                promptRefreshQuestFromModal(event.target.dataset.questId);
            }
        });
        DOM_XP.confirmRefreshQuestExecuteBtn.addEventListener('click', executeRefreshQuestFromModal);
        
        document.querySelectorAll('.xp-tracker-modal-close-button, .xp-tracker-modal-cancel-btn').forEach(btn => {
            btn.addEventListener('click', (event) => {
                const modalId = event.target.dataset.modalId;
                if(modalId) closeXpModal(modalId);
            });
        });
        
        new ResizeObserver(checkControlsBarLayout).observe(DOM_XP.controlsBar);
    }
    
    function navigateDate(offset) { const currentMon = parseYYYYMMDDToLocalDate(trackerData.currentWeekStartDate); if (!currentMon) return; if (trackerData.viewMode === 'week') { currentMon.setDate(currentMon.getDate() + (offset * 7)); trackerData.currentWeekStartDate = getMonday(currentMon).toISOString().split('T')[0]; } else { let newDayIndex = trackerData.selectedDayIndex + offset; if (newDayIndex < 0) { currentMon.setDate(currentMon.getDate() - 7); trackerData.currentWeekStartDate = getMonday(currentMon).toISOString().split('T')[0]; trackerData.selectedDayIndex = 6; } else if (newDayIndex > 6) { currentMon.setDate(currentMon.getDate() + 7); trackerData.currentWeekStartDate = getMonday(currentMon).toISOString().split('T')[0]; trackerData.selectedDayIndex = 0; } else { trackerData.selectedDayIndex = newDayIndex; } } updateDateDisplay(); renderWeekdayHeaders(); renderGrid(); generateQuestsForCurrentWeekIfNeeded(); saveTrackerData(); }
    function goToThisWeek() { trackerData.currentWeekStartDate = getMonday(new Date()).toISOString().split('T')[0]; if(trackerData.viewMode === 'day') { const today = new Date(); let currentDayOfWeek = today.getDay(); trackerData.selectedDayIndex = (currentDayOfWeek === 0) ? 6 : currentDayOfWeek - 1; } updateDateDisplay(); renderWeekdayHeaders(); renderGrid(); generateQuestsForCurrentWeekIfNeeded(); saveTrackerData(); }
    function toggleViewMode() { if (trackerData.viewMode === 'week') { trackerData.viewMode = 'day'; DOM_XP.toggleViewBtn.textContent = 'Week View'; DOM_XP.prevWeekBtn.textContent = '< Prev Day'; DOM_XP.nextWeekBtn.textContent = 'Next Day >'; DOM_XP.thisWeekBtn.textContent = 'Today'; const today = new Date(); const currentMon = parseYYYYMMDDToLocalDate(trackerData.currentWeekStartDate); if (currentMon) { const currentSun = new Date(currentMon); currentSun.setDate(currentMon.getDate() + 6); if (today >= currentMon && today <= currentSun) { trackerData.selectedDayIndex = (today.getDay() === 0) ? 6 : today.getDay() - 1; } else { trackerData.selectedDayIndex = 0; } } else { trackerData.selectedDayIndex = 0;} } else { trackerData.viewMode = 'week'; DOM_XP.toggleViewBtn.textContent = 'Day View'; DOM_XP.prevWeekBtn.textContent = '< Prev Week'; DOM_XP.nextWeekBtn.textContent = 'Next Week >'; DOM_XP.thisWeekBtn.textContent = 'This Week'; } updateDateDisplay(); renderWeekdayHeaders(); renderGrid(); saveTrackerData(); }

    document.addEventListener('DOMContentLoaded', () => {
        loadTrackerData();
        updateDateDisplay();
        renderWeekdayHeaders();
        renderGrid();
        addTrackerEventListeners();
        checkControlsBarLayout(); 
        generateQuestsForCurrentWeekIfNeeded(); 
    });
</script>