<div class="desktop-icon" id="trackerIcon" data-window-id="xpMainWindow">
    <div class="icon-image">âœ…</div>
    <div class="icon-label">XP Tracker</div>
</div>

<div class="xp-window" id="xpMainWindow">
    <div class="title-bar" id="xpMainWindowTitleBar">
        <span class="title-bar-text">XP Tracker</span>
        <div class="title-bar-controls">
            <button id="xpMainWindowMinimizeBtn" title="Minimize">0</button>
            <button id="xpMainWindowMaximizeBtn" title="Maximize">1</button>
            <button title="Close" id="xpMainWindowCloseBtn">r</button>
        </div>
    </div>
    <div class="window-body" id="xpMainWindowBody">
        <div class="controls-bar" id="controlsBar">
            <div class="week-navigation">
                <button id="prevWeekBtn" class="xp-button">&lt; Prev Week</button>
                <button id="thisWeekBtn" class="xp-button">This Week</button>
                <button id="nextWeekBtn" class="xp-button">Next Week &gt;</button>
            </div>
            <div class="controls-group">
                <span id="currentWeekDisplay">Week X</span>
                <span id="weekCountDisplay">Year Week: XX</span>
            </div>
            <div class="global-actions">
                <button id="toggleViewBtn" class="xp-button">Day View</button>
                <button id="showQuestsBtn" class="xp-button">Weekly Quests</button>
                <button id="addAreaBtn" class="xp-button">New Area</button>
            </div>
        </div>
        <table id="gridTable">
            <thead>
                <tr id="weekdayHeaders">
                    <th>Area</th>
                </tr>
            </thead>
            <tbody id="gridBody">
            </tbody>
        </table>
    </div>
    <div class="resize-handle" id="xpMainWindowResizeHandle"></div>
</div>

<div id="newAreaModal" class="modal">
    <div class="modal-content">
        <div class="modal-title-bar">
            <span id="newAreaModalTitle">Create New Area</span>
            <span class="close-button" data-modal-id="newAreaModal">r</span>
        </div>
        <div class="modal-body">
            <label for="newAreaName">Area Name:</label>
            <input type="text" id="newAreaName" placeholder="e.g., Fitness, Learning, Work">
        </div>
        <div class="modal-footer">
            <button id="saveNewAreaBtn" class="xp-button">Save</button>
            <button class="xp-button" data-modal-id="newAreaModal">Cancel</button>
        </div>
    </div>
</div>
<div id="addEditAchievementModal" class="modal">
    <div class="modal-content">
        <div class="modal-title-bar">
            <span id="addEditAchievementModalTitle">Add Achievement</span>
            <span class="close-button" data-modal-id="addEditAchievementModal">r</span>
        </div>
        <div class="modal-body">
            <input type="hidden" id="achievementAreaName">
            <input type="hidden" id="achievementDayIndex">
            <input type="hidden" id="editingAchievementKey">
            <input type="hidden" id="editingAchievementId">
            <label>Type:</label>
            <input type="radio" name="achievementType" value="text" id="typeText" checked> Text
            <input type="radio" name="achievementType" value="image" id="typeImage"> Image
            <br><br>
            <div id="textInputDiv">
                <label for="achievementText">Description:</label>
                <textarea id="achievementText" rows="3"></textarea>
            </div>
            <div id="imageInputDiv" style="display:none;">
                <label for="achievementImage">Upload Image:</label>
                <input type="file" id="achievementImage" accept="image/*">
                <p><small>Current image will be kept if no new image is selected during edit.</small></p>
            </div>
        </div>
        <div class="modal-footer">
            <button id="saveAchievementBtn" class="xp-button">Save Achievement</button>
            <button class="xp-button" data-modal-id="addEditAchievementModal">Cancel</button>
        </div>
    </div>
</div>
<div id="questsModal" class="modal">
    <div class="modal-content">
        <div class="modal-title-bar">
            <span>Weekly Quests</span>
            <span class="close-button" data-modal-id="questsModal">r</span>
        </div>
        <div class="modal-body" id="questsList">
            </div>
        <div class="modal-footer">
            <button id="addQuestBtn" class="xp-button">Create New Quest</button>
            <button class="xp-button" data-modal-id="questsModal">Close</button>
        </div>
    </div>
</div>
<div id="confirmRemoveAreaModal" class="modal">
    <div class="modal-content">
        <div class="modal-title-bar">
            <span>Confirm Deletion</span>
            <span class="close-button" data-modal-id="confirmRemoveAreaModal">r</span>
        </div>
        <div class="modal-body">
            <p id="confirmRemoveAreaMessage">Are you sure?</p>
        </div>
        <div class="modal-footer">
            <button id="confirmRemoveBtn" class="xp-button">Confirm</button>
            <button class="xp-button" data-modal-id="confirmRemoveAreaModal">Cancel</button>
        </div>
    </div>
</div>
<div id="confirmDeleteAchievementModal" class="modal">
    <div class="modal-content">
        <div class="modal-title-bar">
            <span>Confirm Achievement Deletion</span>
            <span class="close-button" data-modal-id="confirmDeleteAchievementModal">r</span>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this achievement? This will deduct its XP if it was awarded.</p>
        </div>
        <div class="modal-footer">
            <button id="confirmDeleteAchievementBtn" class="xp-button">Delete</button>
            <button class="xp-button" data-modal-id="confirmDeleteAchievementModal">Cancel</button>
        </div>
    </div>
</div>
<div id="createQuestModal" class="modal">
    <div class="modal-content">
        <div class="modal-title-bar">
            <span>Create New Quest</span>
            <span class="close-button" data-modal-id="createQuestModal">r</span>
        </div>
        <div class="modal-body">
            <label for="newQuestAreaName">Area:</label>
            <select id="newQuestAreaName"></select>
            <label for="newQuestDescription">Description:</label>
            <textarea id="newQuestDescription" rows="2" placeholder="e.g., Read 2 chapters"></textarea>
            <label for="newQuestTargetXP">Target XP to Earn in Area for Quest:</label>
            <input type="number" id="newQuestTargetXP" min="1" value="30">
            <label for="newQuestRewardXP">Quest Reward XP:</label>
            <input type="number" id="newQuestRewardXP" min="1" value="50">
        </div>
        <div class="modal-footer">
            <button id="saveNewQuestBtn" class="xp-button">Save Quest</button>
            <button class="xp-button" data-modal-id="createQuestModal">Cancel</button>
        </div>
    </div>
</div>
<div id="confirmRefreshQuestModal" class="modal">
    <div class="modal-content">
        <div class="modal-title-bar">
            <span>Confirm Quest Refresh</span>
            <span class="close-button" data-modal-id="confirmRefreshQuestModal">r</span>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to refresh this quest? Current progress on this quest will be lost and a new quest will be generated.</p>
        </div>
        <div class="modal-footer">
            <button id="confirmRefreshQuestBtn" class="xp-button">Refresh Quest</button>
            <button class="xp-button" data-modal-id="confirmRefreshQuestModal">Cancel</button>
        </div>
    </div>
</div>


<style>
    /* XP Tracker Specific Styles */
    #xpMainWindow .window-body {
         padding: 15px;
         overflow-y: auto;
    }
    .controls-bar {
        display: flex;
        margin-bottom: 15px;
        padding: 8px;
        border: 1px solid #ACA899;
        background-color: #F0F0F0;
    }
    .controls-bar.layout-single-row {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        flex-wrap: nowrap;
    }
    .controls-bar.layout-single-row > div {
         margin: 2px 5px;
         flex-shrink: 0;
    }
    .controls-bar.layout-multi-row {
        flex-direction: column;
        align-items: stretch;
    }
    .controls-bar.layout-multi-row > div {
        width: 100%;
        box-sizing: border-box;
        margin-bottom: 8px;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        padding: 5px 0;
    }
    .controls-bar.layout-multi-row > div:last-child {
        margin-bottom: 0;
    }
    .controls-bar.layout-multi-row .controls-group {
         text-align: center;
    }
    .xp-button-small {
        padding: 2px 5px;
        font-size: 10px;
        min-width: auto;
        margin: 0 2px;
    }
    .week-navigation {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
    }
    .week-navigation button {
        margin: 0 3px;
    }
    .controls-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0 10px;
        text-align: center;
    }
    #currentWeekDisplay {
        font-weight: bold;
    }
    #weekCountDisplay {
        font-size: 0.9em;
        color: #333;
    }
    .global-actions {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        table-layout: fixed;
    }
    th, td {
        border: 1px solid #ACA899;
        padding: 8px;
        text-align: left;
        vertical-align: top;
        word-wrap: break-word;
    }
    th {
        background-color: #D4D0C8;
        text-align: center;
    }
    td.area-name-cell {
        font-weight: bold;
        width: 180px;
    }
    .area-stats {
        font-size: 0.9em;
        margin-top: 5px;
        color: #333;
    }
    .area-stats span { display: flex; }
    .xp-bar-container {
        width: 100%;
        height: 12px;
        background-color: #BDBDBD;
        border: 1px solid #7F7F7F;
        margin-top: 3px;
        position: relative;
        border-radius: 2px;
        overflow: hidden;
    }
    .xp-bar {
        height: 100%;
        background-color: #008000;
        transition: width 0.3s ease;
        border-radius: 1px;
    }
    .xp-bar-text {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        line-height: 12px;
        color: white;
        text-shadow: 1px 1px 0px black;
        font-weight: bold;
        z-index: 1;
    }
    .achievement-item {
        background-color: #FFF;
        border: 1px solid #DDD;
        padding: 8px;
        margin-bottom: 4px;
        font-size: 0.9em;
        border-radius: 3px;
        word-wrap: break-word;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .achievement-content {
        width: 100%;
        text-align: center;
        margin-bottom: 8px;
    }
    .achievement-content img {
        max-width: 100%;
        height: auto;
        display: block;
        margin-left: auto;
        margin-right: auto;
        margin-top: 0px;
        border-radius: 2px;
    }
    .achievement-item-actions {
        display: flex;
        gap: 3px;
    }
    .achievement-add-btn-cell {
        display: block;
        width: 99.5%;
        box-sizing: border-box;
        margin-top: 5px;
    }
    .modal-body label {
        display: block;
        margin-bottom: 5px;
        margin-top: 12px;
    }
    .modal-body input[type="text"],
    .modal-body input[type="number"],
    .modal-body textarea,
    .modal-body select {
        width: calc(100% - 12px);
        padding: 5px;
        margin-bottom: 10px;
        border: 1px solid #ACA899;
        box-sizing: border-box;
    }
    .modal-body input[type="file"] { margin-bottom: 5px; }
    .modal-body hr { border: 0; height: 1px; background: #ACA899; margin: 20px 0; }
    .quest-item {
        padding: 8px;
        border: 1px solid #ACA899;
        margin-bottom: 8px;
        background-color: #FFF;
        border-radius: 3px;
        position: relative;
    }
    .quest-item label { margin-left: 8px; }
    .quest-item.completed {
        background-color: #DFF0D8;
        text-decoration: line-through;
        color: #508a50;
    }
    .quest-item.completed .quest-title { color: #006400; }
    .quest-title { font-weight: bold; margin-bottom: 5px; color: #0039A9; }
    .quest-details { font-size: 0.95em; margin-bottom: 3px; }
    .quest-progress { font-size: 0.85em; color: #555; margin-top: 3px; margin-bottom: 25px; }
    .quest-actions { position: absolute; bottom: 5px; right: 5px; }
    .area-name-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    .delete-area-btn {
        padding: 1px 6px;
        min-width: auto;
        font-size: 10px;
        font-family: "Tahoma", "Geneva", sans-serif;
        font-weight: bold;
        margin-left: 10px;
        background-color: #E04343;
        color: white;
        border: 1px outset white;
        line-height: 1.2;
        cursor: pointer;
    }
    .delete-area-btn:hover { background-color: #FF6363; }
    .delete-area-btn:active { border-style: inset; }
</style>

<script>
(function() {
    const APP_ID = 'xpMainWindow';
    const STORAGE_KEY_APP = `app_${APP_ID}_data_v1.0`;
    const MIN_APP_WIDTH_WEEK = 905;
    const MIN_APP_WIDTH_DAY = 375;
    const MIN_APP_HEIGHT = 250;
    const DEFAULT_APP_WIDTH = 905;
    const DEFAULT_APP_HEIGHT = 705;

    const WEEKDAYS_APP = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    const XP_PER_REGULAR_ACHIEVEMENT_APP = 10;
    const XP_PER_QUEST_COMPLETED_BASE_APP = 50;
    const MAX_WEEKLY_QUESTS_APP = 5;

    const MODAL_IDS_APP = {
        NEW_AREA: 'newAreaModal',
        ADD_EDIT_ACHIEVEMENT: 'addEditAchievementModal',
        QUESTS: 'questsModal',
        CONFIRM_REMOVE_AREA: 'confirmRemoveAreaModal',
        CONFIRM_DELETE_ACHIEVEMENT: 'confirmDeleteAchievementModal',
        CREATE_QUEST: 'createQuestModal',
        CONFIRM_REFRESH_QUEST: 'confirmRefreshQuestModal',
    };
    
    const DOM_APP = {};
    let appData = {};

    function getAppById(id) { return document.getElementById(id); }

    function decodeHtmlEntities_App(text) {
        if (typeof text !== 'string') return text;
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        return textarea.value;
    }

    function saveAppData_XPTracker() {
        const win = DOM_APP.xpMainWindow;
        if (!win) return;
        
        let currentOsData = window.osData.windowStates[APP_ID] || {};
        const stateToSave = {
            appSpecific: {
                areas: appData.areas,
                achievements: appData.achievements,
                quests: appData.quests,
                currentWeekStartDate: appData.currentWeekStartDate,
                viewMode: appData.viewMode,
                selectedDayIndex: appData.selectedDayIndex,
            },
            windowGeneric: {
                x: win.offsetLeft,
                y: win.offsetTop,
                width: win.offsetWidth,
                height: win.offsetHeight,
                minimized: win.classList.contains('minimized'),
                maximized: win.classList.contains('true-maximized'),
                zIndex: parseInt(win.style.zIndex) || currentOsData.zIndex || window.highestZIndex,
                hiddenByUser: win.style.display === 'none',
                userManuallySet: currentOsData.userManuallySet || false,
                wasMaximizedBeforeMinimize: currentOsData.wasMaximizedBeforeMinimize || false,
            }
        };
        
        if(stateToSave.windowGeneric.minimized || stateToSave.windowGeneric.maximized){
            if(window.osData.lastNormalStates[APP_ID]){
                stateToSave.windowGeneric.x = parseInt(window.osData.lastNormalStates[APP_ID].left);
                stateToSave.windowGeneric.y = parseInt(window.osData.lastNormalStates[APP_ID].top);
                stateToSave.windowGeneric.width = parseInt(window.osData.lastNormalStates[APP_ID].width);
                stateToSave.windowGeneric.height = parseInt(window.osData.lastNormalStates[APP_ID].height);
            } else if (currentOsData.x != null) { // Use previously saved normal state if available
                 stateToSave.windowGeneric.x = currentOsData.x;
                 stateToSave.windowGeneric.y = currentOsData.y;
                 stateToSave.windowGeneric.width = currentOsData.width;
                 stateToSave.windowGeneric.height = currentOsData.height;
            }
        }

        localStorage.setItem(STORAGE_KEY_APP, JSON.stringify(stateToSave));
        window.osData.windowStates[APP_ID] = stateToSave.windowGeneric;
    }
    window.saveAppData[APP_ID] = saveAppData_XPTracker;


    function loadAppData_XPTracker() {
        const storedData = localStorage.getItem(STORAGE_KEY_APP);
        const defaultAppData = {
            areas: [],
            achievements: {},
            quests: {},
            currentWeekStartDate: null,
            viewMode: 'week',
            selectedDayIndex: 0,
        };
        const defaultWindowState = {
             x: null, y: null, width: DEFAULT_APP_WIDTH, height: DEFAULT_APP_HEIGHT, 
             maximized: false, minimized: false, zIndex: window.highestZIndex + 1, 
             userManuallySet: false, hiddenByUser: true, wasMaximizedBeforeMinimize: false
        };

        if (storedData) {
            try {
                const loaded = JSON.parse(storedData);
                appData = { ...defaultAppData, ...(loaded.appSpecific || {}) };
                window.osData.windowStates[APP_ID] = { ...defaultWindowState, ...(loaded.windowGeneric || {}) };
            } catch (e) {
                appData = { ...defaultAppData };
                window.osData.windowStates[APP_ID] = { ...defaultWindowState };
            }
        } else {
            appData = { ...defaultAppData };
            window.osData.windowStates[APP_ID] = { ...defaultWindowState };
        }
        if (!appData.currentWeekStartDate) {
            appData.currentWeekStartDate = getMonday_App(new Date()).toISOString().split('T')[0];
        }
        if (appData.viewMode !== 'week' && appData.viewMode !== 'day') {
             appData.viewMode = 'week';
        }
        if (appData.viewMode === 'day' && (appData.selectedDayIndex === undefined || appData.selectedDayIndex < 0 || appData.selectedDayIndex > 6) ) {
             appData.selectedDayIndex = 0;
        }
    }
    
    function restoreAppWindowState_XPTracker(forceVisible = false) {
        const win = DOM_APP.xpMainWindow;
        if (!win) return;
        let state = window.osData.windowStates[APP_ID] || {};
         const defaultState = {
            x: (window.innerWidth - DEFAULT_APP_WIDTH)/2, y: (window.innerHeight - DEFAULT_APP_HEIGHT)/2, 
            width: DEFAULT_APP_WIDTH, height: DEFAULT_APP_HEIGHT, 
            maximized: false, minimized: false, zIndex: window.highestZIndex +1, 
            userManuallySet: false, hiddenByUser: true, wasMaximizedBeforeMinimize: false
        };
        state = {...defaultState, ...state}; // Ensure all props exist

        if (forceVisible) {
            state.hiddenByUser = false;
            state.minimized = false;
        }
        
        if (state.hiddenByUser && !forceVisible) {
            win.style.display = 'none';
        } else {
            win.style.display = 'flex';
        }

        win.style.zIndex = state.zIndex || (window.highestZIndex + 1);
        window.highestZIndex = Math.max(window.highestZIndex, parseInt(win.style.zIndex));

        if (state.minimized && !forceVisible) {
            win.classList.add('minimized');
            win.classList.remove('true-maximized');
        } else if (state.maximized) {
            win.classList.add('true-maximized');
            win.classList.remove('minimized');
            win.style.width = '100vw';
            win.style.height = '100vh';
            win.style.top = '0px';
            win.style.left = '0px';
            window.osData.lastNormalStates[APP_ID] = {
                width: (state.width ? Math.max(getMinAppWidth(), state.width) : DEFAULT_APP_WIDTH) + 'px',
                height: (state.height ? Math.max(MIN_APP_HEIGHT, state.height) : DEFAULT_APP_HEIGHT) + 'px',
                top: (state.y != null ? state.y : defaultState.y) + 'px',
                left: (state.x != null ? state.x : defaultState.x) + 'px'
            };
        } else {
            win.classList.remove('minimized');
            win.classList.remove('true-maximized');
            if (state.userManuallySet && state.width != null && state.height != null && state.x != null && state.y != null) {
                win.style.left = state.x + 'px';
                win.style.top = state.y + 'px';
                win.style.width = Math.max(getMinAppWidth(), state.width) + 'px';
                win.style.height = Math.max(MIN_APP_HEIGHT, state.height) + 'px';
            } else {
                 window.setWindowDefaults(APP_ID, DEFAULT_APP_WIDTH, DEFAULT_APP_HEIGHT, getMinAppWidth(), MIN_APP_HEIGHT, false);
            }
        }
        window.updateMinMaxButtonStates_OS(APP_ID);
    }
    window.restoreAppWindowState[APP_ID] = restoreAppWindowState_XPTracker;


    function getMinAppWidth() {
        return appData.viewMode === 'week' ? MIN_APP_WIDTH_WEEK : MIN_APP_WIDTH_DAY;
    }
    
    function getMonday_App(d) {
        d = new Date(d);
        const currentDay = d.getDay();
        const diffToMondayVal = d.getDate() - currentDay + (currentDay === 0 ? -6 : 1);
        return new Date(d.getFullYear(), d.getMonth(), diffToMondayVal);
    }
    function getWeekNumber_App(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    function parseYYYYMMDDToLocalDate_App(dateString) {
        if (!dateString || typeof dateString !== 'string') return null;
        const parts = dateString.split('-');
        if (parts.length !== 3) return null;
        const [year, month, day] = parts.map(Number);
        if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
        return new Date(year, month - 1, day);
    }
    function getDayOfYear_App(date) {
        const startOfYear = new Date(date.getFullYear(), 0, 0);
        const diff = date - startOfYear;
        const oneDay = 1000 * 60 * 60 * 24;
        return Math.floor(diff / oneDay);
    }

    function checkAndAwardScheduledXP_App() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let xpWasAwardedThisCheck = false;
        for (const achievementsKey in appData.achievements) {
            if (appData.achievements.hasOwnProperty(achievementsKey)) {
                const achievementsInCell = appData.achievements[achievementsKey];
                const keyParts = achievementsKey.split('_');
                if (keyParts.length < 3) continue;
                const areaName = keyParts.slice(1, keyParts.length - 1).join('_');
                for (const ach of achievementsInCell) {
                    if (ach.xpAwarded === undefined) ach.xpAwarded = false;
                    if (!ach.scheduledDate) continue;
                    if (!ach.xpAwarded) {
                        const achievementScheduledDate = parseYYYYMMDDToLocalDate_App(ach.scheduledDate);
                        if (achievementScheduledDate && achievementScheduledDate <= today) {
                            addXpToArea_App(areaName, ach.xp);
                            updateQuestProgress_App(areaName, ach.xp);
                            ach.xpAwarded = true;
                            xpWasAwardedThisCheck = true;
                        }
                    }
                }
            }
        }
        if (xpWasAwardedThisCheck) {
            renderGrid_App();
            saveAppData_XPTracker();
        }
    }
    
    function updateDateDisplay_App() {
        const currentMonday = parseYYYYMMDDToLocalDate_App(appData.currentWeekStartDate);
        if (appData.viewMode === 'week') {
            const weekEndDate = new Date(currentMonday);
            weekEndDate.setDate(currentMonday.getDate() + 6);
            const options = { month: 'short', day: 'numeric' };
            DOM_APP.currentWeekDisplay.textContent = `${currentMonday.toLocaleDateString(undefined, options)} - ${weekEndDate.toLocaleDateString(undefined, options)}`;
            DOM_APP.weekCountDisplay.textContent = `Year Week: ${getWeekNumber_App(currentMonday)}`;
        } else {
            const selectedDate = new Date(currentMonday);
            const currentDayIndex = (typeof appData.selectedDayIndex === 'number' && appData.selectedDayIndex >= 0 && appData.selectedDayIndex <=6) ? appData.selectedDayIndex : 0;
            selectedDate.setDate(selectedDate.getDate() + currentDayIndex);
            const dayDisplayOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            DOM_APP.currentWeekDisplay.textContent = selectedDate.toLocaleDateString(undefined, dayDisplayOptions);
            DOM_APP.weekCountDisplay.textContent = `Year Day: ${getDayOfYear_App(selectedDate)}`;
        }
    }

    function renderWeekdayHeaders_App() {
        DOM_APP.weekdayHeaders.innerHTML = '<th>Area</th>';
        if (appData.viewMode === 'week') {
            WEEKDAYS_APP.forEach(day => {
                const th = document.createElement('th');
                th.textContent = day;
                DOM_APP.weekdayHeaders.appendChild(th);
            });
        } else {
            const th = document.createElement('th');
            const dayDate = parseYYYYMMDDToLocalDate_App(appData.currentWeekStartDate);
             const currentDayIndex = (typeof appData.selectedDayIndex === 'number' && appData.selectedDayIndex >= 0 && appData.selectedDayIndex <=6) ? appData.selectedDayIndex : 0;
            dayDate.setDate(dayDate.getDate() + currentDayIndex);
            th.textContent = `${WEEKDAYS_APP[currentDayIndex]}, ${dayDate.toLocaleDateString(undefined, {month: 'short', day: 'numeric'})}`;
            DOM_APP.weekdayHeaders.appendChild(th);
        }
    }

    function renderGrid_App() {
        DOM_APP.gridBody.innerHTML = '';
        appData.areas.forEach(area => {
            const tr = document.createElement('tr');
            tr.dataset.areaName = area.name;
            const nameTd = document.createElement('td');
            nameTd.className = 'area-name-cell';
            const currentXP = area.xp;
            const xpToNext = xpForNextLevel_App(area.level);
            const percentage = xpToNext > 0 ? Math.min((currentXP / xpToNext) * 100, 100) : (currentXP > 0 ? 100 : 0);
            nameTd.innerHTML = `
                <div class="area-name-wrapper">
                    <span>${decodeHtmlEntities_App(area.name)}</span>
                    <button class="xp-button delete-area-btn" data-area-name="${area.name}" title="Delete ${area.name}">X</button>
                </div>
                <div class="area-stats">
                    <span>Level: <span class="area-level">${area.level}</span></span>
                    <div class="xp-bar-container">
                        <div class="xp-bar" style="width: ${percentage}%;"></div>
                        <div class="xp-bar-text"><span class="area-xp">${currentXP}</span> / ${xpToNext} XP</div>
                    </div>
                </div>`;
            tr.appendChild(nameTd);
            const renderCellContent = (td, areaName, dayIdx) => {
                const achievementsKey = `${appData.currentWeekStartDate}_${areaName}_${dayIdx}`;
                const cellAchievements = appData.achievements[achievementsKey] || [];
                cellAchievements.forEach(ach => {
                    const achDiv = document.createElement('div');
                    achDiv.className = 'achievement-item';
                    achDiv.dataset.achId = ach.id;
                    achDiv.dataset.achKey = achievementsKey;
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'achievement-content';
                    if (ach.type === 'text') {
                        contentDiv.textContent = decodeHtmlEntities_App(ach.content);
                    } else if (ach.type === 'image') {
                        const img = document.createElement('img');
                        img.src = ach.content;
                        img.alt = "Achievement Image";
                        contentDiv.appendChild(img);
                    }
                    achDiv.appendChild(contentDiv);
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'achievement-item-actions';
                    actionsDiv.innerHTML = `
                        <button class="xp-button xp-button-small edit-ach-btn" data-ach-key="${achievementsKey}" data-ach-id="${ach.id}" title="Edit">Edit</button>
                        <button class="xp-button xp-button-small remove-ach-btn" data-ach-key="${achievementsKey}" data-ach-id="${ach.id}" title="Delete">Delete</button>
                    `;
                    achDiv.appendChild(actionsDiv);
                    let titleText = `XP: ${ach.xp} | Added: ${new Date(ach.timestamp).toLocaleString()}`;
                    if (ach.scheduledDate) {
                        titleText += ` | Scheduled: ${ach.scheduledDate}`;
                        titleText += ach.xpAwarded ? ' (XP Awarded)' : ' (XP Pending)';
                    }
                    achDiv.title = titleText;
                    td.appendChild(achDiv);
                });
                const addAchBtn = document.createElement('button');
                addAchBtn.className = 'xp-button achievement-add-btn-cell';
                addAchBtn.textContent = '+';
                addAchBtn.dataset.areaName = areaName;
                addAchBtn.dataset.dayIndex = dayIdx;
                const dayDate = parseYYYYMMDDToLocalDate_App(appData.currentWeekStartDate);
                dayDate.setDate(dayDate.getDate() + dayIdx);
                addAchBtn.title = `Add achievement to ${decodeHtmlEntities_App(areaName)} on ${WEEKDAYS_APP[dayIdx]}, ${dayDate.toLocaleDateString(undefined, {month: 'short', day: 'numeric'})}`;
                td.appendChild(addAchBtn);
            };
            if (appData.viewMode === 'week') {
                WEEKDAYS_APP.forEach((day, dayIndex) => {
                    const td = document.createElement('td');
                    td.dataset.areaName = area.name;
                    td.dataset.dayIndex = dayIndex;
                    renderCellContent(td, area.name, dayIndex);
                    tr.appendChild(td);
                });
            } else {
                 const currentDayIndex = (typeof appData.selectedDayIndex === 'number' && appData.selectedDayIndex >= 0 && appData.selectedDayIndex <=6) ? appData.selectedDayIndex : 0;
                const td = document.createElement('td');
                td.dataset.areaName = area.name;
                td.dataset.dayIndex = currentDayIndex;
                renderCellContent(td, area.name, currentDayIndex);
                tr.appendChild(td);
            }
            DOM_APP.gridBody.appendChild(tr);
        });
    }

    function saveNewArea_App() {
        const name = DOM_APP.newAreaNameInput.value.trim();
        if (!name) { alert("Area name cannot be empty."); return; }
        if (appData.areas.find(a => a.name.toLowerCase() === name.toLowerCase())) {
            alert("Area with this name already exists."); return;
        }
        appData.areas.push({ name: name, level: 1, xp: 0 });
        DOM_APP.newAreaNameInput.value = '';
        window.closeModal_OS(MODAL_IDS_APP.NEW_AREA);
        renderGrid_App();
        generateQuestsForCurrentWeekIfNeeded_App(true);
        saveAppData_XPTracker();
    }
    function promptRemoveArea_App(areaName) {
        DOM_APP.confirmRemoveAreaMessage.textContent = `Are you sure you want to remove the area "${decodeHtmlEntities_App(areaName)}"? This action cannot be undone and will delete all associated achievements and quests.`;
        DOM_APP.confirmRemoveBtn.dataset.areaNameToRemove = areaName;
        window.openModal_OS(MODAL_IDS_APP.CONFIRM_REMOVE_AREA);
    }
    function removeArea_App(areaName) {
        appData.areas = appData.areas.filter(area => area.name !== areaName);
        const achievementKeysToDelete = [];
        for (const key in appData.achievements) {
            if (appData.achievements.hasOwnProperty(key)) {
                const parts = key.split('_');
                const keyAreaName = parts.slice(1, parts.length -1).join('_');
                if (keyAreaName === areaName) achievementKeysToDelete.push(key);
            }
        }
        achievementKeysToDelete.forEach(key => delete appData.achievements[key]);
        for (const weekId in appData.quests) {
            if (appData.quests.hasOwnProperty(weekId)) {
                appData.quests[weekId] = appData.quests[weekId].filter(quest => quest.areaName !== areaName);
            }
        }
        generateQuestsForCurrentWeekIfNeeded_App(true);
        updateDateDisplay_App();
        renderWeekdayHeaders_App();
        renderGrid_App();
        saveAppData_XPTracker();
    }
    function openAddEditAchievementModal_App(areaName, dayIndex, achievementKeyToEdit = null, achievementIdToEdit = null) {
        DOM_APP.achievementImageInput.value = null;
        DOM_APP.achievementTextInput.value = '';
        DOM_APP.editingAchievementKeyInput.value = '';
        DOM_APP.editingAchievementIdInput.value = '';
        if (achievementKeyToEdit && achievementIdToEdit) {
            const achievementsInCell = appData.achievements[achievementKeyToEdit];
            const achievementToEdit = achievementsInCell ? achievementsInCell.find(ach => ach.id === achievementIdToEdit) : null;
            if (!achievementToEdit) { alert("Error: Could not find achievement to edit."); return; }
            const keyParts = achievementKeyToEdit.split('_');
            const currentAreaName = keyParts.slice(1, keyParts.length -1).join('_');
            const currentDayIndex = parseInt(keyParts[keyParts.length -1]);
            DOM_APP.achievementAreaNameInput.value = currentAreaName;
            DOM_APP.achievementDayIndexInput.value = currentDayIndex;
            DOM_APP.editingAchievementKeyInput.value = achievementKeyToEdit;
            DOM_APP.editingAchievementIdInput.value = achievementIdToEdit;
            DOM_APP.addEditAchievementModalTitle.textContent = "Edit Achievement";
            DOM_APP.saveAchievementBtn.textContent = "Update Achievement";
            if (achievementToEdit.type === 'text') {
                DOM_APP.achievementTypeRadios[0].checked = true;
                DOM_APP.achievementTextInput.value = decodeHtmlEntities_App(achievementToEdit.content);
            } else if (achievementToEdit.type === 'image') {
                DOM_APP.achievementTypeRadios[1].checked = true;
            }
        } else {
            DOM_APP.achievementAreaNameInput.value = areaName;
            DOM_APP.achievementDayIndexInput.value = dayIndex;
            DOM_APP.addEditAchievementModalTitle.textContent = "Add Achievement";
            DOM_APP.saveAchievementBtn.textContent = "Save Achievement";
            DOM_APP.achievementTypeRadios[0].checked = true;
        }
        toggleAchievementInputType_App();
        window.openModal_OS(MODAL_IDS_APP.ADD_EDIT_ACHIEVEMENT);
        if(DOM_APP.achievementTypeRadios[0].checked) DOM_APP.achievementTextInput.focus();
    }
    function toggleAchievementInputType_App() {
        if (DOM_APP.achievementTypeRadios[0].checked) {
            DOM_APP.textInputDiv.style.display = 'block';
            DOM_APP.imageInputDiv.style.display = 'none';
        } else {
            DOM_APP.textInputDiv.style.display = 'none';
            DOM_APP.imageInputDiv.style.display = 'block';
        }
    }
    function getAchievementDate_App(weekStartDateStr, dayIdx) {
        const achievementDate = parseYYYYMMDDToLocalDate_App(weekStartDateStr);
        achievementDate.setDate(achievementDate.getDate() + dayIdx);
        return achievementDate;
    }
    function saveOrUpdateAchievement_App() {
        const areaName = DOM_APP.achievementAreaNameInput.value;
        const dayIndex = parseInt(DOM_APP.achievementDayIndexInput.value);
        const type = document.querySelector(`#${APP_ID} input[name="achievementType"]:checked`).value;
        const editingKey = DOM_APP.editingAchievementKeyInput.value;
        const editingId = DOM_APP.editingAchievementIdInput.value;
        const isEditing = editingKey && editingId;
        let achievement;
        const achievementsKey = isEditing ? editingKey : `${appData.currentWeekStartDate}_${areaName}_${dayIndex}`;
        if (!appData.achievements[achievementsKey] && !isEditing) {
            appData.achievements[achievementsKey] = [];
        }
        let achievementList = appData.achievements[achievementsKey] || [];
        if (isEditing) {
            achievement = achievementList.find(ach => ach.id === editingId);
            if (!achievement) { alert("Error: Could not find achievement to update."); return; }
        } else {
            achievement = {
                id: Date.now() + '-' + Math.random().toString(36).substring(2, 9),
                timestamp: new Date().toISOString(),
                xp: XP_PER_REGULAR_ACHIEVEMENT_APP,
                scheduledDate: getAchievementDate_App(appData.currentWeekStartDate, dayIndex).toISOString().split('T')[0],
                xpAwarded: false
            };
        }
        achievement.type = type;
        const processSave = (contentToSave) => {
            achievement.content = contentToSave;
            if (!isEditing) {
                achievementList.push(achievement);
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const achievementScheduledDateObj = parseYYYYMMDDToLocalDate_App(achievement.scheduledDate);
                if (achievementScheduledDateObj && achievementScheduledDateObj <= today) {
                    addXpToArea_App(areaName, achievement.xp);
                    updateQuestProgress_App(areaName, achievement.xp);
                    achievement.xpAwarded = true;
                }
            }
            window.closeModal_OS(MODAL_IDS_APP.ADD_EDIT_ACHIEVEMENT);
            renderGrid_App();
            saveAppData_XPTracker();
        };
        if (type === 'text') {
            const textContent = DOM_APP.achievementTextInput.value.trim();
            if (!textContent) { alert("Achievement description cannot be empty."); return; }
            processSave(textContent);
        } else if (type === 'image') {
            const file = DOM_APP.achievementImageInput.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) { alert("Image file is too large. Please choose an image under 2MB."); return; }
                const reader = new FileReader();
                reader.onloadend = function() { processSave(reader.result); }
                reader.onerror = function() { alert("Error reading image file."); }
                reader.readAsDataURL(file);
            } else if (isEditing && achievement.type === 'image' && achievement.content) {
                processSave(achievement.content);
            } else if (!isEditing || (isEditing && achievement.type !== 'image')) {
                alert("Please select an image file for an image type achievement."); return;
            }
        }
    }
    function promptRemoveAchievement_App(achievementKey, achievementId) {
        DOM_APP.confirmDeleteAchievementBtn.dataset.achievementKey = achievementKey;
        DOM_APP.confirmDeleteAchievementBtn.dataset.achievementId = achievementId;
        window.openModal_OS(MODAL_IDS_APP.CONFIRM_DELETE_ACHIEVEMENT);
    }
    function confirmRemoveAchievement_App(achievementKey, achievementId) {
        if (!appData.achievements[achievementKey]) return;
        const achIndex = appData.achievements[achievementKey].findIndex(ach => ach.id === achievementId);
        if (achIndex === -1) return;
        const achievementToRemove = appData.achievements[achievementKey][achIndex];
        const xpToRemove = achievementToRemove.xp;
        const keyParts = achievementKey.split('_');
        const areaName = keyParts.slice(1, keyParts.length -1).join('_');
        appData.achievements[achievementKey].splice(achIndex, 1);
        if (appData.achievements[achievementKey].length === 0) delete appData.achievements[achievementKey];
        if (achievementToRemove.xpAwarded) {
            subtractXpFromArea_App(areaName, xpToRemove);
            updateQuestProgress_App(areaName, -xpToRemove);
        }
        window.closeModal_OS(MODAL_IDS_APP.CONFIRM_DELETE_ACHIEVEMENT);
        renderGrid_App();
        saveAppData_XPTracker();
    }
    function xpForNextLevel_App(currentLevel) {
        if (currentLevel <= 0) return 50;
        return Math.floor(50 * Math.pow(currentLevel, 1.5));
    }
    function addXpToArea_App(areaName, xpAmount) {
        const area = appData.areas.find(a => a.name === areaName);
        if (area) {
            area.xp += xpAmount;
            let leveledUp = false;
            let requiredForNext = xpForNextLevel_App(area.level);
            while (area.xp >= requiredForNext && requiredForNext > 0) {
                area.xp -= requiredForNext;
                area.level++;
                leveledUp = true;
                requiredForNext = xpForNextLevel_App(area.level);
            }
            if (leveledUp) {
                alert(`${decodeHtmlEntities_App(area.name)} leveled up to Level ${area.level}!`);
                generateQuestsForCurrentWeekIfNeeded_App(true);
            }
        }
    }
    function subtractXpFromArea_App(areaName, xpAmount) {
        const area = appData.areas.find(a => a.name === areaName);
        if (area) {
            area.xp -= xpAmount;
            let deLeveled = false;
            while (area.xp < 0) {
                if (area.level > 1) {
                    area.level--;
                    deLeveled = true;
                    area.xp += xpForNextLevel_App(area.level);
                } else {
                    area.xp = 0; break;
                }
            }
            if (deLeveled) generateQuestsForCurrentWeekIfNeeded_App(true);
        }
    }
    function getCurrentWeekId_App() {
        if (!appData.currentWeekStartDate) {
            appData.currentWeekStartDate = getMonday_App(new Date()).toISOString().split('T')[0];
        }
        const startDate = parseYYYYMMDDToLocalDate_App(appData.currentWeekStartDate);
        return `${startDate.getFullYear()}-W${String(getWeekNumber_App(startDate)).padStart(2, '0')}`;
    }
    function generateQuestsForCurrentWeekIfNeeded_App(forceRegenerate = false) {
        const weekId = getCurrentWeekId_App();
        if (!appData.quests) appData.quests = {};
        if (!appData.quests[weekId] || forceRegenerate) appData.quests[weekId] = [];
        if (appData.areas.length < 1 && !forceRegenerate && appData.quests[weekId].length === 0) return;
        
        if (forceRegenerate || (appData.quests[weekId].length === 0 && appData.areas.length > 0)) {
            if (forceRegenerate) appData.quests[weekId] = [];
            const questsToPotentiallyGenerate = Math.min(MAX_WEEKLY_QUESTS_APP, appData.areas.length, 3);
            let availableAreasForNewQuests = [...appData.areas].filter(area =>
                !appData.quests[weekId].some(q => q.areaName === area.name)
            );
            let shuffledAreas = [...(availableAreasForNewQuests.length > 0 ? availableAreasForNewQuests : appData.areas)];
            for (let i = shuffledAreas.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledAreas[i], shuffledAreas[j]] = [shuffledAreas[j], shuffledAreas[i]];
            }
            for (let i = 0; i < questsToPotentiallyGenerate && appData.quests[weekId].length < MAX_WEEKLY_QUESTS_APP; i++) {
                if (shuffledAreas.length === 0) break;
                const selectedArea = shuffledAreas.pop();
                if (!selectedArea) continue;
                if(!forceRegenerate && appData.quests[weekId].some(q => q.areaName === selectedArea.name)) continue;
                const targetXPEarned = 20 + (selectedArea.level * 10);
                const rewardXP = XP_PER_QUEST_COMPLETED_BASE_APP + (selectedArea.level * 5);
                appData.quests[weekId].push({
                    id: `quest_${weekId}_${selectedArea.name.replace(/\s+/g, '-')}_${Date.now()}_${i}`,
                    areaName: selectedArea.name,
                    description: `Earn ${targetXPEarned} XP in "${decodeHtmlEntities_App(selectedArea.name)}" this week.`,
                    targetXPEarned: targetXPEarned,
                    currentXPEarned: 0,
                    rewardXP: rewardXP,
                    completed: false
                });
            }
        }
    }
    function updateQuestProgress_App(areaName, xpGained) {
        const weekId = getCurrentWeekId_App();
        if (!appData.quests || !appData.quests[weekId]) return;
        let questCompletedThisUpdate = false;
        appData.quests[weekId].forEach(quest => {
            if (quest.areaName === areaName && !quest.completed) {
                quest.currentXPEarned += xpGained;
                if (quest.currentXPEarned < 0) quest.currentXPEarned = 0;
                if (quest.currentXPEarned >= quest.targetXPEarned) {
                    quest.completed = true;
                    quest.currentXPEarned = quest.targetXPEarned;
                    addXpToArea_App(quest.areaName, quest.rewardXP);
                    alert(`Quest Completed: ${decodeHtmlEntities_App(quest.description)}\n+${quest.rewardXP} XP to ${decodeHtmlEntities_App(quest.areaName)}!`);
                    questCompletedThisUpdate = true;
                }
            }
        });
        if (questCompletedThisUpdate) {
            renderGrid_App();
            saveAppData_XPTracker();
        }
    }
    function showQuests_App() {
        const weekId = getCurrentWeekId_App();
        DOM_APP.questsList.innerHTML = '';
        generateQuestsForCurrentWeekIfNeeded_App();
        const currentQuests = appData.quests[weekId] || [];
        if (currentQuests.length === 0) {
            DOM_APP.questsList.innerHTML = `<p>No quests available for this week.${appData.areas.length === 0 ? ' Add some areas first to generate quests!' : ' You can create new quests manually.'}</p>`;
        } else {
            currentQuests.forEach(quest => {
                const questDiv = document.createElement('div');
                questDiv.className = 'quest-item';
                if (quest.completed) questDiv.classList.add('completed');
                const title = document.createElement('div');
                title.className = 'quest-title';
                title.textContent = `Quest for: ${decodeHtmlEntities_App(quest.areaName)}`;
                const details = document.createElement('div');
                details.className = 'quest-details';
                details.textContent = decodeHtmlEntities_App(quest.description);
                const progress = document.createElement('div');
                progress.className = 'quest-progress';
                progress.textContent = `Progress: ${Math.min(quest.currentXPEarned, quest.targetXPEarned)} / ${quest.targetXPEarned} XP. Reward: ${quest.rewardXP} XP.`;
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'quest-actions';
                if (!quest.completed) {
                    const refreshBtn = document.createElement('button');
                    refreshBtn.className = 'xp-button xp-button-small refresh-quest-btn';
                    refreshBtn.dataset.questId = quest.id;
                    refreshBtn.textContent = 'Refresh';
                    actionsDiv.appendChild(refreshBtn);
                }
                questDiv.appendChild(title);
                questDiv.appendChild(details);
                questDiv.appendChild(progress);
                questDiv.appendChild(actionsDiv);
                DOM_APP.questsList.appendChild(questDiv);
            });
        }
        DOM_APP.addQuestBtn.disabled = currentQuests.length >= MAX_WEEKLY_QUESTS_APP;
        window.openModal_OS(MODAL_IDS_APP.QUESTS);
    }
    function openCreateQuestModal_App() {
        const weekId = getCurrentWeekId_App();
        if (appData.quests[weekId] && appData.quests[weekId].length >= MAX_WEEKLY_QUESTS_APP) {
            alert(`Maximum of ${MAX_WEEKLY_QUESTS_APP} quests per week reached.`); return;
        }
        if (appData.areas.length === 0) {
            alert("Please create at least one Area before adding quests."); return;
        }
        DOM_APP.newQuestAreaNameSelect.innerHTML = '';
        appData.areas.forEach(area => {
            const option = document.createElement('option');
            option.value = area.name;
            option.textContent = decodeHtmlEntities_App(area.name);
            DOM_APP.newQuestAreaNameSelect.appendChild(option);
        });
        DOM_APP.newQuestDescriptionInput.value = '';
        DOM_APP.newQuestTargetXPInput.value = 30;
        DOM_APP.newQuestRewardXPInput.value = 50;
        window.openModal_OS(MODAL_IDS_APP.CREATE_QUEST);
    }
    function saveNewQuest_App() {
        const weekId = getCurrentWeekId_App();
        if (!appData.quests[weekId]) appData.quests[weekId] = [];
        if (appData.quests[weekId].length >= MAX_WEEKLY_QUESTS_APP) {
            alert(`Cannot add new quest: Maximum of ${MAX_WEEKLY_QUESTS_APP} quests reached for this week.`); return;
        }
        const areaName = DOM_APP.newQuestAreaNameSelect.value;
        const description = DOM_APP.newQuestDescriptionInput.value.trim();
        const targetXP = parseInt(DOM_APP.newQuestTargetXPInput.value);
        const rewardXP = parseInt(DOM_APP.newQuestRewardXPInput.value);
        if (!areaName) { alert("Please select an area."); return; }
        if (!description) { alert("Please enter a description."); return; }
        if (isNaN(targetXP) || targetXP <= 0) { alert("Target XP must be a positive number."); return; }
        if (isNaN(rewardXP) || rewardXP <= 0) { alert("Reward XP must be a positive number."); return; }
        const newQuest = {
            id: `quest_${weekId}_${areaName.replace(/\s+/g, '-')}_${Date.now()}`,
            areaName: areaName, description: description, targetXPEarned: targetXP,
            currentXPEarned: 0, rewardXP: rewardXP, completed: false
        };
        appData.quests[weekId].push(newQuest);
        window.closeModal_OS(MODAL_IDS_APP.CREATE_QUEST);
        showQuests_App();
        saveAppData_XPTracker();
    }
    function promptRefreshQuest_App(questId) {
        DOM_APP.confirmRefreshQuestBtn.dataset.questIdToRefresh = questId;
        window.openModal_OS(MODAL_IDS_APP.CONFIRM_REFRESH_QUEST);
    }
    function generateSingleRandomQuest_App(weekId, questToReplace = null) {
        if (appData.areas.length === 0) return null;
        let potentialAreas = [...appData.areas];
        if (questToReplace && potentialAreas.length > 1) {
            const filteredAreas = potentialAreas.filter(a => a.name !== questToReplace.areaName);
            if (filteredAreas.length > 0) potentialAreas = filteredAreas;
        }
        if(potentialAreas.length === 0) potentialAreas = [...appData.areas];
        const randomAreaIndex = Math.floor(Math.random() * potentialAreas.length);
        const selectedArea = potentialAreas[randomAreaIndex];
        const baseTarget = 20 + (selectedArea.level * 10);
        const targetXPEarned = Math.max(10, Math.round(baseTarget + (Math.random() * baseTarget * 0.3) - (baseTarget * 0.15)) );
        const baseReward = XP_PER_QUEST_COMPLETED_BASE_APP + (selectedArea.level * 5);
        const rewardXP = Math.max(10, Math.round(baseReward + (Math.random() * baseReward * 0.2) - (baseReward * 0.1)));
        return {
            id: `quest_${weekId}_${selectedArea.name.replace(/\s+/g, '-')}_${Date.now()}`,
            areaName: selectedArea.name,
            description: `Earn ${targetXPEarned} XP in "${decodeHtmlEntities_App(selectedArea.name)}" this week. (Refreshed)`,
            targetXPEarned: targetXPEarned, currentXPEarned: 0, rewardXP: rewardXP, completed: false
        };
    }
    function confirmAndRefreshQuest_App() {
        const questIdToRefresh = DOM_APP.confirmRefreshQuestBtn.dataset.questIdToRefresh;
        const weekId = getCurrentWeekId_App();
        if (!questIdToRefresh || !appData.quests[weekId]) {
            window.closeModal_OS(MODAL_IDS_APP.CONFIRM_REFRESH_QUEST); return;
        }
        const questIndex = appData.quests[weekId].findIndex(q => q.id === questIdToRefresh);
        if (questIndex === -1) { window.closeModal_OS(MODAL_IDS_APP.CONFIRM_REFRESH_QUEST); return; }
        const oldQuest = appData.quests[weekId][questIndex];
        appData.quests[weekId].splice(questIndex, 1);
        const newQuest = generateSingleRandomQuest_App(weekId, oldQuest);
        if (newQuest) appData.quests[weekId].push(newQuest);
        else if (appData.areas.length > 0) alert("Could not generate a new quest. Try again or create one manually.");
        window.closeModal_OS(MODAL_IDS_APP.CONFIRM_REFRESH_QUEST);
        showQuests_App();
        saveAppData_XPTracker();
    }

    function navigateWeek_App(offsetInDays) {
        const currentMon = parseYYYYMMDDToLocalDate_App(appData.currentWeekStartDate);
        currentMon.setDate(currentMon.getDate() + offsetInDays);
        appData.currentWeekStartDate = getMonday_App(currentMon).toISOString().split('T')[0];
        updateDateDisplay_App();
        renderWeekdayHeaders_App();
        checkAndAwardScheduledXP_App();
        renderGrid_App();
        generateQuestsForCurrentWeekIfNeeded_App();
        saveAppData_XPTracker();
    }
    function navigateDay_App(offset) {
        appData.selectedDayIndex += offset;
        let weekChanged = false;
        let currentMonDate = parseYYYYMMDDToLocalDate_App(appData.currentWeekStartDate);
        if (appData.selectedDayIndex < 0) {
            currentMonDate.setDate(currentMonDate.getDate() - 7);
            appData.currentWeekStartDate = getMonday_App(currentMonDate).toISOString().split('T')[0];
            appData.selectedDayIndex = 6; weekChanged = true;
        } else if (appData.selectedDayIndex > 6) {
            currentMonDate.setDate(currentMonDate.getDate() + 7);
            appData.currentWeekStartDate = getMonday_App(currentMonDate).toISOString().split('T')[0];
            appData.selectedDayIndex = 0; weekChanged = true;
        }
        updateDateDisplay_App();
        renderWeekdayHeaders_App();
        checkAndAwardScheduledXP_App();
        renderGrid_App();
        if (weekChanged) generateQuestsForCurrentWeekIfNeeded_App();
        saveAppData_XPTracker();
    }
    function goToThisWeek_App() {
        appData.currentWeekStartDate = getMonday_App(new Date()).toISOString().split('T')[0];
        if(appData.viewMode === 'day') {
            const today = new Date(); let currentDayOfWeek = today.getDay();
            appData.selectedDayIndex = (currentDayOfWeek === 0) ? 6 : currentDayOfWeek - 1;
        }
        updateViewControls_App();
        updateDateDisplay_App();
        renderWeekdayHeaders_App();
        checkAndAwardScheduledXP_App();
        renderGrid_App();
        generateQuestsForCurrentWeekIfNeeded_App();
        saveAppData_XPTracker();
    }
    function toggleViewMode_App() {
        const appWindow = DOM_APP.xpMainWindow;
        const state = window.osData.windowStates[APP_ID];
        const wasMaximized = appWindow.classList.contains('true-maximized');
        const wasMinimized = appWindow.classList.contains('minimized');
        if (appData.viewMode === 'week') {
            appData.viewMode = 'day';
            const today = new Date();
            const currentWeekMondayObj = parseYYYYMMDDToLocalDate_App(appData.currentWeekStartDate);
            const checkDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const weekStartCheck = new Date(currentWeekMondayObj.getFullYear(), currentWeekMondayObj.getMonth(), currentWeekMondayObj.getDate());
            const weekEndCheck = new Date(weekStartCheck); weekEndCheck.setDate(weekStartCheck.getDate() + 6);
            if (checkDate >= weekStartCheck && checkDate <= weekEndCheck) {
                let currentDayOfWeek = today.getDay();
                appData.selectedDayIndex = (currentDayOfWeek === 0) ? 6 : currentDayOfWeek - 1;
            } else {
                if (appData.selectedDayIndex === undefined || appData.selectedDayIndex < 0 || appData.selectedDayIndex > 6) appData.selectedDayIndex = 0;
            }
        } else {
            appData.viewMode = 'week';
        }
        if (!wasMaximized && !wasMinimized) {
            let currentWidth = appWindow.offsetWidth;
            if (currentWidth < getMinAppWidth()) {
                appWindow.style.width = getMinAppWidth() + 'px';
                if(state) { state.width = getMinAppWidth(); state.userManuallySet = false; }
            } else if (state && !state.userManuallySet) {
                 window.setWindowDefaults(APP_ID, DEFAULT_APP_WIDTH, DEFAULT_APP_HEIGHT, getMinAppWidth(), MIN_APP_HEIGHT, false);
            }
        }
        updateViewControls_App();
        updateDateDisplay_App();
        renderWeekdayHeaders_App();
        renderGrid_App();
        saveAppData_XPTracker();
    }
     function updateViewControls_App() {
        if (appData.viewMode === 'week') {
            DOM_APP.toggleViewBtn.textContent = 'Day View';
            DOM_APP.prevWeekBtn.textContent = '< Prev Week';
            DOM_APP.nextWeekBtn.textContent = 'Next Week >';
            DOM_APP.thisWeekBtn.textContent = 'This Week';
        } else {
            DOM_APP.toggleViewBtn.textContent = 'Week View';
            DOM_APP.prevWeekBtn.textContent = '< Prev Day';
            DOM_APP.nextWeekBtn.textContent = 'Next Day >';
            DOM_APP.thisWeekBtn.textContent = 'Today';
        }
    }
    function handleAppWindowResize_XPTracker() {
        if (DOM_APP.xpMainWindow.classList.contains('minimized') || DOM_APP.xpMainWindow.style.display === 'none') return;
        checkControlsBarLayout_App();
    }
    window.handleAppWindowResize[APP_ID] = handleAppWindowResize_XPTracker;

    function checkControlsBarLayout_App() {
        const controlsBar = DOM_APP.controlsBar;
        if (!controlsBar || !controlsBar.clientWidth) return;
        const children = [
            controlsBar.querySelector('.week-navigation'),
            controlsBar.querySelector('.controls-group'),
            controlsBar.querySelector('.global-actions')
        ].filter(el => el);
        if (children.length === 0) return;
        const originalClasses = controlsBar.className;
        controlsBar.className = 'controls-bar layout-single-row';
        let totalChildrenWidth = 0;
        children.forEach(child => {
            const childStyle = getComputedStyle(child);
            totalChildrenWidth += child.scrollWidth + parseFloat(childStyle.marginLeft) + parseFloat(childStyle.marginRight);
        });
        controlsBar.className = originalClasses;
        const controlsBarClientWidth = controlsBar.clientWidth - (parseFloat(getComputedStyle(controlsBar).paddingLeft) + parseFloat(getComputedStyle(controlsBar).paddingRight));
        if (totalChildrenWidth > controlsBarClientWidth && controlsBarClientWidth > 0) {
            controlsBar.classList.add('layout-multi-row');
            controlsBar.classList.remove('layout-single-row');
        } else {
            controlsBar.classList.add('layout-single-row');
            controlsBar.classList.remove('layout-multi-row');
        }
    }
    
    function initAppEventListeners_XPTracker() {
        DOM_APP.gridBody.addEventListener('click', function(event) {
            const target = event.target;
            if (target.classList.contains('delete-area-btn')) {
                const areaName = target.dataset.areaName;
                if (areaName) promptRemoveArea_App(areaName);
            } else if (target.classList.contains('edit-ach-btn')) {
                const achKey = target.dataset.achKey;
                const achId = target.dataset.achId;
                openAddEditAchievementModal_App(null, null, achKey, achId);
            } else if (target.classList.contains('remove-ach-btn')) {
                const achKey = target.dataset.achKey;
                const achId = target.dataset.achId;
                promptRemoveAchievement_App(achKey, achId);
            } else if (target.classList.contains('achievement-add-btn-cell')) {
                const areaName = target.dataset.areaName;
                const dayIndex = parseInt(target.dataset.dayIndex);
                openAddEditAchievementModal_App(areaName, dayIndex);
            }
        });
        DOM_APP.addAreaBtn.addEventListener('click', () => window.openModal_OS(MODAL_IDS_APP.NEW_AREA));
        DOM_APP.saveNewAreaBtn.addEventListener('click', saveNewArea_App);
        DOM_APP.newAreaNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveNewArea_App(); });
        DOM_APP.saveAchievementBtn.addEventListener('click', saveOrUpdateAchievement_App);
        DOM_APP.achievementTypeRadios.forEach(radio => { radio.addEventListener('change', toggleAchievementInputType_App); });
        DOM_APP.prevWeekBtn.addEventListener('click', () => {
            if (appData.viewMode === 'week') navigateWeek_App(-7); else navigateDay_App(-1);
        });
        DOM_APP.nextWeekBtn.addEventListener('click', () => {
            if (appData.viewMode === 'week') navigateWeek_App(7); else navigateDay_App(1);
        });
        DOM_APP.thisWeekBtn.addEventListener('click', goToThisWeek_App);
        DOM_APP.toggleViewBtn.addEventListener('click', toggleViewMode_App);
        DOM_APP.showQuestsBtn.addEventListener('click', showQuests_App);
        DOM_APP.addQuestBtn.addEventListener('click', openCreateQuestModal_App);
        DOM_APP.saveNewQuestBtn.addEventListener('click', saveNewQuest_App);
        DOM_APP.questsList.addEventListener('click', function(event) {
            if (event.target.classList.contains('refresh-quest-btn')) {
                const questId = event.target.dataset.questId;
                promptRefreshQuest_App(questId);
            }
        });
        DOM_APP.confirmRefreshQuestBtn.addEventListener('click', confirmAndRefreshQuest_App);
        
        DOM_APP.xpMainWindowMinimizeBtn.addEventListener('click', () => window.minimizeAppWindow(APP_ID));
        DOM_APP.xpMainWindowMaximizeBtn.addEventListener('click', () => window.maximizeAppWindowGlobal[APP_ID]());
        DOM_APP.xpMainWindowCloseBtn.addEventListener('click', () => window.closeAppWindow(APP_ID));

        DOM_APP.appModalCloseButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const modalId = event.target.dataset.modalId || event.target.closest('.modal').id;
                if (modalId) window.closeModal_OS(modalId);
            });
        });
        DOM_APP.confirmRemoveBtn.addEventListener('click', function() {
            const areaNameToRemove = this.dataset.areaNameToRemove;
            if (areaNameToRemove) {
                removeArea_App(areaNameToRemove);
                window.closeModal_OS(MODAL_IDS_APP.CONFIRM_REMOVE_AREA);
                delete this.dataset.areaNameToRemove;
            }
        });
        DOM_APP.confirmDeleteAchievementBtn.addEventListener('click', function() {
            const key = this.dataset.achievementKey;
            const id = this.dataset.achievementId;
            if (key && id) confirmRemoveAchievement_App(key, id);
        });
        const trackerWindowObserver = new ResizeObserver(handleAppWindowResize_XPTracker);
        trackerWindowObserver.observe(DOM_APP.xpMainWindow);
    }
    
    function init_XPTracker() {
        const fields = [
            'xpMainWindow', 'xpMainWindowTitleBar', 'xpMainWindowResizeHandle',
            'xpMainWindowMinimizeBtn', 'xpMainWindowMaximizeBtn', 'xpMainWindowCloseBtn', 'xpMainWindowBody',
            'weekdayHeaders', 'gridBody', 'addAreaBtn', 'prevWeekBtn', 'nextWeekBtn',
            'thisWeekBtn', 'toggleViewBtn', 'currentWeekDisplay', 'weekCountDisplay',
            'showQuestsBtn', 'controlsBar',
            'newAreaModal', 'newAreaNameInput', 'saveNewAreaBtn', 'addEditAchievementModal',
            'addEditAchievementModalTitle', 'achievementAreaNameInput', 'achievementDayIndexInput',
            'editingAchievementKeyInput', 'editingAchievementIdInput',
            'textInputDiv', 'imageInputDiv', 'achievementTextInput', 'achievementImageInput',
            'saveAchievementBtn', 'questsModal', 'questsList', 'addQuestBtn', 'createQuestModal',
            'newQuestAreaNameSelect', 'newQuestDescriptionInput', 'newQuestTargetXPInput',
            'newQuestRewardXPInput', 'saveNewQuestBtn', 'confirmRefreshQuestModal',
            'confirmRefreshQuestBtn', 'confirmRemoveAreaModal', 'confirmRemoveAreaMessage',
            'confirmRemoveBtn', 'confirmDeleteAchievementModal', 'confirmDeleteAchievementBtn'
        ];
        fields.forEach(field => DOM_APP[field] = getAppById(field));
        DOM_APP.achievementTypeRadios = document.querySelectorAll(`#${APP_ID} input[name="achievementType"]`);
        DOM_APP.appModalCloseButtons = document.querySelectorAll(
          `#${MODAL_IDS_APP.NEW_AREA} .close-button, #${MODAL_IDS_APP.NEW_AREA} .xp-button[data-modal-id],` +
          `#${MODAL_IDS_APP.ADD_EDIT_ACHIEVEMENT} .close-button, #${MODAL_IDS_APP.ADD_EDIT_ACHIEVEMENT} .xp-button[data-modal-id],` +
          `#${MODAL_IDS_APP.QUESTS} .close-button, #${MODAL_IDS_APP.QUESTS} .xp-button[data-modal-id],`+
          `#${MODAL_IDS_APP.CONFIRM_REMOVE_AREA} .close-button, #${MODAL_IDS_APP.CONFIRM_REMOVE_AREA} .xp-button[data-modal-id],`+
          `#${MODAL_IDS_APP.CONFIRM_DELETE_ACHIEVEMENT} .close-button, #${MODAL_IDS_APP.CONFIRM_DELETE_ACHIEVEMENT} .xp-button[data-modal-id],`+
          `#${MODAL_IDS_APP.CREATE_QUEST} .close-button, #${MODAL_IDS_APP.CREATE_QUEST} .xp-button[data-modal-id],`+
          `#${MODAL_IDS_APP.CONFIRM_REFRESH_QUEST} .close-button, #${MODAL_IDS_APP.CONFIRM_REFRESH_QUEST} .xp-button[data-modal-id]`
        );

        window.appInitialConfig[APP_ID] = {
            id: APP_ID,
            defaultWidth: DEFAULT_APP_WIDTH,
            defaultHeight: DEFAULT_APP_HEIGHT,
            minWidth: getMinAppWidth(), 
            minHeight: MIN_APP_HEIGHT,
            titleBarId: 'xpMainWindowTitleBar',
            resizeHandleId: 'xpMainWindowResizeHandle'
        };
        window.maximizeAppWindowGlobal[APP_ID] = () => window.maximizeAppWindow(APP_ID, getMinAppWidth(), MIN_APP_HEIGHT, DEFAULT_APP_WIDTH, DEFAULT_APP_HEIGHT);

        loadAppData_XPTracker();
        window.initWindowInteractions(APP_ID, 'xpMainWindowTitleBar', 'xpMainWindowResizeHandle', getMinAppWidth(), MIN_APP_HEIGHT);
        restoreAppWindowState_XPTracker();

        checkAndAwardScheduledXP_App();
        updateViewControls_App();
        updateDateDisplay_App();
        renderWeekdayHeaders_App();
        renderGrid_App();
        generateQuestsForCurrentWeekIfNeeded_App();
        handleAppWindowResize_XPTracker();
        initAppEventListeners_XPTracker();
    }
    init_XPTracker();
})();
</script>