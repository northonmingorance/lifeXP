<style>
    body { margin: 0; padding: 0; font-family: "Tahoma", "Geneva", sans-serif; font-size: 11px; background-color: #ECE9D8; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    .xp-button { background-color: #ECE9D8; border: 1px outset #7F7F7F; padding: 5px 12px; min-width: 75px; text-align: center; cursor: pointer; margin: 2px; }
    .xp-button:active { border-style: inset; }
    .xp-button:hover { border-color: #005CFE; }
    .xp-button-small { padding: 2px 5px; font-size: 10px; min-width: auto; margin: 0 2px;}
    .controls-bar { display: flex; margin-bottom: 15px; padding: 8px; border: 1px solid #ACA899; background-color: #F0F0F0; flex-shrink: 0; }
    .controls-bar.layout-single-row { flex-direction: row; justify-content: space-between; align-items: center; flex-wrap: nowrap; }
    .controls-bar.layout-single-row > div { margin: 2px 5px; flex-shrink: 0; }
    .controls-bar.layout-multi-row { flex-direction: column; align-items: stretch; }
    .controls-bar.layout-multi-row > div { width: 100%; box-sizing: border-box; margin-bottom: 8px; display: flex; justify-content: center; flex-wrap: wrap; padding: 5px 0; }
    .controls-bar.layout-multi-row > div:last-child { margin-bottom: 0; }
    .controls-bar.layout-multi-row .controls-group { text-align: center; }
    .week-navigation { display: flex; align-items: center; flex-wrap: wrap; justify-content: center; }
    .week-navigation button { margin: 0 3px; }
    .controls-group { display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 10px; text-align: center; }
    #currentWeekDisplay { font-weight: bold; }
    #weekCountDisplay { font-size: 0.9em; color: #333; }
    .global-actions { display: flex; align-items: center; flex-wrap: wrap; justify-content: center; }
    .table-container { flex-grow: 1; overflow: auto; padding: 0 15px 15px 15px;}
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border: 1px solid #ACA899; padding: 8px; text-align: left; vertical-align: top; word-wrap: break-word; }
    th { background-color: #D4D0C8; text-align: center; position: sticky; top: 0; z-index: 1;}
    td.area-name-cell { font-weight: bold; width: 180px; }
    .area-stats { font-size: 0.9em; margin-top: 5px; color: #333; }
    .area-stats span { display: flex; }
    .xp-bar-container { width: 100%; height: 12px; background-color: #BDBDBD; border: 1px solid #7F7F7F; margin-top: 3px; position: relative; border-radius: 2px; overflow: hidden; }
    .xp-bar { height: 100%; background-color: #008000; transition: width 0.3s ease; border-radius: 1px; }
    .xp-bar-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 9px; line-height: 12px; color: white; text-shadow: 1px 1px 0px black; font-weight: bold; z-index: 1; }
    .achievement-item { background-color: #FFF; border: 1px solid #DDD; padding: 8px; margin-bottom: 4px; font-size: 0.9em; border-radius: 3px; word-wrap: break-word; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
    .achievement-content { width: 100%; text-align: center; margin-bottom: 8px; }
    .achievement-content img { max-width: 100%; height: auto; display: block; margin-left: auto; margin-right: auto; margin-top: 0px; border-radius: 2px; }
    .achievement-item-actions { display: flex; gap: 3px; }
    .achievement-add-btn-cell { display: block; width: 99.5%; box-sizing: border-box; margin-top: 5px; }
    .area-name-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .delete-area-btn { padding: 1px 6px; min-width: auto; font-size: 10px; font-family: "Tahoma", "Geneva", sans-serif; font-weight: bold; margin-left: 10px; background-color: #E04343; color: white; border: 1px outset white; line-height: 1.2; cursor: pointer; }
    .delete-area-btn:hover { background-color: #FF6363; }
    .delete-area-btn:active { border-style: inset; }
</style>

<div class="controls-bar" id="controlsBar">
    <div class="week-navigation">
        <button id="prevWeekBtn" class="xp-button">< Prev Week</button>
        <button id="thisWeekBtn" class="xp-button">This Week</button>
        <button id="nextWeekBtn" class="xp-button">Next Week ></button>
    </div>
    <div class="controls-group">
        <span id="currentWeekDisplay">Week X</span>
        <span id="weekCountDisplay">Year Week: XX</span>
    </div>
    <div class="global-actions">
        <button id="toggleViewBtn" class="xp-button">Day View</button>
        <button id="showQuestsBtn" class="xp-button">Weekly Quests</button>
        <button id="addAreaBtn" class="xp-button">New Area</button>
    </div>
</div>
<div class="table-container">
    <table id="gridTable">
        <thead>
            <tr id="weekdayHeaders">
                <th>Area</th>
            </tr>
        </thead>
        <tbody id="gridBody">
        </tbody>
    </table>
</div>

<script>
    const XP_TRACKER_STORAGE_KEY = 'xpTrackerAppData_v1.0.1'; // Incremented version
    const WEEKDAYS = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    const XP_PER_REGULAR_ACHIEVEMENT = 10;
    // const XP_PER_QUEST_COMPLETED_BASE = 50; // Quest logic simplified for now
    // const MAX_WEEKLY_QUESTS = 5;
    
    let trackerData = {
        areas: [],
        achievements: {}, 
        // quests: {}, // Quest logic simplified for now
        currentWeekStartDate: null, 
        viewMode: 'week', 
        selectedDayIndex: 0, 
    };

    const DOM_XP = {
        controlsBar: document.getElementById('controlsBar'),
        prevWeekBtn: document.getElementById('prevWeekBtn'),
        thisWeekBtn: document.getElementById('thisWeekBtn'),
        nextWeekBtn: document.getElementById('nextWeekBtn'),
        currentWeekDisplay: document.getElementById('currentWeekDisplay'),
        weekCountDisplay: document.getElementById('weekCountDisplay'),
        toggleViewBtn: document.getElementById('toggleViewBtn'),
        showQuestsBtn: document.getElementById('showQuestsBtn'),
        addAreaBtn: document.getElementById('addAreaBtn'),
        weekdayHeaders: document.getElementById('weekdayHeaders'),
        gridBody: document.getElementById('gridBody'),
        gridTable: document.getElementById('gridTable'),
    };
    
    function decodeHtmlEntities(text) {
        if (typeof text !== 'string') return text;
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        return textarea.value;
    }

    function getMondayOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay(); // Sunday - 0, Monday - 1, ..., Saturday - 6
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
        return new Date(d.setDate(diff));
    }
    
    function getTodayAtMidnight() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return today;
    }


    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    
    function parseYYYYMMDDToLocalDate(dateString) {
        if (!dateString || typeof dateString !== 'string') return null;
        const parts = dateString.split('-');
        if (parts.length !== 3) return null;
        const [year, month, day] = parts.map(Number);
        if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
        return new Date(year, month - 1, day); 
    }

    function getDayOfYear(date) {
        const startOfYear = new Date(date.getFullYear(), 0, 0);
        const diff = date - startOfYear;
        const oneDay = 1000 * 60 * 60 * 24;
        return Math.floor(diff / oneDay);
    }


    function loadTrackerData() {
        const stored = localStorage.getItem(XP_TRACKER_STORAGE_KEY);
        const today = getTodayAtMidnight();
        const defaultMonday = getMondayOfWeek(today).toISOString().split('T')[0];

        if (stored) {
            try {
                trackerData = JSON.parse(stored);
                trackerData.currentWeekStartDate = trackerData.currentWeekStartDate || defaultMonday;
                trackerData.areas = trackerData.areas || [];
                trackerData.achievements = trackerData.achievements || {};
                // trackerData.quests = trackerData.quests || {}; // Simplified
                trackerData.viewMode = trackerData.viewMode || 'week';
                trackerData.selectedDayIndex = typeof trackerData.selectedDayIndex === 'number' ? trackerData.selectedDayIndex : 0;

            } catch (e) {
                console.error("Error loading XP Tracker data, resetting.", e);
                resetTrackerData(defaultMonday);
            }
        } else {
            resetTrackerData(defaultMonday);
        }
    }
    
    function resetTrackerData(defaultMondayStr) {
        trackerData = {
            areas: [], achievements: {}, // quests: {},
            currentWeekStartDate: defaultMondayStr,
            viewMode: 'week', selectedDayIndex: 0,
        };
    }

    function saveTrackerData() {
        localStorage.setItem(XP_TRACKER_STORAGE_KEY, JSON.stringify(trackerData));
    }

    function updateDateDisplay() {
        const currentMonday = parseYYYYMMDDToLocalDate(trackerData.currentWeekStartDate);
        if (!currentMonday) { // Fallback if date parsing fails
            DOM_XP.currentWeekDisplay.textContent = "Error: Invalid Date";
            DOM_XP.weekCountDisplay.textContent = "";
            return;
        }

        if (trackerData.viewMode === 'week') {
            const weekEndDate = new Date(currentMonday);
            weekEndDate.setDate(currentMonday.getDate() + 6);
            const options = { month: 'short', day: 'numeric' };
            DOM_XP.currentWeekDisplay.textContent = `${currentMonday.toLocaleDateString(undefined, options)} - ${weekEndDate.toLocaleDateString(undefined, options)}`;
            DOM_XP.weekCountDisplay.textContent = `Year Week: ${getWeekNumber(currentMonday)}`;
        } else {
            const selectedDate = new Date(currentMonday);
            const currentDayIndex = (typeof trackerData.selectedDayIndex === 'number' && trackerData.selectedDayIndex >= 0 && trackerData.selectedDayIndex <=6) ? trackerData.selectedDayIndex : 0;
            selectedDate.setDate(selectedDate.getDate() + currentDayIndex);
            const dayDisplayOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            DOM_XP.currentWeekDisplay.textContent = selectedDate.toLocaleDateString(undefined, dayDisplayOptions);
            DOM_XP.weekCountDisplay.textContent = `Year Day: ${getDayOfYear(selectedDate)}`;
        }
    }
    
    function renderWeekdayHeaders() {
        DOM_XP.weekdayHeaders.innerHTML = '<th>Area</th>';
        if (trackerData.viewMode === 'week') {
            WEEKDAYS.forEach(day => {
                const th = document.createElement('th');
                th.textContent = day;
                DOM_XP.weekdayHeaders.appendChild(th);
            });
        } else {
            const th = document.createElement('th');
            const currentMonday = parseYYYYMMDDToLocalDate(trackerData.currentWeekStartDate);
            if (!currentMonday) return; // Should not happen if loadTrackerData is correct
            const dayDate = new Date(currentMonday);
            const currentDayIndex = (typeof trackerData.selectedDayIndex === 'number' && trackerData.selectedDayIndex >= 0 && trackerData.selectedDayIndex <=6) ? trackerData.selectedDayIndex : 0;
            dayDate.setDate(dayDate.getDate() + currentDayIndex);
            th.textContent = `${WEEKDAYS[currentDayIndex]}, ${dayDate.toLocaleDateString(undefined, {month: 'short', day: 'numeric'})}`;
            DOM_XP.weekdayHeaders.appendChild(th);
        }
    }

    function xpForNextLevel(currentLevel) {
        if (currentLevel <= 0) return 50; 
        return Math.floor(50 * Math.pow(currentLevel, 1.5));
    }
    
    function renderGrid() {
        DOM_XP.gridBody.innerHTML = '';
        if (!trackerData.currentWeekStartDate) {
            console.error("Cannot render grid: currentWeekStartDate is not set.");
            return;
        }
        trackerData.areas.forEach(area => {
            const tr = document.createElement('tr');
            tr.dataset.areaName = area.name;

            const nameTd = document.createElement('td');
            nameTd.className = 'area-name-cell';
            const currentXP = area.xp || 0;
            const currentLevel = area.level || 1;
            const xpToNext = xpForNextLevel(currentLevel);
            const percentage = xpToNext > 0 ? Math.min((currentXP / xpToNext) * 100, 100) : (currentXP > 0 ? 100 : 0);

            nameTd.innerHTML = `
                <div class="area-name-wrapper">
                    <span>${decodeHtmlEntities(area.name)}</span>
                    <button class="xp-button delete-area-btn" data-area-name="${area.name}" title="Delete ${decodeHtmlEntities(area.name)}">X</button>
                </div>
                <div class="area-stats">
                    <span>Level: <span class="area-level">${currentLevel}</span></span>
                    <div class="xp-bar-container">
                        <div class="xp-bar" style="width: ${percentage}%;"></div>
                        <div class="xp-bar-text"><span class="area-xp">${currentXP}</span> / ${xpToNext} XP</div>
                    </div>
                </div>`;
            tr.appendChild(nameTd);

            const renderCellContent = (td, areaName, dayIdx) => {
                const achievementsKey = `${trackerData.currentWeekStartDate}_${areaName}_${dayIdx}`;
                const cellAchievements = trackerData.achievements[achievementsKey] || [];
                
                cellAchievements.forEach(ach => {
                    const achDiv = document.createElement('div');
                    achDiv.className = 'achievement-item';
                    achDiv.dataset.achId = ach.id;
                    achDiv.dataset.achKey = achievementsKey;

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'achievement-content';
                    if (ach.type === 'text') {
                        contentDiv.textContent = decodeHtmlEntities(ach.content);
                    } else if (ach.type === 'image' && ach.content) {
                        const img = document.createElement('img');
                        img.src = ach.content; 
                        img.alt = "Achievement Image";
                        contentDiv.appendChild(img);
                    }
                    achDiv.appendChild(contentDiv);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'achievement-item-actions';
                    actionsDiv.innerHTML = `
                        <button class="xp-button xp-button-small edit-ach-btn" data-ach-key="${achievementsKey}" data-ach-id="${ach.id}" title="Edit">Edit</button>
                        <button class="xp-button xp-button-small remove-ach-btn" data-ach-key="${achievementsKey}" data-ach-id="${ach.id}" title="Delete">Delete</button>
                    `;
                    achDiv.appendChild(actionsDiv);
                    td.appendChild(achDiv);
                });

                const addAchBtn = document.createElement('button');
                addAchBtn.className = 'xp-button achievement-add-btn-cell';
                addAchBtn.textContent = '+';
                addAchBtn.dataset.areaName = areaName;
                addAchBtn.dataset.dayIndex = dayIdx;
                const currentMondayForTitle = parseYYYYMMDDToLocalDate(trackerData.currentWeekStartDate);
                if(currentMondayForTitle){
                    const dayDate = new Date(currentMondayForTitle);
                    dayDate.setDate(dayDate.getDate() + dayIdx);
                    addAchBtn.title = `Add achievement to ${decodeHtmlEntities(areaName)} on ${WEEKDAYS[dayIdx]}, ${dayDate.toLocaleDateString(undefined, {month: 'short', day: 'numeric'})}`;
                }
                td.appendChild(addAchBtn);
            };

            if (trackerData.viewMode === 'week') {
                WEEKDAYS.forEach((day, dayIndex) => {
                    const td = document.createElement('td');
                    td.dataset.areaName = area.name;
                    td.dataset.dayIndex = dayIndex;
                    renderCellContent(td, area.name, dayIndex);
                    tr.appendChild(td);
                });
            } else { 
                const dayIndex = (typeof trackerData.selectedDayIndex === 'number' && trackerData.selectedDayIndex >= 0 && trackerData.selectedDayIndex <=6) ? trackerData.selectedDayIndex : 0;
                const td = document.createElement('td');
                td.dataset.areaName = area.name;
                td.dataset.dayIndex = dayIndex;
                renderCellContent(td, area.name, dayIndex);
                tr.appendChild(td);
            }
            DOM_XP.gridBody.appendChild(tr);
        });
        checkControlsBarLayout();
    }
    
    function checkControlsBarLayout() {
        const controlsBar = DOM_XP.controlsBar;
        if (!controlsBar || !controlsBar.clientWidth) return;

        const children = [
            controlsBar.querySelector('.week-navigation'),
            controlsBar.querySelector('.controls-group'),
            controlsBar.querySelector('.global-actions')
        ].filter(el => el);

        if (children.length === 0) return;

        const originalClasses = controlsBar.className;
        controlsBar.className = 'controls-bar layout-single-row'; 
        let totalChildrenWidth = 0;
        children.forEach(child => {
            const childStyle = getComputedStyle(child);
            totalChildrenWidth += child.scrollWidth + parseFloat(childStyle.marginLeft) + parseFloat(childStyle.marginRight);
        });
        controlsBar.className = originalClasses; 

        const controlsBarClientWidth = controlsBar.clientWidth - (parseFloat(getComputedStyle(controlsBar).paddingLeft) + parseFloat(getComputedStyle(controlsBar).paddingRight));

        if (totalChildrenWidth > controlsBarClientWidth && controlsBarClientWidth > 0) {
            controlsBar.classList.add('layout-multi-row');
            controlsBar.classList.remove('layout-single-row');
        } else {
            controlsBar.classList.add('layout-single-row');
            controlsBar.classList.remove('layout-multi-row');
        }
    }


    function addTrackerEventListeners() {
        DOM_XP.addAreaBtn.addEventListener('click', () => {
            const name = prompt("Enter new area name:");
            if (name && name.trim()) {
                if (trackerData.areas.find(a => a.name.toLowerCase() === name.trim().toLowerCase())) {
                    alert("Area with this name already exists.");
                    return;
                }
                trackerData.areas.push({ name: name.trim(), level: 1, xp: 0 });
                renderGrid();
                saveTrackerData();
            }
        });
        
        DOM_XP.gridBody.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('delete-area-btn')) {
                const areaName = target.dataset.areaName;
                if (areaName && confirm(`Are you sure you want to delete area "${decodeHtmlEntities(areaName)}"?`)) {
                    trackerData.areas = trackerData.areas.filter(a => a.name !== areaName);
                    Object.keys(trackerData.achievements).forEach(key => {
                        if (key.includes(`_${areaName}_`)) delete trackerData.achievements[key];
                    });
                    renderGrid();
                    saveTrackerData();
                }
            } else if (target.classList.contains('achievement-add-btn-cell')) {
                const areaName = target.dataset.areaName;
                const dayIndex = parseInt(target.dataset.dayIndex);
                const achievementText = prompt(`Add achievement for ${decodeHtmlEntities(areaName)} on ${WEEKDAYS[dayIndex]}:`);
                if (achievementText && achievementText.trim()) {
                    const achievementsKey = `${trackerData.currentWeekStartDate}_${areaName}_${dayIndex}`;
                    if (!trackerData.achievements[achievementsKey]) trackerData.achievements[achievementsKey] = [];
                    trackerData.achievements[achievementsKey].push({
                        id: Date.now().toString() + Math.random().toString(16).substring(2),
                        type: 'text',
                        content: achievementText.trim(),
                        xp: XP_PER_REGULAR_ACHIEVEMENT,
                        timestamp: new Date().toISOString()
                    });
                    const area = trackerData.areas.find(a => a.name === areaName);
                    if (area) {
                        area.xp = (area.xp || 0) + XP_PER_REGULAR_ACHIEVEMENT;
                        let requiredForNext = xpForNextLevel(area.level || 1);
                        while (area.xp >= requiredForNext && requiredForNext > 0) {
                            area.xp -= requiredForNext;
                            area.level = (area.level || 1) + 1;
                            requiredForNext = xpForNextLevel(area.level);
                        }
                    }
                    renderGrid();
                    saveTrackerData();
                }
            } else if (target.classList.contains('remove-ach-btn')) {
                 const achKey = target.dataset.achKey;
                 const achId = target.dataset.achId;
                 if (achKey && achId && trackerData.achievements[achKey]) {
                    const achievementIndex = trackerData.achievements[achKey].findIndex(a => a.id === achId);
                    if (achievementIndex > -1) {
                        const removedAch = trackerData.achievements[achKey].splice(achievementIndex, 1)[0];
                        const areaNameParts = achKey.split('_');
                        const areaName = areaNameParts.slice(1, areaNameParts.length -1).join('_');
                        const area = trackerData.areas.find(a => a.name === areaName);
                        if (area && removedAch) {
                            area.xp = Math.max(0, (area.xp || 0) - (removedAch.xp || 0));
                        }
                        if (trackerData.achievements[achKey].length === 0) delete trackerData.achievements[achKey];
                        renderGrid();
                        saveTrackerData();
                    }
                 }
            }
        });

        DOM_XP.prevWeekBtn.addEventListener('click', () => navigateDate(-1));
        DOM_XP.nextWeekBtn.addEventListener('click', () => navigateDate(1));
        DOM_XP.thisWeekBtn.addEventListener('click', goToThisWeek);
        DOM_XP.toggleViewBtn.addEventListener('click', toggleViewMode);
        
        DOM_XP.showQuestsBtn.addEventListener('click', () => {
            alert("Quests feature simplified for this version.");
        });
        
        new ResizeObserver(checkControlsBarLayout).observe(DOM_XP.controlsBar);
    }
    
    function navigateDate(offset) { 
        const currentMon = parseYYYYMMDDToLocalDate(trackerData.currentWeekStartDate);
        if(!currentMon) return;

        if (trackerData.viewMode === 'week') {
            currentMon.setDate(currentMon.getDate() + (offset * 7));
            trackerData.currentWeekStartDate = currentMon.toISOString().split('T')[0];
        } else { 
            let newDayIndex = trackerData.selectedDayIndex + offset;
            if (newDayIndex < 0) {
                currentMon.setDate(currentMon.getDate() - 7); 
                trackerData.currentWeekStartDate = getMondayOfWeek(currentMon).toISOString().split('T')[0];
                trackerData.selectedDayIndex = 6; 
            } else if (newDayIndex > 6) {
                currentMon.setDate(currentMon.getDate() + 7); 
                trackerData.currentWeekStartDate = getMondayOfWeek(currentMon).toISOString().split('T')[0];
                trackerData.selectedDayIndex = 0; 
            } else {
                trackerData.selectedDayIndex = newDayIndex;
            }
        }
        updateDateDisplay();
        renderWeekdayHeaders();
        renderGrid();
        saveTrackerData();
    }

    function goToThisWeek() {
        const today = getTodayAtMidnight();
        trackerData.currentWeekStartDate = getMondayOfWeek(today).toISOString().split('T')[0];
        if(trackerData.viewMode === 'day') {
            let currentDayOfWeek = today.getDay(); 
            trackerData.selectedDayIndex = (currentDayOfWeek === 0) ? 6 : currentDayOfWeek - 1;
        }
        updateDateDisplay();
        renderWeekdayHeaders();
        renderGrid();
        saveTrackerData();
    }

    function toggleViewMode() {
        if (trackerData.viewMode === 'week') {
            trackerData.viewMode = 'day';
            DOM_XP.toggleViewBtn.textContent = 'Week View';
            DOM_XP.prevWeekBtn.textContent = '< Prev Day';
            DOM_XP.nextWeekBtn.textContent = 'Next Day >';
            DOM_XP.thisWeekBtn.textContent = 'Today';
            const today = getTodayAtMidnight();
            const currentMon = parseYYYYMMDDToLocalDate(trackerData.currentWeekStartDate);
            if(currentMon){
                const currentSun = new Date(currentMon);
                currentSun.setDate(currentMon.getDate() + 6);
                if (today >= currentMon && today <= currentSun) {
                    trackerData.selectedDayIndex = (today.getDay() === 0) ? 6 : today.getDay() - 1;
                } else {
                    trackerData.selectedDayIndex = 0; 
                }
            } else {
                 trackerData.selectedDayIndex = 0;
            }


        } else {
            trackerData.viewMode = 'week';
            DOM_XP.toggleViewBtn.textContent = 'Day View';
            DOM_XP.prevWeekBtn.textContent = '< Prev Week';
            DOM_XP.nextWeekBtn.textContent = 'Next Week >';
            DOM_XP.thisWeekBtn.textContent = 'This Week';
        }
        updateDateDisplay();
        renderWeekdayHeaders();
        renderGrid();
        saveTrackerData();
    }


    document.addEventListener('DOMContentLoaded', () => {
        loadTrackerData(); // This will set currentWeekStartDate correctly
        updateDateDisplay();
        renderWeekdayHeaders();
        renderGrid();
        addTrackerEventListeners();
        checkControlsBarLayout(); 
    });
</script>