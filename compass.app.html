<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compass</title>
    <style>
        body { margin: 0; padding: 0; font-family: "Tahoma", "Geneva", sans-serif; font-size: 11px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background-color: #ECE9D8; color: #000000; }
        .xp-button { background-color: #ECE9D8; border: 1px outset #7F7F7F; padding: 5px 12px; min-width: 75px; text-align: center; cursor: pointer; margin: 2px; }
        .xp-button:active { border-style: inset; }
        .xp-button:hover:not(:disabled) { border-color: #005CFE; background-color: #F0F8FF; }
        .xp-button:disabled { color: #7F7F7F; border-color: #ACA899; cursor: default; opacity: 0.7; }
        .xp-button-small { padding: 2px 5px; font-size: 10px; min-width: auto; margin: 0 2px;}

        .compass-app-container { display: flex; flex-direction: column; width: 100%; height: 100%; box-sizing: border-box; }
        .compass-top-bar { display: flex; justify-content: space-between; align-items: center; padding: 5px 8px; background-color: #ECE9D8; border-bottom: 1px solid #ACA899; flex-shrink: 0; flex-wrap: wrap; gap: 5px; }
        .compass-search-area { display: flex; flex-grow: 1; min-width: 200px; }
        #compassSearchInput { flex-grow: 1; margin-right: 5px; border: 1px inset #7F7F7F; padding: 5px; font-family: "Tahoma", "Geneva", sans-serif; font-size: 11px; background-color: #FFFFFF; }
        .compass-main-content { display: flex; flex-grow: 1; overflow: hidden; }
        .compass-map-area { flex-grow: 1; display: flex; flex-direction: column; border-right: 1px solid #ACA899; }
        #compassMapFrameContainer { position: relative; flex-grow: 1; background-color: #808080; display: flex; justify-content: center; align-items: center; border-top: 1px solid #7F7F7F; }
        #compassMapFrame { width: 100%; height: 100%; border: none; }
        #compassMapOverlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); color: white; display: flex; justify-content: center; align-items: center; font-size: 14px; text-align: center; padding: 20px; z-index: 10; margin-left: 5px #ECE9D8; margin-bottom: 5px }
        .compass-landmark-sidebar { width: 220px; flex-shrink: 0; background-color: #F0F0F0; display: flex; flex-direction: column; overflow: hidden; }
        .compass-landmark-header { padding: 8px; font-weight: bold; background-color: #D4D0C8; border-bottom: 1px solid #808080; text-align: center; flex-shrink: 0; }
        #compassLandmarkList { list-style-type: none; margin: 0; padding: 5px; overflow-y: auto; flex-grow: 1; }
        .compass-landmark-item { padding: 8px; border: 1px outset #FFFFFF; border-bottom-color: #808080; border-right-color: #808080; margin-bottom: 4px; background-color: #FFFFFF; cursor: pointer; }
        .compass-landmark-item:hover { border: 1px solid #005CFE; background-color: #F0F8FF; }
        .landmark-item-name { font-weight: bold; color: #0039A9; word-wrap: break-word; }
        .landmark-item-coords { font-size: 10px; color: #555; margin-top: 3px; }
        .landmark-item-actions { margin-top: 5px; text-align: right; }
        #compassAddLandmarkBtn { flex-shrink: 0; margin-left: 5px; }

        .compass-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .compass-modal-content { background-color: #ECE9D8; margin: auto; padding: 0; border: 1px solid #000; width: 80%; max-width: 400px; box-shadow: 5px 5px 15px rgba(0,0,0,0.5); animation: compassFadeIn 0.3s; display: flex; flex-direction: column; }
        .compass-modal-title-bar { background: linear-gradient(to bottom, #005CFE, #0039A9); color: white; padding: 5px 8px; font-weight: bold; border-bottom: 1px solid #000; display: flex; justify-content: space-between; align-items: center; height: 28px; box-sizing: border-box; flex-shrink: 0; }
        .compass-modal-close-button { color: white; font-size: 16px; font-family: "Marlett", "Webdings", sans-serif; font-weight: normal; background: #E04343; border: 1px outset white; width: 22px; height: 18px; text-align: center; line-height: 16px; padding: 0; cursor: pointer; }
        .compass-modal-close-button:hover { background: #FF6363; }
        .compass-modal-body { padding: 15px; }
        .compass-modal-body p { margin-top: 0; }
        .compass-modal-body label { display: block; margin-bottom: 5px; margin-top: 10px; }
        .compass-modal-body input[type="text"] { width: calc(100% - 12px); padding: 5px; border: 1px inset #7F7F7F; }
        .compass-modal-footer { padding: 10px 15px; text-align: right; background-color: #F0F0F0; border-top: 1px solid #ACA899; }
        @keyframes compassFadeIn { from {opacity: 0; transform: scale(0.9);} to {opacity: 1; transform: scale(1);} }
    </style>
</head>
<body>

<div class="compass-app-container">
    <div class="compass-top-bar">
        <div class="compass-search-area">
            <input type="text" id="compassSearchInput" placeholder="Search for a location...">
            <button id="compassSearchBtn" class="xp-button">Search</button>
        </div>
        <button id="compassCurrentLocationBtn" class="xp-button">My Location</button>
        <button id="compassAddLandmarkBtn" class="xp-button">Add Landmark</button>
    </div>
    <div class="compass-main-content">
        <div class="compass-map-area">
            <div id="compassMapFrameContainer">
                <iframe id="compassMapFrame" src="about:blank"></iframe>
                <div id="compassMapOverlay" style="display: none;"></div>
            </div>
        </div>
        <div class="compass-landmark-sidebar">
            <div class="compass-landmark-header">Landmarks</div>
            <ul id="compassLandmarkList">
            </ul>
        </div>
    </div>
</div>

<div id="compassAddLandmarkModal" class="compass-modal">
    <div class="compass-modal-content">
        <div class="compass-modal-title-bar">
            <span>Add Landmark</span>
            <span class="compass-modal-close-button" data-modal-id="compassAddLandmarkModal">r</span>
        </div>
        <div class="compass-modal-body">
            <p>Enter a name for the current map location.</p>
            <label for="landmarkNameInput">Name:</label>
            <input type="text" id="landmarkNameInput" placeholder="e.g., Favorite Coffee Shop">
        </div>
        <div class="compass-modal-footer">
            <button id="landmarkSaveBtn" class="xp-button">Save</button>
            <button class="xp-button compass-modal-cancel-btn" data-modal-id="compassAddLandmarkModal">Cancel</button>
        </div>
    </div>
</div>

<div id="compassConfirmDeleteModal" class="compass-modal">
    <div class="compass-modal-content">
        <div class="compass-modal-title-bar">
            <span>Confirm Deletion</span>
            <span class="compass-modal-close-button" data-modal-id="compassConfirmDeleteModal">r</span>
        </div>
        <div class="compass-modal-body">
            <p id="compassConfirmDeleteMessage">Are you sure you want to delete this landmark?</p>
        </div>
        <div class="compass-modal-footer">
            <button id="compassExecuteDeleteBtn" class="xp-button">Delete</button>
            <button class="xp-button compass-modal-cancel-btn" data-modal-id="compassConfirmDeleteModal">Cancel</button>
        </div>
    </div>
</div>

<script>
    const COMPASS_STORAGE_KEY = 'compassAppData_v3';
    let compassData = {
        landmarks: []
    };
    let currentMapLocation = { lat: 0, lon: 0 };
    let GEMINI_API_KEY = "";

    const DOM = {
        searchInput: document.getElementById('compassSearchInput'),
        searchBtn: document.getElementById('compassSearchBtn'),
        currentLocationBtn: document.getElementById('compassCurrentLocationBtn'),
        addLandmarkBtn: document.getElementById('compassAddLandmarkBtn'),
        mapFrame: document.getElementById('compassMapFrame'),
        mapOverlay: document.getElementById('compassMapOverlay'),
        landmarkList: document.getElementById('compassLandmarkList'),
        addLandmarkModal: document.getElementById('compassAddLandmarkModal'),
        landmarkNameInput: document.getElementById('landmarkNameInput'),
        landmarkSaveBtn: document.getElementById('landmarkSaveBtn'),
        confirmDeleteModal: document.getElementById('compassConfirmDeleteModal'),
        confirmDeleteMessage: document.getElementById('compassConfirmDeleteMessage'),
        executeDeleteBtn: document.getElementById('compassExecuteDeleteBtn'),
    };
    
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'flex';
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'none';
    }

    function loadCompassData() {
        const stored = localStorage.getItem(COMPASS_STORAGE_KEY);
        if (stored) {
            try {
                const parsedData = JSON.parse(stored);
                compassData.landmarks = parsedData.landmarks || [];
            } catch (e) {
                console.error("Error loading Compass data, resetting.", e);
                compassData = { landmarks: [] };
            }
        }
    }

    function saveCompassData() {
        localStorage.setItem(COMPASS_STORAGE_KEY, JSON.stringify(compassData));
    }

    function updateMap(lat, lon, zoom = 14) {
        currentMapLocation.lat = lat;
        currentMapLocation.lon = lon;
        const embedUrl = `https://maps.google.com/maps?q=${lat},${lon}&hl=en&z=${zoom}&output=embed`;
        DOM.mapFrame.src = embedUrl;
    }

    function handleGetCurrentLocation() {
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    updateMap(lat, lon);
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    alert(`Error getting location: ${error.message}`);
                },
                { enableHighAccuracy: true }
            );
        } else {
            alert("Geolocation is not supported by your browser.");
        }
    }

    async function handleSearchLocation() {
        const query = DOM.searchInput.value.trim();
        if (!query) {
            alert("Please enter a location to search.");
            return;
        }

        if (!GEMINI_API_KEY) {
            alert("Cannot search: API key is not available. Ensure the app is running inside Life XP.");
            return;
        }

        DOM.mapOverlay.textContent = `Finding "${query}"...`;
        DOM.mapOverlay.style.display = 'flex';
        let success = false;

        const prompt = `Provide the approximate latitude and longitude for: '${query}'. Respond ONLY with a JSON object like {"lat": 48.8584, "lon": 2.2945}. No other text.`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
            });

            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            
            const data = await response.json();
            const textResponse = data.candidates[0].content.parts[0].text;
            const jsonString = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
            const coords = JSON.parse(jsonString);

            if (coords && typeof coords.lat === 'number' && typeof coords.lon === 'number') {
                updateMap(coords.lat, coords.lon);
                success = true;
            } else {
                throw new Error("Invalid coordinates received from API.");
            }
        } catch (error) {
            console.error("Error geocoding location:", error);
            DOM.mapOverlay.textContent = `Could not find coordinates for "${query}".`;
            setTimeout(() => {
                DOM.mapOverlay.style.display = 'none';
            }, 2500);
        } finally {
            if (success) {
                DOM.mapOverlay.style.display = 'none';
            }
        }
    }


    function renderLandmarkList() {
        DOM.landmarkList.innerHTML = '';
        if (compassData.landmarks.length === 0) {
            DOM.landmarkList.innerHTML = '<li style="padding: 10px; text-align: center; color: #555;">No saved landmarks.</li>';
            return;
        }
        compassData.landmarks.forEach((landmark, index) => {
            const li = document.createElement('li');
            li.className = 'compass-landmark-item';
            li.dataset.index = index;
            li.innerHTML = `
                <div class="landmark-item-name">${landmark.name}</div>
                <div class="landmark-item-coords">Lat: ${Number(landmark.lat).toFixed(4)}, Lon: ${Number(landmark.lon).toFixed(4)}</div>
                <div class="landmark-item-actions">
                    <button class="xp-button xp-button-small landmark-delete-btn" data-index="${index}">Delete</button>
                </div>
            `;
            li.addEventListener('click', (e) => {
                if (e.target.classList.contains('landmark-delete-btn')) return;
                updateMap(landmark.lat, landmark.lon);
            });
            DOM.landmarkList.appendChild(li);
        });
        
        document.querySelectorAll('.landmark-delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const indexToDelete = parseInt(e.target.dataset.index);
                DOM.confirmDeleteMessage.textContent = `Are you sure you want to delete "${compassData.landmarks[indexToDelete].name}"?`;
                DOM.executeDeleteBtn.dataset.indexToDelete = indexToDelete;
                openModal('compassConfirmDeleteModal');
            });
        });
    }

    function executeLandmarkDeletion() {
        const indexToDelete = parseInt(DOM.executeDeleteBtn.dataset.indexToDelete);
        if (!isNaN(indexToDelete)) {
            compassData.landmarks.splice(indexToDelete, 1);
            saveCompassData();
            renderLandmarkList();
        }
        closeModal('compassConfirmDeleteModal');
    }
    
    function openAddLandmarkModal() {
        DOM.landmarkNameInput.value = '';
        openModal('compassAddLandmarkModal');
        DOM.landmarkNameInput.focus();
    }
    
    function saveNewLandmark() {
        const name = DOM.landmarkNameInput.value.trim();
        if (!name) {
            alert("Please enter a name for the Landmark.");
            return;
        }
        
        compassData.landmarks.push({ name, lat: currentMapLocation.lat, lon: currentMapLocation.lon });
        saveCompassData();
        renderLandmarkList();
        closeModal('compassAddLandmarkModal');
    }

    function addEventListeners() {
        DOM.currentLocationBtn.addEventListener('click', handleGetCurrentLocation);
        DOM.searchBtn.addEventListener('click', handleSearchLocation);
        DOM.searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearchLocation(); });
        DOM.addLandmarkBtn.addEventListener('click', openAddLandmarkModal);
        DOM.landmarkSaveBtn.addEventListener('click', saveNewLandmark);
        DOM.executeDeleteBtn.addEventListener('click', executeLandmarkDeletion);

        document.querySelectorAll('.compass-modal-close-button, .compass-modal-cancel-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                closeModal(e.target.dataset.modalId);
            });
        });
    }
    
    window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'apiKeyResponse' && event.data.service === 'gemini') {
            GEMINI_API_KEY = event.data.key;
            console.log("Compass App: Gemini API Key received.");
            if (!GEMINI_API_KEY) console.warn("Compass: Gemini API Key from OS is empty. Search will be disabled.");
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadCompassData();
        addEventListeners();
        renderLandmarkList();
        handleGetCurrentLocation();
        
        if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'requestApiKey', service: 'gemini', appId: 'compass' }, '*');
        } else {
            console.warn("Compass App: Not running inside the Life XP shell. API features will be unavailable.");
        }
    });

</script>
</body>
</html>
