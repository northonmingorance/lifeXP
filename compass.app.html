<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compass</title>
    <style>
        body { margin: 0; padding: 0; font-family: "Tahoma", "Geneva", sans-serif; font-size: 11px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background-color: #ECE9D8; color: #000000; }
        .xp-button { background-color: #ECE9D8; border: 1px outset #7F7F7F; padding: 5px 12px; min-width: 75px; text-align: center; cursor: pointer; margin: 2px; }
        .xp-button:active { border-style: inset; }
        .xp-button:hover:not(:disabled) { border-color: #005CFE; background-color: #F0F8FF; }
        .xp-button:disabled { color: #7F7F7F; border-color: #ACA899; cursor: default; opacity: 0.7; }
        .xp-button-small { padding: 2px 5px; font-size: 10px; min-width: auto; margin: 0 2px;}

        .compass-app-container { display: flex; flex-direction: column; width: 100%; height: 100%; box-sizing: border-box; }
        .compass-top-bar { display: flex; justify-content: space-between; align-items: center; padding: 5px 8px; background-color: #ECE9D8; border-bottom: 1px solid #ACA899; flex-shrink: 0; flex-wrap: wrap; gap: 5px; }
        .compass-search-area { display: flex; flex-grow: 1; min-width: 200px; }
        #compassSearchInput { flex-grow: 1; margin-right: 5px; border: 1px inset #7F7F7F; padding: 5px; font-family: "Tahoma", "Geneva", sans-serif; font-size: 11px; background-color: #FFFFFF; }
        .compass-main-content { display: flex; flex-grow: 1; overflow: hidden; }
        .compass-map-area { flex-grow: 1; display: flex; flex-direction: column; border-right: 1px solid #ACA899; }
        #compassMapFrameContainer { flex-grow: 1; background-color: #808080; display: flex; justify-content: center; align-items: center; border-top: 1px solid #7F7F7F; }
        #compassMapFrame { width: 100%; height: 100%; border: none; }
        .compass-landmark-sidebar { width: 220px; flex-shrink: 0; background-color: #F0F0F0; display: flex; flex-direction: column; overflow: hidden; }
        .compass-landmark-header { padding: 8px; font-weight: bold; background-color: #D4D0C8; border-bottom: 1px solid #808080; text-align: center; flex-shrink: 0; }
        #compassLandmarkList { list-style-type: none; margin: 0; padding: 5px; overflow-y: auto; flex-grow: 1; }
        .compass-landmark-item { padding: 8px; border: 1px outset #FFFFFF; border-bottom-color: #808080; border-right-color: #808080; margin-bottom: 4px; background-color: #FFFFFF; cursor: pointer; }
        .compass-landmark-item:hover { border: 1px solid #005CFE; background-color: #F0F8FF; }
        .landmark-item-name { font-weight: bold; color: #0039A9; }
        .landmark-item-query { font-size: 10px; color: #555; margin-top: 3px; font-style: italic; }
        .landmark-item-actions { margin-top: 5px; text-align: right; }
        #compassAddLandmarkBtn { flex-shrink: 0; margin-left: 5px; }

        .compass-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .compass-modal-content { background-color: #ECE9D8; margin: auto; padding: 0; border: 1px solid #000; width: 80%; max-width: 400px; box-shadow: 5px 5px 15px rgba(0,0,0,0.5); animation: compassFadeIn 0.3s; display: flex; flex-direction: column; }
        .compass-modal-title-bar { background: linear-gradient(to bottom, #005CFE, #0039A9); color: white; padding: 5px 8px; font-weight: bold; border-bottom: 1px solid #000; display: flex; justify-content: space-between; align-items: center; height: 28px; box-sizing: border-box; flex-shrink: 0; }
        .compass-modal-close-button { color: white; font-size: 16px; font-family: "Marlett", "Webdings", sans-serif; font-weight: normal; background: #E04343; border: 1px outset white; width: 22px; height: 18px; text-align: center; line-height: 16px; padding: 0; cursor: pointer; }
        .compass-modal-close-button:hover { background: #FF6363; }
        .compass-modal-body { padding: 15px; }
        .compass-modal-body label { display: block; margin-bottom: 5px; margin-top: 10px; }
        .compass-modal-body input[type="text"] { width: calc(100% - 12px); padding: 5px; border: 1px inset #7F7F7F; }
        .compass-modal-footer { padding: 10px 15px; text-align: right; background-color: #F0F0F0; border-top: 1px solid #ACA899; }
        @keyframes compassFadeIn { from {opacity: 0; transform: scale(0.9);} to {opacity: 1; transform: scale(1);} }
    </style>
</head>
<body>

<div class="compass-app-container">
    <div class="compass-top-bar">
        <div class="compass-search-area">
            <input type="text" id="compassSearchInput" placeholder="Search for a location...">
            <button id="compassSearchBtn" class="xp-button">Search</button>
        </div>
        <button id="compassCurrentLocationBtn" class="xp-button">My Location</button>
        <button id="compassAddLandmarkBtn" class="xp-button">Add Landmark</button>
    </div>
    <div class="compass-main-content">
        <div class="compass-map-area">
            <div id="compassMapFrameContainer">
                <iframe id="compassMapFrame" src="about:blank"></iframe>
            </div>
        </div>
        <div class="compass-landmark-sidebar">
            <div class="compass-landmark-header">Landmarks</div>
            <ul id="compassLandmarkList">
            </ul>
        </div>
    </div>
</div>

<div id="compassAddLandmarkModal" class="compass-modal">
    <div class="compass-modal-content">
        <div class="compass-modal-title-bar">
            <span>Add Landmark</span>
            <span class="compass-modal-close-button" data-modal-id="compassAddLandmarkModal">r</span>
        </div>
        <div class="compass-modal-body">
            <p>Enter a name for the location in the search bar.</p>
            <label for="landmarkNameInput">Name:</label>
            <input type="text" id="landmarkNameInput" placeholder="e.g., Favorite Coffee Shop">
        </div>
        <div class="compass-modal-footer">
            <button id="landmarkSaveBtn" class="xp-button">Save</button>
            <button class="xp-button compass-modal-cancel-btn" data-modal-id="compassAddLandmarkModal">Cancel</button>
        </div>
    </div>
</div>

<script>
    // --- Application State ---
    const COMPASS_STORAGE_KEY = 'compassAppData_v3'; // Incremented version
    let compassData = {
        landmarks: [] // Will store objects like { name: "...", query: "..." }
    };
    // Keep track of lat/lon for the "My Location" feature, but not for saving landmarks.
    let currentMapLocation = { lat: 0, lon: 0 }; 

    // --- DOM Elements ---
    const DOM = {
        searchInput: document.getElementById('compassSearchInput'),
        searchBtn: document.getElementById('compassSearchBtn'),
        currentLocationBtn: document.getElementById('compassCurrentLocationBtn'),
        addLandmarkBtn: document.getElementById('compassAddLandmarkBtn'),
        mapFrame: document.getElementById('compassMapFrame'),
        landmarkList: document.getElementById('compassLandmarkList'),
        addLandmarkModal: document.getElementById('compassAddLandmarkModal'),
        landmarkNameInput: document.getElementById('landmarkNameInput'),
        landmarkSaveBtn: document.getElementById('landmarkSaveBtn'),
    };

    // --- Data Persistence ---
    function loadCompassData() {
        const stored = localStorage.getItem(COMPASS_STORAGE_KEY);
        if (stored) {
            try {
                const parsedData = JSON.parse(stored);
                // Ensure landmarks are loaded correctly, default to empty array if missing
                compassData.landmarks = parsedData.landmarks || [];
            } catch (e) {
                console.error("Error loading Compass data, resetting.", e);
                compassData = { landmarks: [] };
            }
        }
    }

    function saveCompassData() {
        localStorage.setItem(COMPASS_STORAGE_KEY, JSON.stringify(compassData));
    }

    // --- Map Functions ---
    function updateMapWithCoords(lat, lon, zoom = 14) {
        // This function is now specifically for coordinate-based updates (My Location)
        currentMapLocation.lat = lat;
        currentMapLocation.lon = lon;
        const embedUrl = `https://maps.google.com/maps?q=${lat},${lon}&hl=en&z=${zoom}&output=embed`;
        DOM.mapFrame.src = embedUrl;
    }
    
    function updateMapWithQuery(query) {
        // This function is for search-based updates
        const embedUrl = `https://maps.google.com/maps?q=${encodeURIComponent(query)}&hl=en&z=14&output=embed`;
        DOM.mapFrame.src = embedUrl;
    }

    // --- Event Handlers ---
    function handleGetCurrentLocation() {
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    updateMapWithCoords(lat, lon);
                    DOM.searchInput.value = ''; // Clear search input when using "My Location"
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    alert(`Error getting location: ${error.message}`);
                },
                { enableHighAccuracy: true }
            );
        } else {
            alert("Geolocation is not supported by your browser.");
        }
    }

    function handleSearchLocation() {
        const query = DOM.searchInput.value.trim();
        if (!query) {
            alert("Please enter a location to search.");
            return;
        }
        updateMapWithQuery(query);
    }
    
    // --- Landmark UI & Logic ---
    function renderLandmarkList() {
        DOM.landmarkList.innerHTML = '';
        if (compassData.landmarks.length === 0) {
            DOM.landmarkList.innerHTML = '<li style="padding: 10px; text-align: center; color: #555;">No saved landmarks.</li>';
            return;
        }
        // Sort landmarks alphabetically by name
        const sortedLandmarks = [...compassData.landmarks].sort((a, b) => a.name.localeCompare(b.name));

        sortedLandmarks.forEach((landmark) => {
            const li = document.createElement('li');
            li.className = 'compass-landmark-item';
            // Use landmark.query to find it in the original array for deletion
            li.dataset.query = landmark.query;
            li.dataset.name = landmark.name;

            li.innerHTML = `
                <div class="landmark-item-name">${landmark.name}</div>
                <div class="landmark-item-query">${landmark.query}</div>
                <div class="landmark-item-actions">
                    <button class="xp-button xp-button-small landmark-delete-btn">Delete</button>
                </div>
            `;
            
            // Main click action: search for the landmark's query
            li.addEventListener('click', (e) => {
                if (e.target.classList.contains('landmark-delete-btn')) return;
                DOM.searchInput.value = landmark.query;
                handleSearchLocation();
            });

            DOM.landmarkList.appendChild(li);
        });
        
        // Add delete functionality after rendering
        document.querySelectorAll('.landmark-delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent the main li click event
                const landmarkItem = e.target.closest('.compass-landmark-item');
                const landmarkName = landmarkItem.dataset.name;
                
                if (confirm(`Are you sure you want to delete "${landmarkName}"?`)) {
                    // Find and remove the landmark from the original data array
                    const indexToDelete = compassData.landmarks.findIndex(lm => lm.name === landmarkName && lm.query === landmarkItem.dataset.query);
                    if (indexToDelete > -1) {
                        compassData.landmarks.splice(indexToDelete, 1);
                        saveCompassData();
                        renderLandmarkList(); // Re-render the list
                    }
                }
            });
        });
    }
    
    function openAddLandmarkModal() {
        const query = DOM.searchInput.value.trim();
        if (!query) {
            alert("Please search for a location first before saving it as a landmark.");
            return;
        }
        DOM.landmarkNameInput.value = query; // Pre-fill name with the search query
        DOM.addLandmarkModal.style.display = 'flex';
        DOM.landmarkNameInput.focus();
        DOM.landmarkNameInput.select();
    }
    
    function closeAddLandmarkModal() {
        DOM.addLandmarkModal.style.display = 'none';
    }

    function saveNewLandmark() {
        const name = DOM.landmarkNameInput.value.trim();
        if (!name) {
            alert("Please enter a name for the landmark.");
            return;
        }
        
        // **MODIFIED**: Get the query from the search input instead of coordinates
        const query = DOM.searchInput.value.trim();
        if (!query) {
            // This case should be prevented by the check in openAddLandmarkModal, but good to have a safeguard
            alert("Cannot save a landmark without a location query.");
            return;
        }

        // Check for duplicates
        if (compassData.landmarks.some(lm => lm.name.toLowerCase() === name.toLowerCase())) {
            alert("A landmark with this name already exists. Please choose a different name.");
            return;
        }

        compassData.landmarks.push({ name, query });
        saveCompassData();
        renderLandmarkList();
        closeAddLandmarkModal();
    }

    // --- Initialization ---
    function addEventListeners() {
        DOM.currentLocationBtn.addEventListener('click', handleGetCurrentLocation);
        DOM.searchBtn.addEventListener('click', handleSearchLocation);
        DOM.searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSearchLocation();
            }
        });
        DOM.addLandmarkBtn.addEventListener('click', openAddLandmarkModal);
        DOM.landmarkSaveBtn.addEventListener('click', saveNewLandmark);

        // General modal close buttons
        document.querySelectorAll('.compass-modal-close-button, .compass-modal-cancel-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modalId;
                if (modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) modal.style.display = 'none';
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadCompassData();
        addEventListeners();
        renderLandmarkList();
        handleGetCurrentLocation(); // Get initial location on load
    });

</script>
</body>
</html>
