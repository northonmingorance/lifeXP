<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compass</title>
    <style>
        body { margin: 0; padding: 0; font-family: "Tahoma", "Geneva", sans-serif; font-size: 11px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background-color: #ECE9D8; color: #000000; }
        .xp-button { background-color: #ECE9D8; border: 1px outset #7F7F7F; padding: 5px 12px; min-width: 75px; text-align: center; cursor: pointer; margin: 2px; }
        .xp-button:active { border-style: inset; }
        .xp-button:hover:not(:disabled) { border-color: #005CFE; background-color: #F0F8FF; }
        .xp-button:disabled { color: #7F7F7F; border-color: #ACA899; cursor: default; opacity: 0.7; }
        .xp-button-small { padding: 2px 5px; font-size: 10px; min-width: auto; margin: 0 2px;}

        .compass-app-container { display: flex; flex-direction: column; width: 100%; height: 100%; box-sizing: border-box; }
        .compass-top-bar { display: flex; justify-content: space-between; align-items: center; padding: 5px 8px; background-color: #ECE9D8; border-bottom: 1px solid #ACA899; flex-shrink: 0; flex-wrap: wrap; gap: 5px; }
        .compass-search-area { display: flex; flex-grow: 1; min-width: 200px; }
        #compassSearchInput { flex-grow: 1; margin-right: 5px; border: 1px inset #7F7F7F; padding: 5px; font-family: "Tahoma", "Geneva", sans-serif; font-size: 11px; background-color: #FFFFFF; }
        .compass-main-content { display: flex; flex-grow: 1; overflow: hidden; }
        .compass-map-area { flex-grow: 1; display: flex; flex-direction: column; border-right: 1px solid #ACA899; }
        #compassMapFrameContainer { flex-grow: 1; background-color: #808080; display: flex; justify-content: center; align-items: center; border-top: 1px solid #7F7F7F; }
        #compassMapFrame { width: 100%; height: 100%; border: none; }
        .compass-landmark-sidebar { width: 220px; flex-shrink: 0; background-color: #F0F0F0; display: flex; flex-direction: column; overflow: hidden; }
        .compass-landmark-header { padding: 8px; font-weight: bold; background-color: #D4D0C8; border-bottom: 1px solid #808080; text-align: center; flex-shrink: 0; }
        #compassLandmarkList { list-style-type: none; margin: 0; padding: 5px; overflow-y: auto; flex-grow: 1; }
        .compass-landmark-item { padding: 8px; border: 1px outset #FFFFFF; border-bottom-color: #808080; border-right-color: #808080; margin-bottom: 4px; background-color: #FFFFFF; cursor: pointer; }
        .compass-landmark-item:hover { border: 1px solid #005CFE; background-color: #F0F8FF; }
        .landmark-item-name { font-weight: bold; color: #0039A9; }
        .landmark-item-coords { font-size: 10px; color: #555; margin-top: 3px; }
        .landmark-item-actions { margin-top: 5px; text-align: right; }
        #compassAddLandmarkBtn { flex-shrink: 0; margin-left: 5px; }

        .compass-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .compass-modal-content { background-color: #ECE9D8; margin: auto; padding: 0; border: 1px solid #000; width: 80%; max-width: 400px; box-shadow: 5px 5px 15px rgba(0,0,0,0.5); animation: compassFadeIn 0.3s; display: flex; flex-direction: column; }
        .compass-modal-title-bar { background: linear-gradient(to bottom, #005CFE, #0039A9); color: white; padding: 5px 8px; font-weight: bold; border-bottom: 1px solid #000; display: flex; justify-content: space-between; align-items: center; height: 28px; box-sizing: border-box; flex-shrink: 0; }
        .compass-modal-close-button { color: white; font-size: 16px; font-family: "Marlett", "Webdings", sans-serif; font-weight: normal; background: #E04343; border: 1px outset white; width: 22px; height: 18px; text-align: center; line-height: 16px; padding: 0; cursor: pointer; }
        .compass-modal-close-button:hover { background: #FF6363; }
        .compass-modal-body { padding: 15px; }
        .compass-modal-body label { display: block; margin-bottom: 5px; margin-top: 10px; }
        .compass-modal-body input[type="text"] { width: calc(100% - 12px); padding: 5px; border: 1px inset #7F7F7F; }
        .compass-modal-footer { padding: 10px 15px; text-align: right; background-color: #F0F0F0; border-top: 1px solid #ACA899; }
        @keyframes compassFadeIn { from {opacity: 0; transform: scale(0.9);} to {opacity: 1; transform: scale(1);} }
    </style>
</head>
<body>

<div class="compass-app-container">
    <div class="compass-top-bar">
        <div class="compass-search-area">
            <input type="text" id="compassSearchInput" placeholder="Search for a location...">
            <button id="compassSearchBtn" class="xp-button">Search</button>
        </div>
        <button id="compassCurrentLocationBtn" class="xp-button">My Location</button>
        <button id="compassAddLandmarkBtn" class="xp-button">Add Landmark</button>
    </div>
    <div class="compass-main-content">
        <div class="compass-map-area">
            <div id="compassMapFrameContainer">
                <iframe id="compassMapFrame" src="about:blank"></iframe>
            </div>
        </div>
        <div class="compass-landmark-sidebar">
            <div class="compass-landmark-header">Landmarks</div>
            <ul id="compassLandmarkList">
            </ul>
        </div>
    </div>
</div>

<div id="compassAddLandmarkModal" class="compass-modal">
    <div class="compass-modal-content">
        <div class="compass-modal-title-bar">
            <span>Add Landmark</span>
            <span class="compass-modal-close-button" data-modal-id="compassAddLandmarkModal">r</span>
        </div>
        <div class="compass-modal-body">
            <p>Enter a name for the current map location.</p>
            <label for="landmarkNameInput">Name:</label>
            <input type="text" id="landmarkNameInput" placeholder="e.g., Favorite Coffee Shop">
        </div>
        <div class="compass-modal-footer">
            <button id="landmarkSaveBtn" class="xp-button">Save</button>
            <button class="xp-button compass-modal-cancel-btn" data-modal-id="compassAddLandmarkModal">Cancel</button>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const COMPASS_STORAGE_KEY = 'compassAppData_v2';
    // IMPORTANT: To enable location searching, you must get a Google Maps API key from the
    // Google Cloud Console and replace the placeholder string below.
    const API_KEY = 'AIzaSyCrFLFaQ2vhnjZgY9SXLEx5qVKp97_l4Qs';

    // --- Application State ---
    let compassData = {
        landmarks: []
    };
    // This object now reliably holds the coordinates of the location currently shown on the map.
    let currentMapLocation = { lat: 0, lon: 0 };

    // --- DOM Elements ---
    const DOM = {
        searchInput: document.getElementById('compassSearchInput'),
        searchBtn: document.getElementById('compassSearchBtn'),
        currentLocationBtn: document.getElementById('compassCurrentLocationBtn'),
        addLandmarkBtn: document.getElementById('compassAddLandmarkBtn'),
        mapFrame: document.getElementById('compassMapFrame'),
        landmarkList: document.getElementById('compassLandmarkList'),
        addLandmarkModal: document.getElementById('compassAddLandmarkModal'),
        landmarkNameInput: document.getElementById('landmarkNameInput'),
        landmarkSaveBtn: document.getElementById('landmarkSaveBtn'),
    };

    // --- Data Persistence ---
    function loadCompassData() {
        const stored = localStorage.getItem(COMPASS_STORAGE_KEY);
        if (stored) {
            try {
                const parsedData = JSON.parse(stored);
                compassData.landmarks = parsedData.landmarks || [];
            } catch (e) {
                console.error("Error loading Compass data, resetting.", e);
                compassData = { landmarks: [] };
            }
        }
    }

    function saveCompassData() {
        localStorage.setItem(COMPASS_STORAGE_KEY, JSON.stringify(compassData));
    }

    // --- Core App Logic ---

    /**
     * Updates the map iframe and the currentMapLocation state variable.
     * This is the single source of truth for the map's current location.
     * @param {number} lat - Latitude
     * @param {number} lon - Longitude
     * @param {number} [zoom=14] - Map zoom level
     */
    function updateMap(lat, lon, zoom = 14) {
        currentMapLocation.lat = lat;
        currentMapLocation.lon = lon;
        const embedUrl = `https://maps.google.com/maps?q=${lat},${lon}&hl=en&z=${zoom}&output=embed`;
        DOM.mapFrame.src = embedUrl;
    }

    /**
     * Fetches the user's current GPS location and updates the map.
     */
    function handleGetCurrentLocation() {
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updateMap(position.coords.latitude, position.coords.longitude);
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    alert(`Error getting location: ${error.message}`);
                },
                { enableHighAccuracy: true }
            );
        } else {
            alert("Geolocation is not supported by your browser.");
        }
    }

    /**
     * [MODIFIED] Geocodes the search query to get coordinates and updates the map.
     * This function now correctly updates the application state.
     */
    async function handleSearchLocation() {
        const query = DOM.searchInput.value.trim();
        if (!query) {
            alert("Please enter a location to search.");
            return;
        }

        if (API_KEY === 'YOUR_GOOGLE_MAPS_API_KEY_HERE' || !API_KEY) {
            alert("API Key is missing. Please add your Google Maps API key to the script to enable search functionality.");
            // Fallback to the old, less precise search method if no key is provided.
            DOM.mapFrame.src = `https://maps.google.com/maps?q=${encodeURIComponent(query)}&hl=en&z=14&output=embed`;
            return;
        }

        const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(query)}&key=${API_KEY}`;

        try {
            const response = await fetch(geocodeUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if (data.status === 'OK' && data.results.length > 0) {
                const location = data.results[0].geometry.location;
                // Note: The Geocoding API returns 'lng', which we map to 'lon'.
                updateMap(location.lat, location.lng);
            } else {
                alert(`Could not find location: ${data.status}. ${data.error_message || 'No results found.'}`);
                console.error("Geocoding API Error:", data);
            }
        } catch (error) {
            alert("An error occurred while trying to search for the location.");
            console.error("Fetch/Network Error:", error);
        }
    }

    /**
     * Renders the list of saved landmarks in the sidebar.
     */
    function renderLandmarkList() {
        DOM.landmarkList.innerHTML = '';
        if (compassData.landmarks.length === 0) {
            DOM.landmarkList.innerHTML = '<li style="padding: 10px; text-align: center; color: #555;">No saved landmarks.</li>';
            return;
        }
        compassData.landmarks.forEach((landmark, index) => {
            const li = document.createElement('li');
            li.className = 'compass-landmark-item';
            li.dataset.index = index;
            li.innerHTML = `
                <div class="landmark-item-name">${landmark.name}</div>
                <div class="landmark-item-coords">Lat: ${Number(landmark.lat).toFixed(4)}, Lon: ${Number(landmark.lon).toFixed(4)}</div>
                <div class="landmark-item-actions">
                    <button class="xp-button xp-button-small landmark-delete-btn" data-index="${index}">Delete</button>
                </div>
            `;
            li.addEventListener('click', (e) => {
                if (e.target.classList.contains('landmark-delete-btn')) return;
                updateMap(landmark.lat, landmark.lon);
            });
            DOM.landmarkList.appendChild(li);
        });

        document.querySelectorAll('.landmark-delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const indexToDelete = parseInt(e.target.dataset.index);
                // A simple custom confirmation modal would be better than window.confirm in a real app.
                if (window.confirm(`Are you sure you want to delete "${compassData.landmarks[indexToDelete].name}"?`)) {
                    compassData.landmarks.splice(indexToDelete, 1);
                    saveCompassData();
                    renderLandmarkList();
                }
            });
        });
    }
    
    // --- Modal Handling ---
    function openAddLandmarkModal() {
        DOM.landmarkNameInput.value = '';
        DOM.addLandmarkModal.style.display = 'flex';
        DOM.landmarkNameInput.focus();
    }
    
    function closeAddLandmarkModal() {
        DOM.addLandmarkModal.style.display = 'none';
    }

    /**
     * Saves a new landmark using the coordinates from the `currentMapLocation` state.
     * This function no longer needs changes as the state is now always correct.
     */
    function saveNewLandmark() {
        const name = DOM.landmarkNameInput.value.trim();
        if (!name) {
            alert("Please enter a name for the Landmark.");
            return;
        }
        
        // This now correctly uses the coordinates from either "My Location" or the last search.
        const lat = currentMapLocation.lat;
        const lon = currentMapLocation.lon;

        if (lat === 0 && lon === 0) {
            alert("Cannot save landmark. Location coordinates are not set. Try searching or using 'My Location'.");
            return;
        }

        compassData.landmarks.push({ name, lat, lon });
        saveCompassData();
        renderLandmarkList();
        closeAddLandmarkModal();
    }

    // --- Event Listeners Setup ---
    function addEventListeners() {
        DOM.currentLocationBtn.addEventListener('click', handleGetCurrentLocation);
        DOM.searchBtn.addEventListener('click', handleSearchLocation);
        DOM.searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSearchLocation();
            }
        });
        DOM.addLandmarkBtn.addEventListener('click', openAddLandmarkModal);
        DOM.landmarkSaveBtn.addEventListener('click', saveNewLandmark);

        document.querySelectorAll('.compass-modal-close-button, .compass-modal-cancel-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modalId;
                if (modalId) {
                    document.getElementById(modalId).style.display = 'none';
                }
            });
        });
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        loadCompassData();
        addEventListeners();
        renderLandmarkList();
        handleGetCurrentLocation(); // Get initial location on load
    });

</script>
</body>
</html>
