<style>
    body { margin: 0; padding: 0; font-family: "Tahoma", "Geneva", sans-serif; font-size: 11px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background-color: #ECE9D8; color: #000000; }
    .xp-button { background-color: #ECE9D8; border: 1px outset #7F7F7F; padding: 5px 12px; min-width: 75px; font-size: 11px; text-align: center; cursor: pointer; margin: 2px; }
    .xp-button:active { border-style: inset; }
    .xp-button:hover:not(:disabled) { border-color: #005CFE; background-color: #F0F8FF; }
    .xp-button:disabled { color: #7F7F7F; border-color: #ACA899; cursor: default; opacity: 0.7; }
    .xp-button-small { padding: 2px 5px; font-size: 10px; min-width: auto; margin: 0 2px;}

    .art-domain-app-container { display: flex; flex-direction: column; width: 100%; height: 100%; box-sizing: border-box; }
    .art-domain-controls-bar { display: flex; align-items: center; padding: 8px; background-color: #F0F0F0; border-bottom: 1px solid #ACA899; flex-shrink: 0; gap: 8px; }
    #artDomainSearchInput { flex-grow: 1; border: 1px inset #7F7F7F; padding: 6px; font-family: "Tahoma", "Geneva", sans-serif; font-size: 11px; background-color: #FFFFFF; height: 28px; box-sizing: border-box;}
    #artDomainSearchBtn { height: 28px; padding: 5px 12px; }

    .art-domain-status-area { padding: 8px; text-align: center; font-size: 12px; color: #333; flex-shrink: 0; background-color: #F8F8F8; border-bottom: 1px solid #DDD; min-height: 16px; }
    #artDomainLoadingIndicator { font-weight: bold; }
    #artDomainStatusMessage { }

    .art-domain-results-area { flex-grow: 1; overflow-y: auto; padding: 10px; background-color: #FFFFFF; border-top: 1px solid #ACA899; }
    .art-domain-results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
    .art-domain-artwork-card { background-color: #FDFDFD; border: 1px outset #D4D0C8; border-radius: 3px; padding: 10px; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s; }
    .art-domain-artwork-card:hover { border: 1px solid #005CFE; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .art-domain-artwork-card img.thumbnail { width: 100%; height: 150px; object-fit: cover; border: 1px solid #C8C8C8; border-radius: 2px; margin-bottom: 8px; background-color: #F0F0F0; }
    .art-domain-artwork-card .title { font-weight: bold; font-size: 12px; color: #0039A9; margin-bottom: 4px; height: 2.4em; line-height: 1.2em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .art-domain-artwork-card .artist { font-size: 10px; color: #4A4A4A; margin-bottom: 8px; height: 2.2em; line-height: 1.1em; overflow: hidden; }
    .art-domain-artwork-card .actions button { margin-top: 5px; width: 100%; }

    .art-domain-pagination-controls { display: flex; justify-content: center; align-items: center; padding: 10px; background-color: #F0F0F0; border-top: 1px solid #ACA899; flex-shrink: 0; }
    .art-domain-pagination-controls button { margin: 0 5px; }
    #artDomainPageInfo { margin: 0 10px; font-size: 11px; }

    .art-domain-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .art-domain-modal-content { background-color: #ECE9D8; margin: auto; padding: 0; border: 1px solid #000; width: 90%; max-width: 700px; box-shadow: 5px 5px 15px rgba(0,0,0,0.5); animation: artDomainFadeIn 0.3s; display: flex; flex-direction: column; max-height: 90vh; }
    .art-domain-modal-title-bar { background: linear-gradient(to bottom, #005CFE, #0039A9); color: white; padding: 5px 8px; font-weight: bold; border-bottom: 1px solid #000; display: flex; justify-content: space-between; align-items: center; height: 28px; box-sizing: border-box; flex-shrink: 0; cursor: default; }
    .art-domain-modal-title-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .art-domain-modal-close-button { color: white; font-size: 16px; font-family: "Marlett", "Webdings", sans-serif; font-weight: normal; background: #E04343; border: 1px outset white; width: 22px; height: 18px; text-align: center; line-height: 16px; padding: 0; cursor: pointer; }
    .art-domain-modal-close-button:hover { background: #FF6363; }
    .art-domain-modal-close-button:active { border-style: inset; }
    .art-domain-modal-body { padding: 15px; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; gap: 15px;}
    .art-domain-modal-body .image-container { text-align: center; margin-bottom: 10px; max-height: 40vh; overflow: hidden; display: flex; justify-content: center; align-items: center; background-color: #FFF; border: 1px solid #ACA899; }
    .art-domain-modal-body #artDomainModalImage { max-width: 100%; max-height: 100%; object-fit: contain; }
    .art-domain-modal-body .details-container { font-size: 11px; line-height: 1.5; }
    .art-domain-modal-body .details-container p { margin: 0 0 8px 0; }
    .art-domain-modal-body .details-container strong { color: #0039A9; }
    .art-domain-modal-footer { padding: 10px 15px; text-align: right; background-color: #F0F0F0; border-top: 1px solid #ACA899; flex-shrink: 0; }
    @keyframes artDomainFadeIn { from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);} }
</style>

<div class="art-domain-app-container">
    <div class="art-domain-controls-bar">
        <input type="text" id="artDomainSearchInput" placeholder="Search for public domain art (e.g., Monet, cats, Japan)">
        <button id="artDomainSearchBtn" class="xp-button">Search</button>
    </div>
    <div class="art-domain-status-area">
        <span id="artDomainLoadingIndicator" style="display:none;">Loading...</span>
        <span id="artDomainStatusMessage">Enter a search term to find public domain artworks.</span>
    </div>
    <div class="art-domain-results-area">
        <div id="artDomainResultsGrid" class="art-domain-results-grid">
        </div>
    </div>
    <div class="art-domain-pagination-controls" style="display:none;">
        <button id="artDomainPrevPageBtn" class="xp-button" disabled>&lt; Prev</button>
        <span id="artDomainPageInfo">Page 1 of 1</span>
        <button id="artDomainNextPageBtn" class="xp-button" disabled>Next &gt;</button>
    </div>
</div>

<div id="artDomainDetailModal" class="art-domain-modal">
    <div class="art-domain-modal-content">
        <div class="art-domain-modal-title-bar">
            <span id="artDomainModalTitle" class="art-domain-modal-title-text">Artwork Details</span>
            <span class="art-domain-modal-close-button" data-modal-id="artDomainDetailModal">r</span>
        </div>
        <div class="art-domain-modal-body">
            <div class="image-container">
                <img id="artDomainModalImage" src="#" alt="Artwork Image">
            </div>
            <div class="details-container">
                <p><strong>Title:</strong> <span id="artDomainModalArtworkTitle">N/A</span></p>
                <p><strong>Artist:</strong> <span id="artDomainModalArtist">N/A</span></p>
                <p><strong>Date:</strong> <span id="artDomainModalDate">N/A</span></p>
                <p><strong>Medium:</strong> <span id="artDomainModalMedium">N/A</span></p>
                <p><strong>Dimensions:</strong> <span id="artDomainModalDimensions">N/A</span></p>
                <p><strong>Credit:</strong> <span id="artDomainModalCredit">N/A</span></p>
                <p><strong>Reference #:</strong> <span id="artDomainModalRefNum">N/A</span></p>
            </div>
        </div>
        <div class="art-domain-modal-footer">
            <button id="artDomainModalDownloadBtn" class="xp-button">Download Full Image</button>
            <button class="xp-button art-domain-modal-cancel-btn" data-modal-id="artDomainDetailModal">Close</button>
        </div>
    </div>
</div>

<script>
    const ART_DOMAIN_STORAGE_KEY = 'artDomainState_v1.0';
    const API_BASE_URL = 'https://api.artic.edu/api/v1/artworks/search';
    const RESULTS_PER_PAGE = 12;

    let artDomainState = {
        currentSearchQuery: '',
        currentPage: 1,
        totalPages: 1,
        currentArtworkForModal: null,
        currentArtworks: []
    };

    const DOM_AD = {
        searchInput: document.getElementById('artDomainSearchInput'),
        searchBtn: document.getElementById('artDomainSearchBtn'),
        loadingIndicator: document.getElementById('artDomainLoadingIndicator'),
        statusMessage: document.getElementById('artDomainStatusMessage'),
        resultsGrid: document.getElementById('artDomainResultsGrid'),
        paginationControls: document.querySelector('.art-domain-pagination-controls'),
        prevPageBtn: document.getElementById('artDomainPrevPageBtn'),
        nextPageBtn: document.getElementById('artDomainNextPageBtn'),
        pageInfo: document.getElementById('artDomainPageInfo'),
        detailModal: document.getElementById('artDomainDetailModal'),
        modalTitle: document.getElementById('artDomainModalTitle'),
        modalImage: document.getElementById('artDomainModalImage'),
        modalArtworkTitle: document.getElementById('artDomainModalArtworkTitle'),
        modalArtist: document.getElementById('artDomainModalArtist'),
        modalDate: document.getElementById('artDomainModalDate'),
        modalMedium: document.getElementById('artDomainModalMedium'),
        modalDimensions: document.getElementById('artDomainModalDimensions'),
        modalCredit: document.getElementById('artDomainModalCredit'),
        modalRefNum: document.getElementById('artDomainModalRefNum'),
        modalDownloadBtn: document.getElementById('artDomainModalDownloadBtn'),
    };

    function openArtDomainModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'flex';
    }

    function closeArtDomainModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'none';
        artDomainState.currentArtworkForModal = null;
        DOM_AD.modalImage.src = '#'; // Clear image to prevent showing old one briefly
    }

    function saveLocalState() {
        localStorage.setItem(ART_DOMAIN_STORAGE_KEY, JSON.stringify({
            currentSearchQuery: artDomainState.currentSearchQuery,
            currentPage: artDomainState.currentPage
        }));
    }

    function loadLocalState() {
        const storedState = localStorage.getItem(ART_DOMAIN_STORAGE_KEY);
        if (storedState) {
            try {
                const parsed = JSON.parse(storedState);
                artDomainState.currentSearchQuery = parsed.currentSearchQuery || '';
                artDomainState.currentPage = parsed.currentPage || 1;
                DOM_AD.searchInput.value = artDomainState.currentSearchQuery;
            } catch (e) {
                localStorage.removeItem(ART_DOMAIN_STORAGE_KEY);
            }
        }
    }
    
    function updateLoadingState(isLoading, message = '') {
        DOM_AD.loadingIndicator.style.display = isLoading ? 'inline' : 'none';
        DOM_AD.statusMessage.textContent = message || (isLoading ? '' : 'Enter a search term to find public domain artworks.');
        DOM_AD.searchBtn.disabled = isLoading;
        DOM_AD.searchInput.disabled = isLoading;
    }

    async function fetchArtworks(query, page = 1) {
        if (!query) {
            updateLoadingState(false, "Please enter a search term.");
            DOM_AD.resultsGrid.innerHTML = '';
            DOM_AD.paginationControls.style.display = 'none';
            return;
        }
        updateLoadingState(true, 'Searching for artworks...');
        artDomainState.currentSearchQuery = query;
        artDomainState.currentPage = page;

        const fields = 'id,title,image_id,artist_display,is_public_domain,thumbnail,date_display,medium_display,dimensions,credit_line,main_reference_number';
        const url = `${API_BASE_URL}?q=${encodeURIComponent(query)}&query[term][is_public_domain]=true&fields=${fields}&limit=${RESULTS_PER_PAGE}&page=${page}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                let errorMsg = `API request failed: ${response.status} ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.detail || errorData.title || (errorData.error ? errorData.error.message : null) || errorMsg;
                } catch (e) {
                    // Response was not JSON, or JSON parsing failed. Use the statusText.
                }
                throw new Error(errorMsg);
            }
            const data = await response.json();
            artDomainState.currentArtworks = data.data || [];
            renderResults(artDomainState.currentArtworks);
            renderPagination(data.pagination);
            updateLoadingState(false, data.data.length === 0 ? `No public domain artworks found for "${query}".` : `Showing results for "${query}".`);
            saveLocalState();
        } catch (error) {
            console.error('Error fetching artworks:', error);
            updateLoadingState(false, `Error: ${error.message}`);
            DOM_AD.resultsGrid.innerHTML = '';
            DOM_AD.paginationControls.style.display = 'none';
        }
    }

    function renderResults(artworks) {
        DOM_AD.resultsGrid.innerHTML = '';
        if (!artworks || artworks.length === 0) {
            return;
        }

        artworks.forEach(artwork => {
            const card = document.createElement('div');
            card.className = 'art-domain-artwork-card';
            card.dataset.artworkId = artwork.id;

            const img = document.createElement('img');
            img.className = 'thumbnail';
            
            const placeholderUrl = `https://placehold.co/200x150/ECE9D8/7F7F7F?text=Error`;
            const lqipPlaceholderUrl = `https://placehold.co/200x150/ECE9D8/7F7F7F?text=No+LQIP`;

            if (artwork.image_id) {
                img.src = `https://www.artic.edu/iiif/2/${artwork.image_id}/full/843,/0/default.jpg`;
                img.alt = artwork.title || (artwork.thumbnail && artwork.thumbnail.alt_text ? artwork.thumbnail.alt_text : 'Artwork thumbnail');
                img.onerror = function() {
                    // First fallback: Try LQIP
                    if (artwork.thumbnail && artwork.thumbnail.lqip) {
                        this.src = artwork.thumbnail.lqip;
                        this.alt = artwork.title || 'Low quality preview';
                        // Second fallback if LQIP also fails (e.g., invalid base64)
                        this.onerror = function() { this.src = placeholderUrl; this.alt = 'Image Load Error'; };
                    } else {
                        // No LQIP, go directly to placeholder
                        this.src = placeholderUrl;
                        this.alt = 'Image Load Error';
                    }
                };
            } else if (artwork.thumbnail && artwork.thumbnail.lqip) {
                // No image_id, but LQIP is available
                img.src = artwork.thumbnail.lqip;
                img.alt = artwork.title || 'Low quality preview';
                img.onerror = function() { this.src = placeholderUrl; this.alt = 'Image Load Error'; };
            } else {
                // No image_id and no LQIP
                img.src = `https://placehold.co/200x150/ECE9D8/7F7F7F?text=No+Image`;
                img.alt = 'Placeholder Image';
            }

            const titleDiv = document.createElement('div');
            titleDiv.className = 'title';
            titleDiv.textContent = artwork.title || 'Untitled';
            titleDiv.title = artwork.title || 'Untitled';

            const artistDiv = document.createElement('div');
            artistDiv.className = 'artist';
            artistDiv.textContent = artwork.artist_display ? artwork.artist_display.split('\n')[0] : 'Unknown Artist';
            artistDiv.title = artwork.artist_display || 'Unknown Artist';
            
            card.appendChild(img);
            card.appendChild(titleDiv);
            card.appendChild(artistDiv);
            
            card.addEventListener('click', () => showDetailModal(artwork.id));
            DOM_AD.resultsGrid.appendChild(card);
        });
    }

    function renderPagination(pagination) {
        if (!pagination || pagination.total_pages <= 1) {
            DOM_AD.paginationControls.style.display = 'none';
            return;
        }
        DOM_AD.paginationControls.style.display = 'flex';
        artDomainState.currentPage = pagination.current_page;
        artDomainState.totalPages = pagination.total_pages;

        DOM_AD.pageInfo.textContent = `Page ${artDomainState.currentPage} of ${artDomainState.totalPages}`;
        DOM_AD.prevPageBtn.disabled = artDomainState.currentPage <= 1;
        DOM_AD.nextPageBtn.disabled = artDomainState.currentPage >= artDomainState.totalPages;
    }
    
    function showDetailModal(artworkId) {
        const artwork = artDomainState.currentArtworks.find(art => art.id === artworkId);
        if (!artwork) return;

        artDomainState.currentArtworkForModal = artwork;

        DOM_AD.modalTitle.textContent = artwork.title || 'Artwork Details';
        DOM_AD.modalImage.src = '#'; 
        
        if (artwork.image_id) {
            DOM_AD.modalImage.src = `https://www.artic.edu/iiif/2/${artwork.image_id}/full/843,/0/default.jpg`;
            DOM_AD.modalImage.alt = artwork.title || 'Artwork Image';
            DOM_AD.modalDownloadBtn.disabled = false;
            DOM_AD.modalImage.style.display = 'block';
        } else {
            DOM_AD.modalImage.src = `https://placehold.co/600x400/ECE9D8/7F7F7F?text=No+Preview`;
            DOM_AD.modalImage.alt = 'No Image Available';
            DOM_AD.modalDownloadBtn.disabled = true;
            DOM_AD.modalImage.style.display = 'block';
        }
        DOM_AD.modalImage.onerror = function() {
            this.src = `https://placehold.co/600x400/ECE9D8/7F7F7F?text=Preview+Error`;
            this.alt = 'Image Preview Error';
            DOM_AD.modalDownloadBtn.disabled = true;
        }

        DOM_AD.modalArtworkTitle.textContent = artwork.title || 'N/A';
        DOM_AD.modalArtist.textContent = artwork.artist_display || 'N/A';
        DOM_AD.modalDate.textContent = artwork.date_display || 'N/A';
        DOM_AD.modalMedium.textContent = artwork.medium_display || 'N/A';
        DOM_AD.modalDimensions.textContent = artwork.dimensions || 'N/A';
        DOM_AD.modalCredit.textContent = artwork.credit_line || 'N/A';
        DOM_AD.modalRefNum.textContent = artwork.main_reference_number || 'N/A';
        
        openArtDomainModal('artDomainDetailModal');
    }

    function handleDownloadImage() {
        if (!artDomainState.currentArtworkForModal || !artDomainState.currentArtworkForModal.image_id) {
            alert("No image available for download.");
            return;
        }
        const artwork = artDomainState.currentArtworkForModal;
        const imageUrl = `https://www.artic.edu/iiif/2/${artwork.image_id}/full/843,/0/default.jpg`;
        // const fileName = `${(artwork.title || 'artwork').replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${artwork.id}.jpg`;
        
        window.open(imageUrl, '_blank');
    }

    function addArtDomainEventListeners() {
        DOM_AD.searchBtn.addEventListener('click', () => {
            fetchArtworks(DOM_AD.searchInput.value.trim(), 1);
        });
        DOM_AD.searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                fetchArtworks(DOM_AD.searchInput.value.trim(), 1);
            }
        });
        DOM_AD.prevPageBtn.addEventListener('click', () => {
            if (artDomainState.currentPage > 1) {
                fetchArtworks(artDomainState.currentSearchQuery, artDomainState.currentPage - 1);
            }
        });
        DOM_AD.nextPageBtn.addEventListener('click', () => {
            if (artDomainState.currentPage < artDomainState.totalPages) {
                fetchArtworks(artDomainState.currentSearchQuery, artDomainState.currentPage + 1);
            }
        });
        
        DOM_AD.modalDownloadBtn.addEventListener('click', handleDownloadImage);

        document.querySelectorAll('.art-domain-modal-close-button, .art-domain-modal-cancel-btn').forEach(btn => {
            btn.addEventListener('click', (event) => {
                const modalId = event.target.dataset.modalId;
                if(modalId) closeArtDomainModal(modalId);
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadLocalState();
        addArtDomainEventListeners();
        if (artDomainState.currentSearchQuery) {
             fetchArtworks(artDomainState.currentSearchQuery, artDomainState.currentPage);
        } else {
            updateLoadingState(false);
        }
    });
</script>